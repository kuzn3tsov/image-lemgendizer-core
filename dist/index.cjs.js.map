{"version":3,"file":"index.cjs.js","sources":["../src/LemGendImage.js","../src/tasks/LemGendTask.js","../src/index.js"],"sourcesContent":["/**\r\n * LemGendImage - Core image representation class\r\n * @class\r\n * @description Represents an image throughout the processing pipeline\r\n */\r\nexport class LemGendImage {\r\n    /**\r\n     * Create a new LemGendImage instance\r\n     * @param {File} file - The original image file\r\n     * @param {Object} options - Configuration options\r\n     */\r\n    constructor(file, options = {}) {\r\n        if (!(file instanceof File)) {\r\n            throw new TypeError('LemGendImage requires a File object')\r\n        }\r\n\r\n        this.id = `lemgend_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`\r\n        this.file = file\r\n        this.originalName = file.name\r\n        this.originalSize = file.size\r\n        this.type = file.type\r\n        this.mimeType = file.type\r\n        this.extension = file.name.split('.').pop().toLowerCase()\r\n\r\n        if (this.extension === 'ico' && !this.type.includes('image')) {\r\n            this.type = 'image/x-icon'\r\n            this.mimeType = 'image/x-icon'\r\n        }\r\n\r\n        this.metadata = {\r\n            originalDimensions: null,\r\n            processedDimensions: null,\r\n            operations: [],\r\n            createdAt: new Date().toISOString(),\r\n            lastModified: new Date().toISOString(),\r\n            optimizationHistory: [],\r\n            analysis: null\r\n        }\r\n        this.outputs = new Map()\r\n        this.processed = false\r\n        this.orientation = options.orientation || null\r\n        this.width = options.width || null\r\n        this.height = options.height || null\r\n        this.aspectRatio = null\r\n        this.transparency = null\r\n        this._imageElement = null\r\n        this._svgDocument = null\r\n        this._objectURL = null\r\n        this.optimizationScore = 0\r\n        this.optimizationRecommendations = []\r\n\r\n        if (this.width && this.height) {\r\n            this.aspectRatio = this.width / this.height\r\n            this.orientation = this.width >= this.height ? 'landscape' : 'portrait'\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Load and analyze the image\r\n     * @returns {Promise<LemGendImage>} The loaded image instance\r\n     */\r\n    load = async () => {\r\n        try {\r\n            if (this.type === 'image/svg+xml') {\r\n                await this._loadSVG()\r\n            } else if (this.type === 'image/x-icon' || this.type === 'image/vnd.microsoft.icon') {\r\n                await this._loadFavicon()\r\n            } else {\r\n                await this._loadRaster()\r\n            }\r\n\r\n            if (this.width && this.height) {\r\n                this.aspectRatio = this.width / this.height\r\n                this.orientation = this.width >= this.height ? 'landscape' : 'portrait'\r\n            }\r\n\r\n            this.metadata.originalDimensions = {\r\n                width: this.width,\r\n                height: this.height,\r\n                orientation: this.orientation,\r\n                aspectRatio: this.aspectRatio\r\n            }\r\n\r\n            // Analyze image for optimization\r\n            await this._analyzeForOptimization()\r\n\r\n            if (this.type === 'image/png' || this.type === 'image/webp' || this.type.includes('icon')) {\r\n                await this._checkTransparency()\r\n            }\r\n\r\n            return this\r\n        } catch (error) {\r\n            throw new Error(`Failed to load image: ${error.message}`)\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Analyze image for optimization potential\r\n     * @private\r\n     */\r\n    _analyzeForOptimization = async () => {\r\n        const analysis = {\r\n            fileSize: this.originalSize,\r\n            dimensions: { width: this.width, height: this.height },\r\n            aspectRatio: this.aspectRatio,\r\n            orientation: this.orientation,\r\n            mimeType: this.type,\r\n            extension: this.extension,\r\n            optimizationScore: 0,\r\n            recommendations: []\r\n        }\r\n\r\n        // Calculate optimization score (0-100)\r\n        let score = 0\r\n\r\n        // Size-based scoring\r\n        if (this.originalSize > 5 * 1024 * 1024) {\r\n            score += 40\r\n            analysis.recommendations.push('File is very large - high optimization potential')\r\n        } else if (this.originalSize > 1 * 1024 * 1024) {\r\n            score += 20\r\n        } else if (this.originalSize > 100 * 1024) {\r\n            score += 10\r\n        }\r\n\r\n        // Dimension-based scoring\r\n        const megapixels = (this.width * this.height) / 1000000\r\n        if (megapixels > 16) {\r\n            score += 30\r\n            analysis.recommendations.push('Very high resolution - consider resizing')\r\n        } else if (megapixels > 4) {\r\n            score += 15\r\n        }\r\n\r\n        // Format-based scoring\r\n        const modernFormats = ['webp', 'avif', 'svg']\r\n        if (!modernFormats.includes(this.extension)) {\r\n            score += 20\r\n            analysis.recommendations.push(`Consider converting from ${this.extension} to modern format`)\r\n        }\r\n\r\n        this.optimizationScore = Math.min(100, score)\r\n        this.optimizationRecommendations = analysis.recommendations\r\n        this.metadata.analysis = analysis\r\n        this.metadata.optimizationLevel = score > 50 ? 'high' : score > 25 ? 'medium' : 'low'\r\n\r\n        return analysis\r\n    }\r\n\r\n    /**\r\n     * Load and analyze favicon (ICO) file\r\n     * @private\r\n     */\r\n    _loadFavicon = async () => {\r\n        try {\r\n            this.width = 32\r\n            this.height = 32\r\n            this.aspectRatio = 1\r\n            this.orientation = 'square'\r\n\r\n            this.metadata.favicon = true\r\n            this.metadata.possibleSizes = [16, 32, 48, 64, 128, 256]\r\n\r\n            return this\r\n        } catch (error) {\r\n            throw new Error(`Failed to load favicon: ${error.message}`)\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Load and analyze SVG image\r\n     * @private\r\n     */\r\n    _loadSVG = async () => {\r\n        try {\r\n            const text = await this.file.text()\r\n            const parser = new DOMParser()\r\n            const svgDoc = parser.parseFromString(text, 'image/svg+xml')\r\n            const svgElement = svgDoc.documentElement\r\n\r\n            const parserError = svgDoc.querySelector('parsererror')\r\n            if (parserError) {\r\n                throw new Error('Invalid SVG format')\r\n            }\r\n\r\n            const widthAttr = svgElement.getAttribute('width')\r\n            const heightAttr = svgElement.getAttribute('height')\r\n            const viewBox = svgElement.getAttribute('viewBox')\r\n\r\n            if (widthAttr && heightAttr) {\r\n                this.width = this._parseSVGLength(widthAttr)\r\n                this.height = this._parseSVGLength(heightAttr)\r\n            } else if (viewBox) {\r\n                const [x, y, vbWidth, vbHeight] = viewBox.split(/\\s+|,/).map(parseFloat)\r\n                this.width = vbWidth || 100\r\n                this.height = vbHeight || 100\r\n            } else {\r\n                this.width = 100\r\n                this.height = 100\r\n            }\r\n\r\n            this._svgDocument = svgDoc\r\n            this.metadata.svgContent = text\r\n            this.metadata.svgElement = svgElement\r\n            this.transparency = this._checkSVGTransparency(text)\r\n\r\n        } catch (error) {\r\n            throw new Error(`Failed to load SVG: ${error.message}`)\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Parse SVG length string to pixels\r\n     * @private\r\n     */\r\n    _parseSVGLength = (lengthStr) => {\r\n        const match = lengthStr.match(/^([\\d.]+)(px|pt|pc|mm|cm|in|em|ex|%)?$/)\r\n        if (!match) return 100\r\n\r\n        const value = parseFloat(match[1])\r\n        const unit = match[2] || 'px'\r\n\r\n        const unitMap = {\r\n            'px': 1,\r\n            'pt': 1.33,\r\n            'pc': 16,\r\n            'mm': 3.78,\r\n            'cm': 37.8,\r\n            'in': 96,\r\n            'em': 16,\r\n            'ex': 8,\r\n            '%': value\r\n        }\r\n\r\n        return value * (unitMap[unit] || 1)\r\n    }\r\n\r\n    /**\r\n     * Check if SVG has transparent elements\r\n     * @private\r\n     */\r\n    _checkSVGTransparency = (svgText) => {\r\n        const transparencyIndicators = [\r\n            'fill=\"none\"',\r\n            'fill=\"transparent\"',\r\n            'fill-opacity',\r\n            'opacity=',\r\n            'rgba(',\r\n            'hsla(',\r\n            'fill:#00000000',\r\n            'fill:transparent',\r\n            'stroke-opacity',\r\n            'stop-opacity'\r\n        ]\r\n\r\n        return transparencyIndicators.some(indicator =>\r\n            svgText.includes(indicator)\r\n        )\r\n    }\r\n\r\n    /**\r\n     * Load and analyze raster image\r\n     * @private\r\n     */\r\n    _loadRaster = async () => {\r\n        return new Promise((resolve, reject) => {\r\n            const img = new Image()\r\n\r\n            img.onload = () => {\r\n                this.width = img.naturalWidth || img.width\r\n                this.height = img.naturalHeight || img.height\r\n                this._imageElement = img\r\n                this._objectURL = img.src\r\n                resolve(this)\r\n            }\r\n\r\n            img.onerror = () => {\r\n                reject(new Error('Failed to load raster image'))\r\n            }\r\n\r\n            img.src = URL.createObjectURL(this.file)\r\n        })\r\n    }\r\n\r\n    /**\r\n     * Check raster image for transparency\r\n     * @private\r\n     */\r\n    _checkTransparency = async () => {\r\n        return new Promise((resolve) => {\r\n            const img = new Image()\r\n\r\n            img.onload = () => {\r\n                const canvas = document.createElement('canvas')\r\n                canvas.width = img.width\r\n                canvas.height = img.height\r\n                const ctx = canvas.getContext('2d')\r\n                ctx.drawImage(img, 0, 0)\r\n\r\n                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height)\r\n                const data = imageData.data\r\n\r\n                for (let i = 3; i < data.length; i += 4) {\r\n                    if (data[i] < 255) {\r\n                        this.transparency = true\r\n                        resolve(true)\r\n                        return\r\n                    }\r\n                }\r\n\r\n                this.transparency = false\r\n                resolve(false)\r\n            }\r\n\r\n            img.onerror = () => {\r\n                this.transparency = false\r\n                resolve(false)\r\n            }\r\n\r\n            img.src = URL.createObjectURL(this.file)\r\n        })\r\n    }\r\n\r\n    /**\r\n     * Update image dimensions\r\n     * @param {number} width - New width in pixels\r\n     * @param {number} height - New height in pixels\r\n     */\r\n    updateDimensions = (width, height) => {\r\n        if (typeof width !== 'number' || typeof height !== 'number' || width <= 0 || height <= 0) {\r\n            throw new Error('Dimensions must be positive numbers')\r\n        }\r\n\r\n        this.width = width\r\n        this.height = height\r\n        this.aspectRatio = width / height\r\n        this.orientation = width >= height ? 'landscape' : 'portrait'\r\n\r\n        this.metadata.processedDimensions = { width, height, aspectRatio: this.aspectRatio }\r\n        this.metadata.lastModified = new Date().toISOString()\r\n    }\r\n\r\n    /**\r\n     * Add an operation to metadata\r\n     * @param {string} operation - Operation name\r\n     * @param {Object} details - Operation details\r\n     */\r\n    addOperation = (operation, details) => {\r\n        this.metadata.operations.push({\r\n            operation,\r\n            details,\r\n            timestamp: new Date().toISOString(),\r\n            previousDimensions: this.metadata.processedDimensions || this.metadata.originalDimensions\r\n        })\r\n\r\n        // Track optimization operations separately\r\n        if (operation === 'optimize') {\r\n            this.metadata.optimizationHistory.push({\r\n                ...details,\r\n                timestamp: new Date().toISOString()\r\n            })\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Add processed output\r\n     * @param {string} format - Output format\r\n     * @param {File} file - Processed file\r\n     * @param {Object} template - Template used (if any)\r\n     */\r\n    addOutput = (format, file, template = null) => {\r\n        if (!(file instanceof File)) {\r\n            throw new TypeError('Output must be a File object')\r\n        }\r\n\r\n        this.outputs.set(format, {\r\n            file,\r\n            format,\r\n            template,\r\n            dimensions: { width: this.width, height: this.height },\r\n            size: file.size,\r\n            addedAt: new Date().toISOString()\r\n        })\r\n\r\n        this.processed = true\r\n    }\r\n\r\n    /**\r\n     * Get output by format\r\n     * @param {string} format - Output format\r\n     * @returns {Object|null} Output object or null\r\n     */\r\n    getOutput = (format) => {\r\n        return this.outputs.get(format) || null\r\n    }\r\n\r\n    /**\r\n     * Get all outputs\r\n     * @returns {Array} Array of output objects\r\n     */\r\n    getAllOutputs = () => {\r\n        return Array.from(this.outputs.values())\r\n    }\r\n\r\n    /**\r\n     * Get output as Data URL\r\n     * @param {string} format - Output format\r\n     * @returns {Promise<string>} Data URL\r\n     */\r\n    getOutputAsDataURL = async (format) => {\r\n        const output = this.getOutput(format)\r\n        if (!output) {\r\n            throw new Error(`No output found for format: ${format}`)\r\n        }\r\n\r\n        return new Promise((resolve, reject) => {\r\n            const reader = new FileReader()\r\n            reader.onload = () => resolve(reader.result)\r\n            reader.onerror = reject\r\n            reader.readAsDataURL(output.file)\r\n        })\r\n    }\r\n\r\n    /**\r\n     * Get original image as Data URL\r\n     * @returns {Promise<string>} Data URL\r\n     */\r\n    toDataURL = async () => {\r\n        return new Promise((resolve, reject) => {\r\n            const reader = new FileReader()\r\n            reader.onload = () => resolve(reader.result)\r\n            reader.onerror = reject\r\n            reader.readAsDataURL(this.file)\r\n        })\r\n    }\r\n\r\n    /**\r\n     * Get optimization recommendations based on image analysis\r\n     * @returns {Object} Optimization recommendations\r\n     */\r\n    getOptimizationRecommendations = () => {\r\n        const recommendations = {\r\n            format: this._recommendFormat(),\r\n            quality: this._recommendQuality(),\r\n            resize: this._recommendResize(),\r\n            warnings: this.optimizationRecommendations,\r\n            suggestions: [],\r\n            priority: this._getOptimizationPriority()\r\n        }\r\n\r\n        // Additional suggestions based on image characteristics\r\n        if (this.transparency && this.extension === 'jpg') {\r\n            recommendations.suggestions.push('JPEG format does not support transparency - consider PNG or WebP')\r\n        }\r\n\r\n        if (this.width > 4000 || this.height > 4000) {\r\n            recommendations.suggestions.push('Image dimensions very large - consider resizing for web')\r\n        }\r\n\r\n        if (this.originalSize > 10 * 1024 * 1024) {\r\n            recommendations.suggestions.push('Image is very large (>10MB) - consider aggressive compression')\r\n        }\r\n\r\n        return recommendations\r\n    }\r\n\r\n    /**\r\n     * Recommend best format based on image characteristics\r\n     * @private\r\n     */\r\n    _recommendFormat = () => {\r\n        if (this.type === 'image/svg+xml') return 'svg'\r\n        if (this.type.includes('icon')) return 'ico'\r\n\r\n        if (this.transparency) {\r\n            return 'webp' // WebP supports transparency and has good compression\r\n        }\r\n\r\n        // For photographic images, recommend modern formats\r\n        if (this.width * this.height > 1000000) {\r\n            return 'avif' // AVIF is great for large images\r\n        }\r\n\r\n        return 'webp' // Default to WebP for good balance\r\n    }\r\n\r\n    /**\r\n     * Recommend quality setting\r\n     * @private\r\n     */\r\n    _recommendQuality = () => {\r\n        if (this.type === 'image/svg+xml' || this.type.includes('icon')) {\r\n            return 100 // Vector and icons should be lossless\r\n        }\r\n\r\n        if (this.transparency) {\r\n            return 90 // Higher quality for transparency\r\n        }\r\n\r\n        if (this.width * this.height > 2000000) {\r\n            return 80 // Lower quality for very large images\r\n        }\r\n\r\n        return 85 // Default good quality\r\n    }\r\n\r\n    /**\r\n     * Recommend resize dimensions\r\n     * @private\r\n     */\r\n    _recommendResize = () => {\r\n        const maxWebDimension = 1920\r\n\r\n        if (this.width <= maxWebDimension && this.height <= maxWebDimension) {\r\n            return null // No resize needed\r\n        }\r\n\r\n        let newWidth, newHeight\r\n\r\n        if (this.width >= this.height) {\r\n            newWidth = Math.min(this.width, maxWebDimension)\r\n            newHeight = Math.round((this.height / this.width) * newWidth)\r\n        } else {\r\n            newHeight = Math.min(this.height, maxWebDimension)\r\n            newWidth = Math.round((this.width / this.height) * newHeight)\r\n        }\r\n\r\n        return {\r\n            width: newWidth,\r\n            height: newHeight,\r\n            reason: `Resize to ${newWidth}x${newHeight} for web display`\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Get optimization priority\r\n     * @private\r\n     */\r\n    _getOptimizationPriority = () => {\r\n        const megapixels = (this.width * this.height) / 1000000\r\n        const mbSize = this.originalSize / (1024 * 1024)\r\n\r\n        if (mbSize > 10 || megapixels > 16) {\r\n            return 'high' // Very large images need optimization\r\n        }\r\n\r\n        if (mbSize > 2 || megapixels > 4) {\r\n            return 'medium' // Large images benefit from optimization\r\n        }\r\n\r\n        return 'low' // Small images are already fairly optimized\r\n    }\r\n\r\n    /**\r\n     * Get optimization summary for reporting\r\n     * @returns {Object} Optimization summary\r\n     */\r\n    getOptimizationSummary = () => {\r\n        const recommendations = this.getOptimizationRecommendations()\r\n\r\n        return {\r\n            original: {\r\n                name: this.originalName,\r\n                size: this.originalSize,\r\n                dimensions: `${this.width}x${this.height}`,\r\n                format: this.extension,\r\n                hasTransparency: this.transparency,\r\n                mimeType: this.type\r\n            },\r\n            recommendations,\r\n            estimatedSavings: this._estimateOptimizationSavings(recommendations),\r\n            priority: recommendations.priority,\r\n            optimizationScore: this.optimizationScore,\r\n            optimizationLevel: this.metadata.optimizationLevel || 'unknown'\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Estimate optimization savings\r\n     * @private\r\n     */\r\n    _estimateOptimizationSavings = (recommendations) => {\r\n        // Simple estimation based on format and quality\r\n        let estimatedSize = this.originalSize\r\n\r\n        switch (recommendations.format) {\r\n            case 'webp':\r\n                estimatedSize *= 0.7\r\n                break\r\n            case 'avif':\r\n                estimatedSize *= 0.6\r\n                break\r\n            case 'png':\r\n                estimatedSize *= 0.9\r\n                break\r\n            case 'jpg':\r\n                estimatedSize *= 0.8\r\n                break\r\n            case 'svg':\r\n                estimatedSize *= 0.3\r\n                break\r\n        }\r\n\r\n        // Apply quality adjustment\r\n        estimatedSize *= (recommendations.quality / 100)\r\n\r\n        // Apply resize if recommended\r\n        if (recommendations.resize) {\r\n            const areaReduction = (recommendations.resize.width * recommendations.resize.height) /\r\n                (this.width * this.height)\r\n            estimatedSize *= areaReduction\r\n        }\r\n\r\n        const savings = this.originalSize - estimatedSize\r\n\r\n        return {\r\n            originalSize: this.originalSize,\r\n            estimatedSize: Math.round(estimatedSize),\r\n            savings: Math.round(savings),\r\n            savingsPercent: Math.round((savings / this.originalSize) * 1000) / 10\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Get image info summary\r\n     * @returns {Object} Image information\r\n     */\r\n    getInfo = () => {\r\n        return {\r\n            id: this.id,\r\n            name: this.originalName,\r\n            type: this.type,\r\n            originalSize: this.originalSize,\r\n            width: this.width,\r\n            height: this.height,\r\n            orientation: this.orientation,\r\n            aspectRatio: this.aspectRatio,\r\n            transparency: this.transparency,\r\n            processed: this.processed,\r\n            outputs: this.getAllOutputs().map(output => output.format),\r\n            metadata: { ...this.metadata },\r\n            optimization: {\r\n                score: this.optimizationScore,\r\n                level: this.metadata.optimizationLevel,\r\n                recommendations: this.optimizationRecommendations.length\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Get detailed optimization report\r\n     * @returns {Object} Detailed optimization report\r\n     */\r\n    getOptimizationReport = () => {\r\n        const summary = this.getOptimizationSummary()\r\n        const info = this.getInfo()\r\n\r\n        return {\r\n            ...summary,\r\n            imageInfo: {\r\n                id: info.id,\r\n                name: info.name,\r\n                type: info.type,\r\n                processed: info.processed\r\n            },\r\n            analysis: this.metadata.analysis,\r\n            optimizationHistory: this.metadata.optimizationHistory,\r\n            generatedAt: new Date().toISOString()\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Check if image needs optimization\r\n     * @param {number} threshold - Optimization score threshold (0-100)\r\n     * @returns {boolean} True if optimization needed\r\n     */\r\n    needsOptimization = (threshold = 30) => {\r\n        return this.optimizationScore >= threshold\r\n    }\r\n\r\n    /**\r\n     * Get recommended optimization settings\r\n     * @param {string} useCase - Use case identifier\r\n     * @returns {Object} Recommended settings\r\n     */\r\n    getRecommendedSettings = (useCase = 'web') => {\r\n        const recommendations = this.getOptimizationRecommendations()\r\n\r\n        const presets = {\r\n            'web': {\r\n                quality: recommendations.quality,\r\n                format: recommendations.format,\r\n                maxDisplayWidth: 1920,\r\n                compressionMode: 'adaptive',\r\n                browserSupport: ['modern', 'legacy']\r\n            },\r\n            'social': {\r\n                quality: 90,\r\n                format: 'jpg',\r\n                maxDisplayWidth: 1080,\r\n                compressionMode: 'balanced',\r\n                stripMetadata: false\r\n            },\r\n            'ecommerce': {\r\n                quality: 92,\r\n                format: 'webp',\r\n                maxDisplayWidth: 1200,\r\n                compressionMode: 'balanced',\r\n                preserveTransparency: true\r\n            },\r\n            'print': {\r\n                quality: 100,\r\n                format: 'png',\r\n                maxDisplayWidth: null,\r\n                compressionMode: 'balanced',\r\n                lossless: true\r\n            }\r\n        }\r\n\r\n        return presets[useCase] || presets['web']\r\n    }\r\n\r\n    /**\r\n     * Clean up resources\r\n     */\r\n    destroy = () => {\r\n        if (this._objectURL) {\r\n            URL.revokeObjectURL(this._objectURL)\r\n        }\r\n\r\n        if (this._imageElement?.src && this._imageElement.src.startsWith('blob:')) {\r\n            URL.revokeObjectURL(this._imageElement.src)\r\n        }\r\n\r\n        this._imageElement = null\r\n        this._svgDocument = null\r\n        this._objectURL = null\r\n        this.outputs.clear()\r\n    }\r\n\r\n    /**\r\n     * Clone the image instance (without outputs)\r\n     * @returns {LemGendImage} Cloned instance\r\n     */\r\n    clone = () => {\r\n        const clone = new LemGendImage(this.file, {\r\n            orientation: this.orientation,\r\n            width: this.width,\r\n            height: this.height\r\n        })\r\n\r\n        clone.metadata = JSON.parse(JSON.stringify(this.metadata))\r\n        clone.transparency = this.transparency\r\n        clone.aspectRatio = this.aspectRatio\r\n        clone.optimizationScore = this.optimizationScore\r\n        clone.optimizationRecommendations = [...this.optimizationRecommendations]\r\n\r\n        return clone\r\n    }\r\n\r\n    /**\r\n     * Create thumbnail preview\r\n     * @param {number} maxSize - Maximum thumbnail dimension\r\n     * @returns {Promise<string>} Thumbnail as Data URL\r\n     */\r\n    createThumbnail = async (maxSize = 200) => {\r\n        return new Promise((resolve, reject) => {\r\n            if (this.type === 'image/svg+xml') {\r\n                // For SVG, return as-is\r\n                this.toDataURL().then(resolve).catch(reject)\r\n                return\r\n            }\r\n\r\n            if (this.type === 'image/x-icon' || this.type === 'image/vnd.microsoft.icon') {\r\n                // Use a default favicon icon as thumbnail\r\n                resolve('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iIzM4ODJlZiIvPjxjaXJjbGUgY3g9IjEwMCIgY3k9IjEwMCIgcj0iNjAiIGZpbGw9IiNmZmYiLz48Y2lyY2xlIGN4PSIxMDAiIGN5PSIxMDAiIHI9IjQwIiBmaWxsPSIjMzg4MmVmIi8+PC9zdmc+')\r\n                return\r\n            }\r\n\r\n            const img = new Image()\r\n            const objectUrl = URL.createObjectURL(this.file)\r\n\r\n            img.onload = () => {\r\n                // Calculate thumbnail dimensions\r\n                let width, height\r\n                if (img.width > img.height) {\r\n                    width = maxSize\r\n                    height = Math.round((img.height / img.width) * maxSize)\r\n                } else {\r\n                    height = maxSize\r\n                    width = Math.round((img.width / img.height) * maxSize)\r\n                }\r\n\r\n                // Create canvas for thumbnail\r\n                const canvas = document.createElement('canvas')\r\n                canvas.width = width\r\n                canvas.height = height\r\n                const ctx = canvas.getContext('2d')\r\n\r\n                // Draw image\r\n                ctx.drawImage(img, 0, 0, width, height)\r\n\r\n                // Convert to Data URL\r\n                const thumbnail = canvas.toDataURL('image/jpeg', 0.7)\r\n\r\n                // Clean up\r\n                URL.revokeObjectURL(objectUrl)\r\n                resolve(thumbnail)\r\n            }\r\n\r\n            img.onerror = () => {\r\n                URL.revokeObjectURL(objectUrl)\r\n                reject(new Error('Failed to create thumbnail'))\r\n            }\r\n\r\n            img.src = objectUrl\r\n        })\r\n    }\r\n}","/**\r\n * LemGendTask - Unified processing pipeline with favicon support\r\n * @class\r\n * @description Orchestrates multiple image processing operations in sequence\r\n */\r\n\r\n// Import validation functions\r\nimport { validateOptimizationOptions, ValidationWarnings } from '../utils/validation.js'\r\n\r\nexport class LemGendTask {\r\n    /**\r\n     * Create a new LemGendTask\r\n     * @param {string} name - Task name\r\n     * @param {string} description - Task description\r\n     */\r\n    constructor(name = 'Untitled Task', description = '') {\r\n        this.id = `task_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`\r\n        this.name = name\r\n        this.description = description\r\n        this.steps = []\r\n        this.validationWarnings = []\r\n        this.validationErrors = []\r\n        this.createdAt = new Date().toISOString()\r\n        this.updatedAt = new Date().toISOString()\r\n        this.metadata = {\r\n            version: '2.2.0',\r\n            processorVersions: {\r\n                resize: '1.2.1',\r\n                crop: '2.0.0',\r\n                optimize: '2.0.0', // Updated version\r\n                rename: '1.0.0',\r\n                template: '1.3.0',\r\n                favicon: '2.0.0'\r\n            },\r\n            estimatedDuration: null,\r\n            estimatedOutputs: 0,\r\n            supportsFavicon: true,\r\n            supportsSVG: true,\r\n            supportsAICropping: true,\r\n            maxBatchSize: 50,\r\n            defaultResizeMode: 'longest',\r\n            supportsOptimizationFirst: true,\r\n            optimizationModes: ['adaptive', 'aggressive', 'balanced']\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Add a processing step\r\n     * @param {string} processor - Processor name ('resize', 'crop', 'optimize', 'rename', 'template', 'favicon')\r\n     * @param {Object} options - Processor options\r\n     * @returns {LemGendTask} This task instance for chaining\r\n     */\r\n    addStep = (processor, options) => {\r\n        const validProcessors = ['resize', 'crop', 'optimize', 'rename', 'template', 'favicon']\r\n\r\n        if (!validProcessors.includes(processor)) {\r\n            throw new Error(`Invalid processor: ${processor}. Valid options: ${validProcessors.join(', ')}`)\r\n        }\r\n\r\n        const step = {\r\n            id: `step_${this.steps.length + 1}_${Date.now()}_${Math.random().toString(36).substr(2, 4)}`,\r\n            processor,\r\n            options: this._validateStepOptions(processor, options),\r\n            order: this.steps.length + 1,\r\n            addedAt: new Date().toISOString(),\r\n            enabled: true,\r\n            metadata: {\r\n                requiresFavicon: processor === 'favicon',\r\n                isBatchable: !['favicon', 'template'].includes(processor),\r\n                outputType: this._getStepOutputType(processor, options),\r\n                supportsOptimizationFirst: processor === 'optimize'\r\n            }\r\n        }\r\n\r\n        this.steps.push(step)\r\n        this.updatedAt = new Date().toISOString()\r\n        this._updateMetadata()\r\n\r\n        return this\r\n    }\r\n\r\n    /**\r\n     * Validate step options based on processor type\r\n     * @private\r\n     */\r\n    _validateStepOptions = (processor, options) => {\r\n        const defaults = {\r\n            resize: {\r\n                dimension: 1024,\r\n                mode: 'longest',\r\n                maintainAspectRatio: true,\r\n                upscale: true,\r\n                algorithm: 'lanczos3'\r\n            },\r\n            crop: {\r\n                width: 500,\r\n                height: 500,\r\n                mode: 'smart',\r\n                upscale: false,\r\n                preserveAspectRatio: true,\r\n                confidenceThreshold: 70,\r\n                cropToFit: true,\r\n                objectsToDetect: ['person', 'face', 'car', 'dog', 'cat']\r\n            },\r\n            optimize: {\r\n                quality: 85,\r\n                format: 'auto',\r\n                lossless: false,\r\n                stripMetadata: true,\r\n                preserveTransparency: true,\r\n                maxDisplayWidth: null,\r\n                browserSupport: ['modern', 'legacy'],\r\n                compressionMode: 'adaptive',\r\n                analyzeContent: true,\r\n                icoSizes: [16, 32, 48, 64, 128, 256]\r\n            },\r\n            rename: {\r\n                pattern: '{name}-{dimensions}',\r\n                preserveExtension: true,\r\n                addIndex: true,\r\n                addTimestamp: false,\r\n                customSeparator: '-'\r\n            },\r\n            template: {\r\n                templateId: null,\r\n                applyToAll: true,\r\n                preserveOriginal: false\r\n            },\r\n            favicon: {\r\n                sizes: [16, 32, 48, 64, 128, 180, 192, 256, 512],\r\n                formats: ['png', 'ico'],\r\n                generateManifest: true,\r\n                generateHTML: true,\r\n                includeAppleTouch: true,\r\n                includeAndroid: true,\r\n                roundCorners: true,\r\n                backgroundColor: '#ffffff'\r\n            }\r\n        }\r\n\r\n        const validatedOptions = { ...defaults[processor], ...options }\r\n\r\n        switch (processor) {\r\n            case 'favicon':\r\n                validatedOptions.sizes = [...new Set(validatedOptions.sizes.sort((a, b) => a - b))]\r\n                validatedOptions.sizes = validatedOptions.sizes.filter(size => size >= 16 && size <= 512)\r\n                break\r\n\r\n            case 'optimize':\r\n                if (validatedOptions.format === 'jpg' && options.preserveTransparency) {\r\n                    validatedOptions.format = 'png'\r\n                }\r\n\r\n                // Validate browser support\r\n                const validBrowserSupport = ['modern', 'legacy', 'all']\r\n                validatedOptions.browserSupport = validatedOptions.browserSupport.filter(support =>\r\n                    validBrowserSupport.includes(support)\r\n                )\r\n                if (validatedOptions.browserSupport.length === 0) {\r\n                    validatedOptions.browserSupport = ['modern', 'legacy']\r\n                }\r\n\r\n                // Validate compression mode\r\n                const validCompressionModes = ['adaptive', 'aggressive', 'balanced']\r\n                if (!validCompressionModes.includes(validatedOptions.compressionMode)) {\r\n                    validatedOptions.compressionMode = 'adaptive'\r\n                }\r\n\r\n                // Adjust quality for specific formats\r\n                if (validatedOptions.format === 'avif') {\r\n                    validatedOptions.quality = Math.min(63, validatedOptions.quality)\r\n                }\r\n                break\r\n\r\n            case 'crop':\r\n                if (['smart', 'face', 'object', 'saliency', 'entropy'].includes(validatedOptions.mode)) {\r\n                    validatedOptions.confidenceThreshold = Math.max(0, Math.min(100, validatedOptions.confidenceThreshold || 70))\r\n                    validatedOptions.multipleFaces = validatedOptions.multipleFaces || false\r\n\r\n                    if (!Array.isArray(validatedOptions.objectsToDetect)) {\r\n                        validatedOptions.objectsToDetect = ['person', 'face', 'car', 'dog', 'cat']\r\n                    }\r\n                }\r\n                break\r\n\r\n            case 'rename':\r\n                // Validate pattern has at least one placeholder\r\n                const placeholders = ['{name}', '{index}', '{timestamp}', '{width}', '{height}', '{dimensions}']\r\n                if (!placeholders.some(ph => validatedOptions.pattern.includes(ph))) {\r\n                    validatedOptions.pattern = '{name}-{index}'\r\n                }\r\n                break\r\n        }\r\n\r\n        return validatedOptions\r\n    }\r\n\r\n    /**\r\n     * Get step output type\r\n     * @private\r\n     */\r\n    _getStepOutputType = (processor, options) => {\r\n        switch (processor) {\r\n            case 'optimize':\r\n                return options.format === 'auto' ? 'optimized-auto' : `optimized-${options.format}`\r\n            case 'favicon':\r\n                return 'favicon-set'\r\n            case 'template':\r\n                return 'template-applied'\r\n            default:\r\n                return 'processed'\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Add resize step\r\n     * @param {number} dimension - Target dimension\r\n     * @param {string} mode - 'auto', 'width', 'height', 'longest', or 'fit'\r\n     * @param {Object} additionalOptions - Additional options\r\n     * @returns {LemGendTask} This task instance for chaining\r\n     */\r\n    addResize = (dimension, mode = 'longest', additionalOptions = {}) => {\r\n        return this.addStep('resize', {\r\n            dimension,\r\n            mode,\r\n            ...additionalOptions\r\n        })\r\n    }\r\n\r\n    /**\r\n     * Add crop step\r\n     * @param {number} width - Crop width\r\n     * @param {number} height - Crop height\r\n     * @param {string} mode - Crop mode: 'smart', 'face', 'object', 'saliency', 'entropy', 'center', 'top', 'bottom', 'left', 'right'\r\n     * @param {Object} additionalOptions - Additional options\r\n     * @returns {LemGendTask} This task instance for chaining\r\n     */\r\n    addCrop = (width, height, mode = 'smart', additionalOptions = {}) => {\r\n        return this.addStep('crop', {\r\n            width,\r\n            height,\r\n            mode,\r\n            ...additionalOptions\r\n        })\r\n    }\r\n\r\n    /**\r\n     * Add smart crop step with AI detection\r\n     * @param {number} width - Crop width\r\n     * @param {number} height - Crop height\r\n     * @param {Object} options - Smart crop options\r\n     * @returns {LemGendTask} This task instance for chaining\r\n     */\r\n    addSmartCrop = (width, height, options = {}) => {\r\n        return this.addStep('crop', {\r\n            width,\r\n            height,\r\n            mode: 'smart',\r\n            confidenceThreshold: 70,\r\n            multipleFaces: true,\r\n            cropToFit: true,\r\n            ...options\r\n        })\r\n    }\r\n\r\n    /**\r\n     * Add optimization step with enhanced options\r\n     * @param {number} quality - Quality percentage\r\n     * @param {string} format - Output format ('auto', 'webp', 'jpg', 'png', 'avif', 'original')\r\n     * @param {Object} additionalOptions - Additional options\r\n     * @returns {LemGendTask} This task instance for chaining\r\n     */\r\n    addOptimize = (quality = 85, format = 'auto', additionalOptions = {}) => {\r\n        return this.addStep('optimize', {\r\n            quality,\r\n            format,\r\n            maxDisplayWidth: additionalOptions.maxDisplayWidth || null,\r\n            browserSupport: additionalOptions.browserSupport || ['modern', 'legacy'],\r\n            compressionMode: additionalOptions.compressionMode || 'adaptive',\r\n            analyzeContent: additionalOptions.analyzeContent !== false,\r\n            ...additionalOptions\r\n        })\r\n    }\r\n\r\n    /**\r\n     * Add optimization-first step for web delivery\r\n     * @param {Object} options - Optimization options\r\n     * @returns {LemGendTask} This task instance for chaining\r\n     */\r\n    addWebOptimization = (options = {}) => {\r\n        return this.addStep('optimize', {\r\n            quality: 85,\r\n            format: 'auto',\r\n            maxDisplayWidth: 1920,\r\n            browserSupport: ['modern', 'legacy'],\r\n            compressionMode: 'adaptive',\r\n            stripMetadata: true,\r\n            preserveTransparency: true,\r\n            ...options\r\n        })\r\n    }\r\n\r\n    /**\r\n     * Add rename step\r\n     * @param {string} pattern - Rename pattern (supports {name}, {width}, {height}, {dimensions}, {index}, {timestamp})\r\n     * @param {Object} additionalOptions - Additional options\r\n     * @returns {LemGendTask} This task instance for chaining\r\n     */\r\n    addRename = (pattern, additionalOptions = {}) => {\r\n        return this.addStep('rename', {\r\n            pattern,\r\n            ...additionalOptions\r\n        })\r\n    }\r\n\r\n    /**\r\n     * Add template step\r\n     * @param {string} templateId - Template ID\r\n     * @param {Object} additionalOptions - Additional options\r\n     * @returns {LemGendTask} This task instance for chaining\r\n     */\r\n    addTemplate = (templateId, additionalOptions = {}) => {\r\n        return this.addStep('template', {\r\n            templateId,\r\n            ...additionalOptions\r\n        })\r\n    }\r\n\r\n    /**\r\n     * Add favicon generation step\r\n     * @param {Array<number>} sizes - Array of sizes to generate\r\n     * @param {Array<string>} formats - Formats to generate ('png', 'ico', 'svg')\r\n     * @param {Object} additionalOptions - Additional options\r\n     * @returns {LemGendTask} This task instance for chaining\r\n     */\r\n    addFavicon = (sizes = [16, 32, 48, 64, 128, 180, 192, 256, 512], formats = ['png', 'ico'], additionalOptions = {}) => {\r\n        return this.addStep('favicon', {\r\n            sizes,\r\n            formats,\r\n            ...additionalOptions\r\n        })\r\n    }\r\n\r\n    /**\r\n     * Remove a step by ID or index\r\n     * @param {string|number} identifier - Step ID or index\r\n     * @returns {boolean} True if step was removed\r\n     */\r\n    removeStep = (identifier) => {\r\n        let index\r\n\r\n        if (typeof identifier === 'number') {\r\n            index = identifier\r\n        } else {\r\n            index = this.steps.findIndex(step => step.id === identifier)\r\n        }\r\n\r\n        if (index >= 0 && index < this.steps.length) {\r\n            this.steps.splice(index, 1)\r\n\r\n            this.steps.forEach((step, idx) => {\r\n                step.order = idx + 1\r\n            })\r\n\r\n            this.updatedAt = new Date().toISOString()\r\n            this._updateMetadata()\r\n            return true\r\n        }\r\n\r\n        return false\r\n    }\r\n\r\n    /**\r\n     * Move step up in order\r\n     * @param {number} index - Step index\r\n     * @returns {boolean} True if step was moved\r\n     */\r\n    moveStepUp = (index) => {\r\n        if (index <= 0 || index >= this.steps.length) {\r\n            return false\r\n        }\r\n\r\n        [this.steps[index - 1], this.steps[index]] = [this.steps[index], this.steps[index - 1]]\r\n\r\n        this.steps.forEach((step, idx) => {\r\n            step.order = idx + 1\r\n        })\r\n\r\n        this.updatedAt = new Date().toISOString()\r\n        return true\r\n    }\r\n\r\n    /**\r\n     * Move step down in order\r\n     * @param {number} index - Step index\r\n     * @returns {boolean} True if step was moved\r\n     */\r\n    moveStepDown = (index) => {\r\n        if (index < 0 || index >= this.steps.length - 1) {\r\n            return false\r\n        }\r\n\r\n        [this.steps[index], this.steps[index + 1]] = [this.steps[index + 1], this.steps[index]]\r\n\r\n        this.steps.forEach((step, idx) => {\r\n            step.order = idx + 1\r\n        })\r\n\r\n        this.updatedAt = new Date().toISOString()\r\n        return true\r\n    }\r\n\r\n    /**\r\n     * Enable/disable a step\r\n     * @param {number} index - Step index\r\n     * @param {boolean} enabled - Enable state\r\n     * @returns {boolean} True if step was updated\r\n     */\r\n    setStepEnabled = (index, enabled = true) => {\r\n        if (index >= 0 && index < this.steps.length) {\r\n            this.steps[index].enabled = enabled\r\n            this.updatedAt = new Date().toISOString()\r\n            this._updateMetadata()\r\n            return true\r\n        }\r\n        return false\r\n    }\r\n\r\n    /**\r\n     * Get enabled steps only\r\n     * @returns {Array} Enabled steps\r\n     */\r\n    getEnabledSteps = () => {\r\n        return this.steps.filter(step => step.enabled)\r\n    }\r\n\r\n    /**\r\n     * Get steps by processor type\r\n     * @param {string} processor - Processor type\r\n     * @returns {Array} Matching steps\r\n     */\r\n    getStepsByProcessor = (processor) => {\r\n        return this.steps.filter(step => step.processor === processor)\r\n    }\r\n\r\n    /**\r\n     * Check if task has specific processor\r\n     * @param {string} processor - Processor type\r\n     * @returns {boolean} True if processor exists\r\n     */\r\n    hasProcessor = (processor) => {\r\n        return this.getEnabledSteps().some(step => step.processor === processor)\r\n    }\r\n\r\n    /**\r\n     * Check if task has optimization step\r\n     * @returns {boolean} True if has optimization\r\n     */\r\n    hasOptimization = () => {\r\n        return this.hasProcessor('optimize')\r\n    }\r\n\r\n    /**\r\n     * Get optimization step if exists\r\n     * @returns {Object|null} Optimization step\r\n     */\r\n    getOptimizationStep = () => {\r\n        return this.getEnabledSteps().find(step => step.processor === 'optimize') || null\r\n    }\r\n\r\n    /**\r\n     * Validate task against an image\r\n     * @param {LemGendImage} lemGendImage - Image to validate against\r\n     * @returns {Promise<Object>} Validation result\r\n     */\r\n    validate = async (lemGendImage) => {\r\n        this.validationWarnings = []\r\n        this.validationErrors = []\r\n\r\n        if (!lemGendImage) {\r\n            const enabledSteps = this.getEnabledSteps()\r\n\r\n            if (enabledSteps.length === 0) {\r\n                this.validationWarnings.push({\r\n                    type: 'empty_task',\r\n                    message: 'Task has no enabled processing steps',\r\n                    severity: 'warning'\r\n                })\r\n            }\r\n\r\n            for (const step of enabledSteps) {\r\n                await this._validateStep(step, null)\r\n            }\r\n\r\n            this._validateTaskLogic()\r\n\r\n            return {\r\n                isValid: this.validationErrors.length === 0,\r\n                hasWarnings: this.validationWarnings.length > 0,\r\n                errors: [...this.validationErrors],\r\n                warnings: [...this.validationWarnings],\r\n                summary: this.getValidationSummary()\r\n            }\r\n        }\r\n\r\n        if (!lemGendImage.file || !(lemGendImage.file instanceof File)) {\r\n            this.validationErrors.push({\r\n                type: 'invalid_image',\r\n                message: 'Image missing valid file property',\r\n                severity: 'error'\r\n            })\r\n        }\r\n\r\n        const enabledSteps = this.getEnabledSteps()\r\n\r\n        if (enabledSteps.length === 0) {\r\n            this.validationWarnings.push({\r\n                type: 'empty_task',\r\n                message: 'Task has no enabled processing steps',\r\n                severity: 'warning'\r\n            })\r\n        }\r\n\r\n        for (const step of enabledSteps) {\r\n            await this._validateStep(step, lemGendImage)\r\n        }\r\n\r\n        this._validateTaskLogic()\r\n\r\n        if (lemGendImage.file && lemGendImage.file instanceof File) {\r\n            this._validateImageCompatibility(lemGendImage)\r\n        }\r\n\r\n        return {\r\n            isValid: this.validationErrors.length === 0,\r\n            hasWarnings: this.validationWarnings.length > 0,\r\n            errors: [...this.validationErrors],\r\n            warnings: [...this.validationWarnings],\r\n            summary: this.getValidationSummary()\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Validate individual step\r\n     * @private\r\n     */\r\n    _validateStep = async (step, image) => {\r\n        if (!image) {\r\n            switch (step.processor) {\r\n                case 'optimize':\r\n                    this._validateOptimizeStep(step, null)\r\n                    break\r\n                case 'rename':\r\n                    this._validateRenameStep(step)\r\n                    break\r\n                case 'template':\r\n                    this._validateTemplateStep(step)\r\n                    break\r\n                case 'favicon':\r\n                    this._validateFaviconStep(step, null)\r\n                    break\r\n                case 'resize':\r\n                case 'crop':\r\n                    this._validateBasicStepOptions(step)\r\n                    break\r\n            }\r\n            return\r\n        }\r\n\r\n        switch (step.processor) {\r\n            case 'resize':\r\n                this._validateResizeStep(step, image)\r\n                break\r\n            case 'crop':\r\n                this._validateCropStep(step, image)\r\n                break\r\n            case 'optimize':\r\n                this._validateOptimizeStep(step, image)\r\n                break\r\n            case 'rename':\r\n                this._validateRenameStep(step)\r\n                break\r\n            case 'template':\r\n                this._validateTemplateStep(step)\r\n                break\r\n            case 'favicon':\r\n                this._validateFaviconStep(step, image)\r\n                break\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Validate basic step options (without image)\r\n     * @private\r\n     */\r\n    _validateBasicStepOptions = (step) => {\r\n        switch (step.processor) {\r\n            case 'resize':\r\n                const { dimension } = step.options\r\n                if (dimension <= 0) {\r\n                    this.validationErrors.push({\r\n                        type: 'invalid_resize',\r\n                        step: step.order,\r\n                        message: `Resize dimension must be positive: ${dimension}`,\r\n                        severity: 'error'\r\n                    })\r\n                }\r\n                break\r\n\r\n            case 'crop':\r\n                const { width, height } = step.options\r\n                if (width <= 0 || height <= 0) {\r\n                    this.validationErrors.push({\r\n                        type: 'invalid_crop',\r\n                        step: step.order,\r\n                        message: `Crop dimensions must be positive: ${width}x${height}`,\r\n                        severity: 'error'\r\n                    })\r\n                }\r\n                break\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Validate favicon step\r\n     * @private\r\n     */\r\n    _validateFaviconStep = (step, image) => {\r\n        const { sizes, formats } = step.options\r\n\r\n        if (!Array.isArray(sizes) || sizes.length === 0) {\r\n            this.validationErrors.push({\r\n                type: 'invalid_favicon_sizes',\r\n                step: step.order,\r\n                message: 'Favicon sizes must be a non-empty array',\r\n                severity: 'error'\r\n            })\r\n        }\r\n\r\n        sizes.forEach(size => {\r\n            if (size < 16) {\r\n                this.validationWarnings.push({\r\n                    type: 'small_favicon_size',\r\n                    step: step.order,\r\n                    message: `Favicon size ${size}px is below recommended minimum (16px)`,\r\n                    severity: 'warning'\r\n                })\r\n            }\r\n\r\n            if (size > 1024) {\r\n                this.validationWarnings.push({\r\n                    type: 'large_favicon_size',\r\n                    step: step.order,\r\n                    message: `Favicon size ${size}px is unusually large`,\r\n                    severity: 'info'\r\n                })\r\n            }\r\n        })\r\n\r\n        if (image) {\r\n            const minSize = Math.min(...sizes)\r\n            if (image.width < minSize || image.height < minSize) {\r\n                this.validationWarnings.push({\r\n                    type: 'small_source_favicon',\r\n                    step: step.order,\r\n                    message: `Source image (${image.width}x${image.height}) smaller than smallest favicon size (${minSize}px)`,\r\n                    severity: 'warning',\r\n                    suggestion: 'Consider using a larger source image or enable upscaling'\r\n                })\r\n            }\r\n\r\n            if (Math.abs(image.width / image.height - 1) > 0.1) {\r\n                this.validationWarnings.push({\r\n                    type: 'non_square_favicon',\r\n                    step: step.order,\r\n                    message: 'Source image is not square; favicons may be distorted',\r\n                    severity: 'warning',\r\n                    suggestion: 'Consider adding a crop step before favicon generation'\r\n                })\r\n            }\r\n        }\r\n\r\n        const validFormats = ['png', 'ico', 'svg']\r\n        formats.forEach(format => {\r\n            if (!validFormats.includes(format)) {\r\n                this.validationWarnings.push({\r\n                    type: 'unsupported_favicon_format',\r\n                    step: step.order,\r\n                    message: `Unsupported favicon format: ${format}`,\r\n                    severity: 'warning',\r\n                    suggestion: `Use one of: ${validFormats.join(', ')}`\r\n                })\r\n            }\r\n        })\r\n    }\r\n\r\n    /**\r\n     * Validate resize step\r\n     * @private\r\n     */\r\n    _validateResizeStep = (step, image) => {\r\n        if (!image) return\r\n\r\n        const { dimension, mode, upscale } = step.options\r\n\r\n        if (dimension <= 0) {\r\n            this.validationErrors.push({\r\n                type: 'invalid_resize',\r\n                step: step.order,\r\n                message: `Resize dimension must be positive: ${dimension}`,\r\n                severity: 'error'\r\n            })\r\n        }\r\n\r\n        if (dimension < 10) {\r\n            this.validationWarnings.push({\r\n                type: 'very_small_resize',\r\n                step: step.order,\r\n                message: `Resize dimension very small (${dimension}px)`,\r\n                severity: 'warning',\r\n                suggestion: 'Consider larger dimensions for usable output'\r\n            })\r\n        }\r\n\r\n        if (dimension > 10000) {\r\n            this.validationWarnings.push({\r\n                type: 'very_large_resize',\r\n                step: step.order,\r\n                message: `Resize dimension very large (${dimension}px)`,\r\n                severity: 'warning',\r\n                suggestion: 'Large dimensions may cause performance issues'\r\n            })\r\n        }\r\n\r\n        if (dimension > Math.max(image.width, image.height) && !upscale) {\r\n            this.validationWarnings.push({\r\n                type: 'upscale_needed',\r\n                step: step.order,\r\n                message: `Target size (${dimension}px) larger than source, upscaling disabled`,\r\n                severity: 'warning',\r\n                suggestion: 'Enable upscaling or use smaller target dimension'\r\n            })\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Validate crop step\r\n     * @private\r\n     */\r\n    _validateCropStep = (step, image) => {\r\n        if (!image) return\r\n\r\n        const { width, height, mode, upscale, confidenceThreshold } = step.options\r\n\r\n        if (width <= 0 || height <= 0) {\r\n            this.validationErrors.push({\r\n                type: 'invalid_crop',\r\n                step: step.order,\r\n                message: `Crop dimensions must be positive: ${width}x${height}`,\r\n                severity: 'error'\r\n            })\r\n        }\r\n\r\n        if (['smart', 'face', 'object'].includes(mode)) {\r\n            this.validationWarnings.push({\r\n                type: 'ai_crop_mode',\r\n                step: step.order,\r\n                message: `Using AI-powered ${mode} cropping`,\r\n                severity: 'info',\r\n                suggestion: 'Ensure images have clear subjects for best results'\r\n            })\r\n\r\n            if (confidenceThreshold < 50) {\r\n                this.validationWarnings.push({\r\n                    type: 'low_confidence_threshold',\r\n                    step: step.order,\r\n                    message: `Low confidence threshold (${confidenceThreshold}%) may result in poor detection`,\r\n                    severity: 'warning',\r\n                    suggestion: 'Increase confidence threshold to 70% or higher for better accuracy'\r\n                })\r\n            }\r\n        }\r\n\r\n        if (width < 10 || height < 10) {\r\n            this.validationWarnings.push({\r\n                type: 'very_small_crop',\r\n                step: step.order,\r\n                message: `Crop dimensions very small (${width}x${height})`,\r\n                severity: 'warning',\r\n                suggestion: 'Consider larger crop area for usable output'\r\n            })\r\n        }\r\n\r\n        const aspect = width / height\r\n        if (aspect > 10 || aspect < 0.1) {\r\n            this.validationWarnings.push({\r\n                type: 'extreme_aspect',\r\n                step: step.order,\r\n                message: `Extreme aspect ratio: ${aspect.toFixed(2)}`,\r\n                severity: 'warning',\r\n                suggestion: 'Consider more balanced dimensions'\r\n            })\r\n        }\r\n\r\n        if ((width > image.width || height > image.height) && !upscale) {\r\n            this.validationWarnings.push({\r\n                type: 'crop_larger_than_source',\r\n                step: step.order,\r\n                message: `Crop area (${width}x${height}) larger than source (${image.width}x${image.height})`,\r\n                severity: 'warning',\r\n                suggestion: 'Enable upscaling or resize first'\r\n            })\r\n        }\r\n    }\r\n\r\n    /**\r\n    * Validate optimize step with enhanced validation\r\n    * @private\r\n    */\r\n    _validateOptimizeStep = (step, image) => {\r\n        // Use the imported validation function\r\n        const optimizationValidation = validateOptimizationOptions(step.options)\r\n\r\n        // Add validation errors\r\n        optimizationValidation.errors.forEach(error => {\r\n            this.validationErrors.push({\r\n                type: error.code,\r\n                step: step.order,\r\n                message: error.message,\r\n                severity: 'error',\r\n                suggestion: error.suggestion\r\n            })\r\n        })\r\n\r\n        // Add validation warnings\r\n        optimizationValidation.warnings.forEach(warning => {\r\n            this.validationWarnings.push({\r\n                type: warning.code,\r\n                step: step.order,\r\n                message: warning.message,\r\n                severity: 'warning',\r\n                suggestion: warning.suggestion\r\n            })\r\n        })\r\n\r\n        if (image) {\r\n            if ((step.options.format === 'jpg' || step.options.format === 'jpeg') && (image.transparency || step.options.preserveTransparency)) {\r\n                this.validationWarnings.push({\r\n                    type: ValidationWarnings.TRANSPARENCY_LOSS,\r\n                    step: step.order,\r\n                    message: 'JPEG format will remove transparency',\r\n                    severity: 'warning',\r\n                    suggestion: 'Use PNG or WebP to preserve transparency'\r\n                })\r\n            }\r\n\r\n            if (step.options.maxDisplayWidth && (image.width > step.options.maxDisplayWidth || image.height > step.options.maxDisplayWidth)) {\r\n                this.validationWarnings.push({\r\n                    type: 'resize_optimization',\r\n                    step: step.order,\r\n                    message: `Image will be resized to ${step.options.maxDisplayWidth}px maximum dimension`,\r\n                    severity: 'info'\r\n                })\r\n            }\r\n\r\n            if (step.options.format === 'avif') {\r\n                this.validationWarnings.push({\r\n                    type: ValidationWarnings.AVIF_BROWSER_SUPPORT,\r\n                    step: step.order,\r\n                    message: 'AVIF format provides excellent compression but limited browser support',\r\n                    severity: 'info',\r\n                    suggestion: 'Consider providing WebP fallback'\r\n                })\r\n            }\r\n\r\n            if (step.options.compressionMode === 'aggressive' && image.width * image.height > 4000000) {\r\n                this.validationWarnings.push({\r\n                    type: 'aggressive_compression_large',\r\n                    step: step.order,\r\n                    message: 'Aggressive compression on large images may take longer',\r\n                    severity: 'info'\r\n                })\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Validate rename step\r\n     * @private\r\n     */\r\n    _validateRenameStep = (step) => {\r\n        const { pattern, preserveExtension } = step.options\r\n\r\n        if (!pattern || pattern.trim() === '') {\r\n            this.validationErrors.push({\r\n                type: 'empty_pattern',\r\n                step: step.order,\r\n                message: 'Rename pattern cannot be empty',\r\n                severity: 'error'\r\n            })\r\n        }\r\n\r\n        const invalidChars = /[<>:\"/\\\\|?*\\x00-\\x1F]/\r\n        if (invalidChars.test(pattern)) {\r\n            this.validationErrors.push({\r\n                type: 'invalid_pattern_chars',\r\n                step: step.order,\r\n                message: 'Pattern contains invalid filename characters',\r\n                severity: 'error',\r\n                suggestion: 'Remove <>:\"/\\\\|?* and control characters from pattern'\r\n            })\r\n        }\r\n\r\n        if (!pattern.includes('{name}') && !pattern.includes('{index}')) {\r\n            this.validationWarnings.push({\r\n                type: 'no_unique_placeholder',\r\n                step: step.order,\r\n                message: 'Pattern may create duplicate filenames',\r\n                severity: 'warning',\r\n                suggestion: 'Include {index} or {timestamp} for unique filenames'\r\n            })\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Validate template step\r\n     * @private\r\n     */\r\n    _validateTemplateStep = (step) => {\r\n        const { templateId } = step.options\r\n\r\n        if (!templateId) {\r\n            this.validationErrors.push({\r\n                type: 'missing_template',\r\n                step: step.order,\r\n                message: 'Template ID is required',\r\n                severity: 'error'\r\n            })\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Validate image compatibility\r\n     * @private\r\n     */\r\n    _validateImageCompatibility = (image) => {\r\n        const enabledSteps = this.getEnabledSteps()\r\n        const hasFaviconStep = enabledSteps.some(s => s.processor === 'favicon')\r\n        const hasSmartCrop = enabledSteps.some(s => s.processor === 'crop' &&\r\n            ['smart', 'face', 'object'].includes(s.options.mode))\r\n        const hasOptimization = enabledSteps.some(s => s.processor === 'optimize')\r\n\r\n        if (hasFaviconStep) {\r\n            if (image.type === 'image/svg+xml') {\r\n                this.validationWarnings.push({\r\n                    type: 'svg_favicon',\r\n                    message: 'SVG images may not convert well to favicon formats',\r\n                    severity: 'warning',\r\n                    suggestion: 'Consider using raster image for favicon generation'\r\n                })\r\n            }\r\n\r\n            if (image.type.includes('gif')) {\r\n                this.validationWarnings.push({\r\n                    type: 'animated_favicon',\r\n                    message: 'Animated GIFs will lose animation in favicon conversion',\r\n                    severity: 'info'\r\n                })\r\n            }\r\n        }\r\n\r\n        if (hasSmartCrop) {\r\n            if (image.width < 200 || image.height < 200) {\r\n                this.validationWarnings.push({\r\n                    type: 'small_image_smart_crop',\r\n                    message: 'Smart crop works best with images larger than 200x200 pixels',\r\n                    severity: 'warning',\r\n                    suggestion: 'Consider resizing before smart crop or use larger source images'\r\n                })\r\n            }\r\n        }\r\n\r\n        if (hasOptimization) {\r\n            const optimizationStep = enabledSteps.find(s => s.processor === 'optimize')\r\n            if (optimizationStep && optimizationStep.options.format === 'auto') {\r\n                this.validationWarnings.push({\r\n                    type: 'auto_format_selection',\r\n                    message: 'Format will be automatically selected based on image content and browser support',\r\n                    severity: 'info'\r\n                })\r\n            }\r\n        }\r\n\r\n        const minDimension = Math.min(image.width, image.height)\r\n        if (minDimension < 100) {\r\n            this.validationWarnings.push({\r\n                type: 'low_resolution',\r\n                message: `Source image resolution low (${image.width}x${image.height})`,\r\n                severity: 'warning',\r\n                suggestion: 'Consider using higher resolution source for better quality'\r\n            })\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Validate task logic\r\n     * @private\r\n     */\r\n    _validateTaskLogic = () => {\r\n        const enabledSteps = this.getEnabledSteps()\r\n\r\n        const hasResize = enabledSteps.some(s => s.processor === 'resize')\r\n        const hasCrop = enabledSteps.some(s => s.processor === 'crop')\r\n        const hasOptimize = enabledSteps.some(s => s.processor === 'optimize')\r\n\r\n        if (hasCrop && !hasResize) {\r\n            this.validationWarnings.push({\r\n                type: 'crop_without_resize',\r\n                message: 'Crop without resize may result in unexpected output',\r\n                severity: 'info',\r\n                suggestion: 'Consider adding resize step before crop for better control'\r\n            })\r\n        }\r\n\r\n        const optimizeSteps = enabledSteps.filter(s => s.processor === 'optimize')\r\n        if (optimizeSteps.length > 1) {\r\n            this.validationWarnings.push({\r\n                type: 'multiple_optimize',\r\n                message: `Multiple optimization steps (${optimizeSteps.length})`,\r\n                severity: 'warning',\r\n                suggestion: 'Multiple optimizations may degrade quality unnecessarily'\r\n            })\r\n        }\r\n\r\n        const renameIndex = enabledSteps.findIndex(s => s.processor === 'rename')\r\n        if (renameIndex >= 0 && renameIndex < enabledSteps.length - 2) {\r\n            this.validationWarnings.push({\r\n                type: 'early_rename',\r\n                message: 'Rename step placed before other operations',\r\n                severity: 'info',\r\n                suggestion: 'Consider moving rename to end to reflect final output'\r\n            })\r\n        }\r\n\r\n        const faviconIndex = enabledSteps.findIndex(s => s.processor === 'favicon')\r\n        if (faviconIndex >= 0) {\r\n            const stepsBefore = enabledSteps.slice(0, faviconIndex)\r\n            const hasResizeBefore = stepsBefore.some(s => s.processor === 'resize')\r\n            const hasCropBefore = stepsBefore.some(s => s.processor === 'crop')\r\n\r\n            if (!hasResizeBefore && !hasCropBefore) {\r\n                this.validationWarnings.push({\r\n                    type: 'favicon_without_preparation',\r\n                    message: 'Favicon generation without prior resize/crop',\r\n                    severity: 'warning',\r\n                    suggestion: 'Add resize/crop step before favicon for optimal results'\r\n                })\r\n            }\r\n        }\r\n\r\n        const faviconSteps = enabledSteps.filter(s => s.processor === 'favicon')\r\n        faviconSteps.forEach(faviconStep => {\r\n            const optimizeAfter = enabledSteps\r\n                .filter(s => s.processor === 'optimize')\r\n                .some(optimizeStep => optimizeStep.order > faviconStep.order)\r\n\r\n            if (optimizeAfter) {\r\n                this.validationWarnings.push({\r\n                    type: 'optimize_after_favicon',\r\n                    message: 'Optimization after favicon generation may affect favicon quality',\r\n                    severity: 'warning',\r\n                    suggestion: 'Move optimization step before favicon generation'\r\n                })\r\n            }\r\n        })\r\n\r\n        // Validate optimization-first approach\r\n        if (hasOptimize && !hasResize && !hasCrop) {\r\n            this.validationWarnings.push({\r\n                type: 'optimization_only',\r\n                message: 'Task contains only optimization step',\r\n                severity: 'info',\r\n                suggestion: 'Consider adding resize/crop steps for complete image processing'\r\n            })\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Get validation summary\r\n     * @returns {Object} Validation summary\r\n     */\r\n    getValidationSummary = () => {\r\n        const enabledSteps = this.getEnabledSteps()\r\n        const errorCount = this.validationErrors.length\r\n        const warningCount = this.validationWarnings.length\r\n\r\n        const processorCount = {}\r\n        enabledSteps.forEach(step => {\r\n            processorCount[step.processor] = (processorCount[step.processor] || 0) + 1\r\n        })\r\n\r\n        let taskType = 'general'\r\n        if (enabledSteps.some(s => s.processor === 'favicon')) {\r\n            taskType = 'favicon'\r\n        } else if (enabledSteps.some(s => s.processor === 'template')) {\r\n            taskType = 'template'\r\n        } else if (enabledSteps.every(s => ['resize', 'crop', 'optimize'].includes(s.processor))) {\r\n            taskType = 'basic'\r\n        } else if (enabledSteps.length === 1 && enabledSteps[0].processor === 'optimize') {\r\n            taskType = 'optimization-only'\r\n        }\r\n\r\n        const hasSmartCrop = enabledSteps.some(s => s.processor === 'crop' &&\r\n            ['smart', 'face', 'object'].includes(s.options.mode))\r\n        const hasAutoOptimization = enabledSteps.some(s =>\r\n            s.processor === 'optimize' && s.options.format === 'auto'\r\n        )\r\n\r\n        return {\r\n            totalSteps: enabledSteps.length,\r\n            enabledSteps: enabledSteps.length,\r\n            disabledSteps: this.steps.length - enabledSteps.length,\r\n            errorCount,\r\n            warningCount,\r\n            processorCount,\r\n            taskType,\r\n            status: errorCount > 0 ? 'invalid' : warningCount > 0 ? 'has_warnings' : 'valid',\r\n            canProceed: errorCount === 0,\r\n            requiresImage: enabledSteps.some(s => ['resize', 'crop', 'optimize', 'favicon'].includes(s.processor)),\r\n            hasFavicon: processorCount.favicon > 0,\r\n            hasSmartCrop,\r\n            hasAutoOptimization,\r\n            estimatedOutputs: this._estimateOutputCount(),\r\n            optimizationLevel: this._getOptimizationLevel()\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Get optimization level based on settings\r\n     * @private\r\n     */\r\n    _getOptimizationLevel = () => {\r\n        const optimizeStep = this.getEnabledSteps().find(s => s.processor === 'optimize')\r\n        if (!optimizeStep) return 'none'\r\n\r\n        const { compressionMode, quality, format } = optimizeStep.options\r\n\r\n        if (compressionMode === 'aggressive' && quality < 70) {\r\n            return 'aggressive'\r\n        } else if (compressionMode === 'adaptive' || (quality >= 70 && quality <= 90)) {\r\n            return 'balanced'\r\n        } else if (compressionMode === 'balanced' && quality > 90) {\r\n            return 'high-quality'\r\n        }\r\n\r\n        return 'standard'\r\n    }\r\n\r\n    /**\r\n     * Estimate number of outputs\r\n     * @private\r\n     */\r\n    _estimateOutputCount = () => {\r\n        const enabledSteps = this.getEnabledSteps()\r\n        let count = 1\r\n\r\n        enabledSteps.forEach(step => {\r\n            if (step.processor === 'favicon') {\r\n                const { sizes = [], formats = [] } = step.options\r\n                count += sizes.length * formats.length\r\n\r\n                if (step.options.generateManifest) count++\r\n                if (step.options.generateHTML) count++\r\n                if (step.options.includeAppleTouch) count++\r\n                if (step.options.includeAndroid) count++\r\n            } else if (step.processor === 'optimize') {\r\n                const { format } = step.options\r\n                if (Array.isArray(format)) {\r\n                    count += format.length - 1\r\n                }\r\n            }\r\n        })\r\n\r\n        return count\r\n    }\r\n\r\n    /**\r\n     * Get task description\r\n     * @returns {string} Human-readable description\r\n     */\r\n    getDescription = () => {\r\n        const enabledSteps = this.getEnabledSteps()\r\n\r\n        if (enabledSteps.length === 0) {\r\n            return 'No processing steps configured'\r\n        }\r\n\r\n        return enabledSteps.map((step, index) => {\r\n            const stepNum = index + 1\r\n            const processor = step.processor.charAt(0).toUpperCase() + step.processor.slice(1)\r\n\r\n            switch (step.processor) {\r\n                case 'resize':\r\n                    return `${stepNum}. LemGendaryResize to ${step.options.dimension}px (${step.options.mode})`\r\n                case 'crop':\r\n                    const { mode, width, height } = step.options\r\n                    let cropDesc = `${stepNum}. LemGendaryCrop to ${width}${height}`\r\n\r\n                    if (['smart', 'face', 'object', 'saliency', 'entropy'].includes(mode)) {\r\n                        cropDesc += ` (AI ${mode} mode)`\r\n                    } else {\r\n                        cropDesc += ` (${mode})`\r\n                    }\r\n\r\n                    return cropDesc\r\n                case 'optimize':\r\n                    const formatStr = step.options.format === 'auto'\r\n                        ? 'auto (intelligent selection)'\r\n                        : step.options.format.toUpperCase()\r\n\r\n                    let optimizeDesc = `${stepNum}. LemGendaryOptimize to ${formatStr} (${step.options.quality}%)`\r\n\r\n                    if (step.options.maxDisplayWidth) {\r\n                        optimizeDesc += `, max ${step.options.maxDisplayWidth}px`\r\n                    }\r\n\r\n                    if (step.options.compressionMode && step.options.compressionMode !== 'adaptive') {\r\n                        optimizeDesc += `, ${step.options.compressionMode} compression`\r\n                    }\r\n\r\n                    if (step.options.browserSupport) {\r\n                        optimizeDesc += `, ${step.options.browserSupport.join('+')} browsers`\r\n                    }\r\n\r\n                    return optimizeDesc\r\n                case 'rename':\r\n                    return `${stepNum}. Rename with pattern: \"${step.options.pattern}\"`\r\n                case 'template':\r\n                    return `${stepNum}. Apply template: ${step.options.templateId}`\r\n                case 'favicon':\r\n                    const sizeCount = step.options.sizes?.length || 0\r\n                    const formatCount = step.options.formats?.length || 0\r\n                    return `${stepNum}. Generate favicon set (${sizeCount} sizes, ${formatCount} formats)`\r\n                default:\r\n                    return `${stepNum}. ${processor}`\r\n            }\r\n        }).join('\\n')\r\n    }\r\n\r\n    /**\r\n     * Get estimated processing time\r\n     * @param {number} imageCount - Number of images\r\n     * @returns {Object} Time estimates\r\n     */\r\n    getTimeEstimate = (imageCount = 1) => {\r\n        const enabledSteps = this.getEnabledSteps()\r\n\r\n        const stepTimes = {\r\n            'resize': 100,\r\n            'crop': 150,\r\n            'optimize': 200,\r\n            'rename': 10,\r\n            'template': 300,\r\n            'favicon': 500\r\n        }\r\n\r\n        let totalMs = 0\r\n        let complexityFactor = 1\r\n\r\n        enabledSteps.forEach(step => {\r\n            const baseTime = stepTimes[step.processor] || 100\r\n\r\n            if (step.processor === 'favicon') {\r\n                const sizeCount = step.options.sizes?.length || 1\r\n                const formatCount = step.options.formats?.length || 1\r\n                complexityFactor = sizeCount * formatCount\r\n            } else if (step.processor === 'crop' &&\r\n                ['smart', 'face', 'object'].includes(step.options.mode)) {\r\n                complexityFactor = 3 // AI processing takes longer\r\n            } else if (step.processor === 'optimize') {\r\n                if (step.options.compressionMode === 'aggressive') {\r\n                    complexityFactor = 1.5\r\n                }\r\n                if (step.options.analyzeContent) {\r\n                    complexityFactor *= 1.2\r\n                }\r\n            }\r\n\r\n            totalMs += baseTime * complexityFactor\r\n        })\r\n\r\n        totalMs *= imageCount\r\n\r\n        return {\r\n            perImage: totalMs / imageCount,\r\n            total: totalMs,\r\n            formatted: this._formatTime(totalMs),\r\n            stepCount: enabledSteps.length,\r\n            imageCount,\r\n            complexityFactor: Math.round(complexityFactor * 10) / 10\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Format time in milliseconds\r\n     * @private\r\n     */\r\n    _formatTime = (ms) => {\r\n        if (ms < 1000) return `${Math.round(ms)}ms`\r\n        if (ms < 60000) return `${(ms / 1000).toFixed(1)}s`\r\n        const minutes = Math.floor(ms / 60000)\r\n        const seconds = Math.round((ms % 60000) / 1000)\r\n        return `${minutes}m ${seconds}s`\r\n    }\r\n\r\n    /**\r\n     * Export task configuration\r\n     * @returns {Object} Task configuration\r\n     */\r\n    exportConfig = () => {\r\n        return {\r\n            id: this.id,\r\n            name: this.name,\r\n            description: this.description,\r\n            version: '2.2.0',\r\n            steps: this.steps.map(step => ({\r\n                id: step.id,\r\n                processor: step.processor,\r\n                options: { ...step.options },\r\n                enabled: step.enabled,\r\n                order: step.order,\r\n                metadata: step.metadata\r\n            })),\r\n            metadata: { ...this.metadata },\r\n            createdAt: this.createdAt,\r\n            updatedAt: this.updatedAt,\r\n            validation: {\r\n                warnings: this.validationWarnings,\r\n                errors: this.validationErrors\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Import task configuration\r\n     * @param {Object} config - Task configuration\r\n     * @returns {LemGendTask} New task instance\r\n     */\r\n    static importConfig(config) {\r\n        const task = new LemGendTask(config.name, config.description)\r\n        task.id = config.id || task.id\r\n        task.createdAt = config.createdAt || task.createdAt\r\n        task.updatedAt = config.updatedAt || task.updatedAt\r\n        task.metadata = config.metadata || task.metadata\r\n        task.validationWarnings = config.validation?.warnings || []\r\n        task.validationErrors = config.validation?.errors || []\r\n\r\n        config.steps?.forEach(stepConfig => {\r\n            task.addStep(stepConfig.processor, stepConfig.options)\r\n            const lastStep = task.steps[task.steps.length - 1]\r\n            lastStep.enabled = stepConfig.enabled !== false\r\n            lastStep.id = stepConfig.id || lastStep.id\r\n            lastStep.metadata = stepConfig.metadata || lastStep.metadata\r\n        })\r\n\r\n        return task\r\n    }\r\n\r\n    /**\r\n     * Create task from template\r\n     * @param {string} templateName - Template name\r\n     * @returns {LemGendTask} New task instance\r\n     */\r\n    static fromTemplate(templateName) {\r\n        const templates = {\r\n            'web-optimized': {\r\n                name: 'Web Optimization',\r\n                description: 'Optimize images for web with modern formats',\r\n                steps: [\r\n                    { processor: 'resize', options: { dimension: 1920, mode: 'longest' } },\r\n                    { processor: 'optimize', options: { quality: 85, format: 'auto', compressionMode: 'adaptive' } },\r\n                    { processor: 'rename', options: { pattern: '{name}-{width}w' } }\r\n                ]\r\n            },\r\n            'social-media': {\r\n                name: 'Social Media Posts',\r\n                description: 'Prepare images for social media platforms',\r\n                steps: [\r\n                    { processor: 'resize', options: { dimension: 1080, mode: 'longest' } },\r\n                    {\r\n                        processor: 'crop',\r\n                        options: {\r\n                            width: 1080,\r\n                            height: 1080,\r\n                            mode: 'smart',\r\n                            confidenceThreshold: 70,\r\n                            multipleFaces: true\r\n                        }\r\n                    },\r\n                    { processor: 'optimize', options: { quality: 90, format: 'auto', compressionMode: 'balanced' } }\r\n                ]\r\n            },\r\n            'portrait-smart': {\r\n                name: 'Smart Portrait Cropping',\r\n                description: 'AI-powered portrait cropping with face detection',\r\n                steps: [\r\n                    { processor: 'resize', options: { dimension: 1080, mode: 'longest' } },\r\n                    {\r\n                        processor: 'crop',\r\n                        options: {\r\n                            width: 1080,\r\n                            height: 1350,\r\n                            mode: 'face',\r\n                            confidenceThreshold: 80,\r\n                            preserveAspectRatio: true\r\n                        }\r\n                    },\r\n                    { processor: 'optimize', options: { quality: 95, format: 'auto', compressionMode: 'adaptive' } }\r\n                ]\r\n            },\r\n            'product-showcase': {\r\n                name: 'Product Showcase',\r\n                description: 'Smart cropping for product images',\r\n                steps: [\r\n                    { processor: 'resize', options: { dimension: 1200, mode: 'longest' } },\r\n                    {\r\n                        processor: 'crop',\r\n                        options: {\r\n                            width: 1200,\r\n                            height: 1200,\r\n                            mode: 'object',\r\n                            objectsToDetect: ['product', 'item'],\r\n                            confidenceThreshold: 75\r\n                        }\r\n                    },\r\n                    { processor: 'optimize', options: { quality: 90, format: 'auto', compressionMode: 'balanced' } }\r\n                ]\r\n            },\r\n            'favicon-package': {\r\n                name: 'Favicon Package',\r\n                description: 'Generate complete favicon set for all devices',\r\n                steps: [\r\n                    { processor: 'resize', options: { dimension: 512, mode: 'longest' } },\r\n                    {\r\n                        processor: 'crop',\r\n                        options: {\r\n                            width: 512,\r\n                            height: 512,\r\n                            mode: 'smart',\r\n                            confidenceThreshold: 70\r\n                        }\r\n                    },\r\n                    {\r\n                        processor: 'favicon', options: {\r\n                            sizes: [16, 32, 48, 64, 128, 180, 192, 256, 512],\r\n                            formats: ['png', 'ico'],\r\n                            generateManifest: true,\r\n                            generateHTML: true\r\n                        }\r\n                    },\r\n                    { processor: 'rename', options: { pattern: '{name}-favicon-{size}' } }\r\n                ]\r\n            },\r\n            'optimization-only': {\r\n                name: 'Optimization Only',\r\n                description: 'Optimize images without resizing or cropping',\r\n                steps: [\r\n                    {\r\n                        processor: 'optimize',\r\n                        options: {\r\n                            quality: 85,\r\n                            format: 'auto',\r\n                            maxDisplayWidth: 1920,\r\n                            compressionMode: 'adaptive',\r\n                            browserSupport: ['modern', 'legacy']\r\n                        }\r\n                    }\r\n                ]\r\n            }\r\n        }\r\n\r\n        const template = templates[templateName]\r\n        if (!template) {\r\n            throw new Error(`Unknown template: ${templateName}`)\r\n        }\r\n\r\n        return LemGendTask.importConfig(template)\r\n    }\r\n\r\n    /**\r\n     * Update metadata\r\n     * @private\r\n     */\r\n    _updateMetadata = () => {\r\n        const enabledSteps = this.getEnabledSteps()\r\n\r\n        this.metadata.estimatedDuration = this.getTimeEstimate().total\r\n        this.metadata.estimatedOutputs = this._estimateOutputCount()\r\n        this.metadata.stepCount = enabledSteps.length\r\n\r\n        const processorCount = {}\r\n        enabledSteps.forEach(step => {\r\n            processorCount[step.processor] = (processorCount[step.processor] || 0) + 1\r\n        })\r\n        this.metadata.processorCount = processorCount\r\n\r\n        if (processorCount.favicon > 0) {\r\n            this.metadata.category = 'favicon'\r\n        } else if (processorCount.template > 0) {\r\n            this.metadata.category = 'template'\r\n        } else if (processorCount.optimize > 0 && processorCount.resize === 0 && processorCount.crop === 0) {\r\n            this.metadata.category = 'optimization-only'\r\n        } else {\r\n            this.metadata.category = 'general'\r\n        }\r\n\r\n        this.metadata.hasSmartCrop = enabledSteps.some(s => s.processor === 'crop' &&\r\n            ['smart', 'face', 'object'].includes(s.options.mode))\r\n        this.metadata.hasAutoOptimization = enabledSteps.some(s =>\r\n            s.processor === 'optimize' && s.options.format === 'auto'\r\n        )\r\n    }\r\n\r\n    /**\r\n     * Clone the task\r\n     * @returns {LemGendTask} Cloned task\r\n     */\r\n    clone = () => {\r\n        return LemGendTask.importConfig(this.exportConfig())\r\n    }\r\n\r\n    /**\r\n     * Create a simplified version of the task for UI display\r\n     * @returns {Object} Simplified task info\r\n     */\r\n    toSimpleObject = () => {\r\n        const summary = this.getValidationSummary()\r\n\r\n        return {\r\n            id: this.id,\r\n            name: this.name,\r\n            description: this.description,\r\n            stepCount: this.steps.length,\r\n            enabledStepCount: this.getEnabledSteps().length,\r\n            hasFavicon: summary.hasFavicon,\r\n            hasSmartCrop: summary.hasSmartCrop,\r\n            hasAutoOptimization: summary.hasAutoOptimization,\r\n            taskType: summary.taskType,\r\n            status: summary.status,\r\n            canProceed: summary.canProceed,\r\n            estimatedOutputs: summary.estimatedOutputs,\r\n            optimizationLevel: summary.optimizationLevel,\r\n            createdAt: this.createdAt,\r\n            updatedAt: this.updatedAt\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Check if task is compatible with image type\r\n     * @param {string} mimeType - Image MIME type\r\n     * @returns {Object} Compatibility result\r\n     */\r\n    checkCompatibility = (mimeType) => {\r\n        const enabledSteps = this.getEnabledSteps()\r\n        const hasFavicon = enabledSteps.some(s => s.processor === 'favicon')\r\n        const hasSmartCrop = enabledSteps.some(s => s.processor === 'crop' &&\r\n            ['smart', 'face', 'object'].includes(s.options.mode))\r\n        const hasOptimization = enabledSteps.some(s => s.processor === 'optimize')\r\n\r\n        let compatible = true\r\n        const warnings = []\r\n        const errors = []\r\n\r\n        if (mimeType === 'image/svg+xml') {\r\n            if (hasFavicon) {\r\n                warnings.push('SVG to favicon conversion may not preserve all features')\r\n            }\r\n\r\n            if (hasSmartCrop) {\r\n                warnings.push('SVG images will be rasterized before smart cropping')\r\n            }\r\n        }\r\n\r\n        if (mimeType === 'image/gif') {\r\n            if (hasFavicon) {\r\n                warnings.push('Animated GIFs will lose animation in favicon conversion')\r\n            }\r\n\r\n            if (hasSmartCrop) {\r\n                warnings.push('Smart crop will use first frame of animated GIF')\r\n            }\r\n\r\n            if (hasOptimization) {\r\n                warnings.push('GIF optimization may reduce animation quality')\r\n            }\r\n        }\r\n\r\n        if (mimeType === 'image/x-icon' || mimeType === 'image/vnd.microsoft.icon') {\r\n            warnings.push('ICO files contain multiple images; processing may use first frame only')\r\n        }\r\n\r\n        return {\r\n            compatible,\r\n            warnings,\r\n            errors,\r\n            recommended: warnings.length === 0 && errors.length === 0\r\n        }\r\n    }\r\n}","/**\r\n * LemGendary Image Processor - Main Entry Point\r\n * @module image-lemgendizer\r\n */\r\n\r\n// Core classes\r\nimport { LemGendImage } from './LemGendImage.js'\r\nimport { LemGendTask } from './tasks/LemGendTask.js'\r\n\r\n// Processors\r\nimport { LemGendaryResize } from './processors/LemGendaryResize.js'\r\nimport { LemGendaryCrop } from './processors/LemGendaryCrop.js'\r\nimport { LemGendaryOptimize } from './processors/LemGendaryOptimize.js'\r\nimport { LemGendaryRename } from './processors/LemGendaryRename.js'\r\n\r\n// Templates - COMPLETE IMPORTS with flexible dimension support\r\nimport {\r\n    LemGendTemplates,\r\n    TEMPLATE_CATEGORIES,\r\n    PLATFORMS,\r\n    getTemplatesByPlatform,\r\n    getTemplatesByCategory,\r\n    getTemplateById,\r\n    getTemplatesByDimensions,\r\n    getRecommendedTemplates,\r\n    getTemplateStats,\r\n    exportTemplates,\r\n    validateTemplate,\r\n    addCustomTemplate,\r\n    getAllPlatforms,\r\n    getTemplatesGroupedByPlatform,\r\n    searchTemplates,\r\n    getTemplateAspectRatio,\r\n    getFlexibleTemplates,\r\n    getTemplatesForImage,\r\n    isVariableDimension,\r\n    parseDimension\r\n} from './templates/index.js'\r\n\r\n// Utilities\r\nimport {\r\n    createLemGendaryZip,\r\n    createSimpleZip,\r\n    extractZip,\r\n    getZipInfo,\r\n    createZipWithProgress\r\n} from './utils/zipUtils.js'\r\n\r\nimport {\r\n    getImageDimensions,\r\n    hasTransparency,\r\n    fileToDataURL,\r\n    dataURLtoFile,\r\n    resizeImage,\r\n    cropImage,\r\n    calculateAspectRatioFit,\r\n    formatFileSize,\r\n    getFileExtension,\r\n    validateImageFile,\r\n    createThumbnail,\r\n    batchProcess\r\n} from './utils/imageUtils.js'\r\n\r\n// Validation - COMPLETE IMPORTS with flexible dimension support\r\nimport {\r\n    ValidationErrors,\r\n    ValidationWarnings,\r\n    validateImage,\r\n    validateDimensions,\r\n    validateResize,\r\n    validateCrop,\r\n    validateOptimization,\r\n    validateRenamePattern,\r\n    getValidationSummary,\r\n    validateOptimizationOptions,\r\n    validateTemplateCompatibility,\r\n    isVariableDimension as validationIsVariableDimension,\r\n    parseDimension as validationParseDimension,\r\n    getFlexibleTemplates as validationGetFlexibleTemplates\r\n} from './utils/validation.js'\r\n\r\n// Re-export everything as named exports\r\nexport {\r\n    LemGendImage,\r\n    LemGendTask,\r\n    LemGendaryResize,\r\n    LemGendaryCrop,\r\n    LemGendaryOptimize,\r\n    LemGendaryRename\r\n}\r\n\r\nexport {\r\n    LemGendTemplates,\r\n    TEMPLATE_CATEGORIES,\r\n    PLATFORMS,\r\n    getTemplatesByPlatform,\r\n    getTemplatesByCategory,\r\n    getTemplateById,\r\n    getTemplatesByDimensions,\r\n    getRecommendedTemplates,\r\n    getTemplateStats,\r\n    exportTemplates,\r\n    validateTemplate,\r\n    addCustomTemplate,\r\n    getAllPlatforms,\r\n    getTemplatesGroupedByPlatform,\r\n    searchTemplates,\r\n    getTemplateAspectRatio,\r\n    getFlexibleTemplates,\r\n    getTemplatesForImage,\r\n    isVariableDimension,\r\n    parseDimension\r\n}\r\n\r\nexport {\r\n    createLemGendaryZip,\r\n    createSimpleZip,\r\n    extractZip,\r\n    getZipInfo,\r\n    createZipWithProgress\r\n}\r\n\r\nexport {\r\n    getImageDimensions,\r\n    hasTransparency,\r\n    fileToDataURL,\r\n    dataURLtoFile,\r\n    resizeImage,\r\n    cropImage,\r\n    calculateAspectRatioFit,\r\n    formatFileSize,\r\n    getFileExtension,\r\n    validateImageFile,\r\n    createThumbnail,\r\n    batchProcess\r\n}\r\n\r\nexport {\r\n    ValidationErrors,\r\n    ValidationWarnings,\r\n    validateImage,\r\n    validateDimensions,\r\n    validateResize,\r\n    validateCrop,\r\n    validateOptimization,\r\n    validateRenamePattern,\r\n    getValidationSummary,\r\n    validateOptimizationOptions,\r\n    validateTemplateCompatibility\r\n}\r\n\r\n/**\r\n * Actually resize an image using canvas\r\n * @private\r\n */\r\nasync function _actuallyResizeImage(file, targetWidth, targetHeight, algorithm = 'lanczos3') {\r\n    return new Promise((resolve, reject) => {\r\n        const img = new Image()\r\n        img.onload = () => {\r\n            try {\r\n                const canvas = document.createElement('canvas')\r\n                canvas.width = targetWidth\r\n                canvas.height = targetHeight\r\n\r\n                const ctx = canvas.getContext('2d')\r\n                if (!ctx) {\r\n                    reject(new Error('Canvas context not supported'))\r\n                    return\r\n                }\r\n\r\n                ctx.imageSmoothingEnabled = true\r\n                ctx.imageSmoothingQuality = 'high'\r\n\r\n                ctx.drawImage(img, 0, 0, targetWidth, targetHeight)\r\n\r\n                canvas.toBlob((blob) => {\r\n                    if (!blob) {\r\n                        reject(new Error('Failed to create blob from canvas'))\r\n                        return\r\n                    }\r\n\r\n                    const resizedFile = new File(\r\n                        [blob],\r\n                        file.name,\r\n                        { type: file.type }\r\n                    )\r\n\r\n                    URL.revokeObjectURL(img.src)\r\n                    resolve(resizedFile)\r\n                }, file.type, 0.95)\r\n            } catch (error) {\r\n                URL.revokeObjectURL(img.src)\r\n                reject(new Error(`Resize failed: ${error.message}`))\r\n            }\r\n        }\r\n        img.onerror = () => {\r\n            reject(new Error('Failed to load image for resizing'))\r\n        }\r\n        img.src = URL.createObjectURL(file)\r\n    })\r\n}\r\n\r\n/**\r\n * Actually crop an image using canvas\r\n * @private\r\n */\r\nasync function _actuallyCropImage(file, originalWidth, originalHeight, cropWidth, cropHeight, offsetX, offsetY) {\r\n    return new Promise((resolve, reject) => {\r\n        const img = new Image()\r\n        img.onload = () => {\r\n            try {\r\n                const canvas = document.createElement('canvas')\r\n                canvas.width = cropWidth\r\n                canvas.height = cropHeight\r\n\r\n                const ctx = canvas.getContext('2d')\r\n                if (!ctx) {\r\n                    reject(new Error('Canvas context not supported'))\r\n                    return\r\n                }\r\n\r\n                ctx.drawImage(\r\n                    img,\r\n                    offsetX, offsetY, cropWidth, cropHeight,\r\n                    0, 0, cropWidth, cropHeight\r\n                )\r\n\r\n                canvas.toBlob((blob) => {\r\n                    if (!blob) {\r\n                        reject(new Error('Failed to create blob from canvas'))\r\n                        return\r\n                    }\r\n\r\n                    const croppedFile = new File(\r\n                        [blob],\r\n                        file.name,\r\n                        { type: file.type }\r\n                    )\r\n\r\n                    URL.revokeObjectURL(img.src)\r\n                    resolve(croppedFile)\r\n                }, file.type, 0.95)\r\n            } catch (error) {\r\n                URL.revokeObjectURL(img.src)\r\n                reject(new Error(`Crop failed: ${error.message}`))\r\n            }\r\n        }\r\n        img.onerror = () => {\r\n            reject(new Error('Failed to load image for cropping'))\r\n        }\r\n        img.src = URL.createObjectURL(file)\r\n    })\r\n}\r\n\r\n/**\r\n * Apply optimization to file using the enhanced LemGendaryOptimize\r\n * @private\r\n */\r\nasync function applyOptimization(file, dimensions, options, hasTransparency) {\r\n    const { quality, format, lossless = false } = options\r\n\r\n    if (format === 'original') {\r\n        return file\r\n    }\r\n\r\n    return new Promise((resolve, reject) => {\r\n        const img = new Image()\r\n\r\n        img.onload = () => {\r\n            try {\r\n                const canvas = document.createElement('canvas')\r\n                canvas.width = dimensions.width\r\n                canvas.height = dimensions.height\r\n\r\n                const ctx = canvas.getContext('2d')\r\n                if (!ctx) {\r\n                    reject(new Error('Canvas context not supported'))\r\n                    return\r\n                }\r\n\r\n                ctx.drawImage(img, 0, 0, dimensions.width, dimensions.height)\r\n\r\n                let mimeType = 'image/jpeg'\r\n                let qualityValue = Math.max(0.1, Math.min(1, quality / 100))\r\n\r\n                switch (format.toLowerCase()) {\r\n                    case 'webp':\r\n                        mimeType = 'image/webp'\r\n                        break\r\n                    case 'png':\r\n                        mimeType = 'image/png'\r\n                        qualityValue = undefined\r\n                        break\r\n                    case 'avif':\r\n                        mimeType = 'image/avif'\r\n                        break\r\n                    case 'jpg':\r\n                    case 'jpeg':\r\n                    default:\r\n                        mimeType = 'image/jpeg'\r\n                }\r\n\r\n                if (hasTransparency && (format === 'jpg' || format === 'jpeg')) {\r\n                    const tempCanvas = document.createElement('canvas')\r\n                    tempCanvas.width = dimensions.width\r\n                    tempCanvas.height = dimensions.height\r\n                    const tempCtx = tempCanvas.getContext('2d')\r\n                    tempCtx.fillStyle = 'white'\r\n                    tempCtx.fillRect(0, 0, dimensions.width, dimensions.height)\r\n                    tempCtx.drawImage(img, 0, 0)\r\n\r\n                    tempCanvas.toBlob(\r\n                        (blob) => {\r\n                            if (!blob) {\r\n                                reject(new Error('Failed to create blob'))\r\n                                return\r\n                            }\r\n\r\n                            const optimizedFile = new File(\r\n                                [blob],\r\n                                `${file.name.replace(/\\.[^/.]+$/, '')}.${format.toLowerCase()}`,\r\n                                { type: mimeType }\r\n                            )\r\n                            URL.revokeObjectURL(img.src)\r\n                            resolve(optimizedFile)\r\n                        },\r\n                        mimeType,\r\n                        qualityValue\r\n                    )\r\n                } else {\r\n                    canvas.toBlob(\r\n                        (blob) => {\r\n                            if (!blob) {\r\n                                reject(new Error('Failed to create blob'))\r\n                                return\r\n                            }\r\n\r\n                            const optimizedFile = new File(\r\n                                [blob],\r\n                                `${file.name.replace(/\\.[^/.]+$/, '')}.${format.toLowerCase()}`,\r\n                                { type: mimeType }\r\n                            )\r\n                            URL.revokeObjectURL(img.src)\r\n                            resolve(optimizedFile)\r\n                        },\r\n                        mimeType,\r\n                        qualityValue\r\n                    )\r\n                }\r\n            } catch (error) {\r\n                URL.revokeObjectURL(img.src)\r\n                reject(new Error(`Optimization failed: ${error.message}`))\r\n            }\r\n        }\r\n\r\n        img.onerror = () => {\r\n            reject(new Error('Failed to load image for optimization'))\r\n        }\r\n\r\n        img.src = URL.createObjectURL(file)\r\n    })\r\n}\r\n\r\n/**\r\n * Helper function to get file extension\r\n * Renamed to avoid conflict with imported getFileExtension\r\n * @private\r\n */\r\nfunction _getFileExtension(file) {\r\n    return file.name.split('.').pop().toLowerCase()\r\n}\r\n\r\n/**\r\n * Process single file through task pipeline with optimization-first approach\r\n * @private\r\n */\r\nasync function processSingleFile(file, task, index) {\r\n    console.log('processSingleFile called with:', {\r\n        fileType: file?.constructor?.name,\r\n        isLemGendImage: file instanceof LemGendImage,\r\n        hasFileProperty: !!(file?.file),\r\n        filePropertyType: file?.file?.constructor?.name\r\n    })\r\n\r\n    let lemGendImage\r\n\r\n    try {\r\n        if (file instanceof LemGendImage) {\r\n            lemGendImage = file\r\n\r\n            console.log('Using existing LemGendImage:', {\r\n                hasFile: !!lemGendImage.file,\r\n                fileType: lemGendImage.file?.constructor?.name,\r\n                width: lemGendImage.width,\r\n                height: lemGendImage.height,\r\n                originalName: lemGendImage.originalName\r\n            })\r\n\r\n            if (!lemGendImage.file || !(lemGendImage.file instanceof File)) {\r\n                console.warn('LemGendImage missing valid file property')\r\n                throw new Error('LemGendImage has no valid file property')\r\n            }\r\n\r\n            if (!lemGendImage.width || !lemGendImage.height) {\r\n                try {\r\n                    console.log('LemGendImage missing dimensions, loading...')\r\n                    await lemGendImage.load()\r\n                } catch (loadError) {\r\n                    console.warn('Failed to load existing LemGendImage:', loadError)\r\n                    throw new Error(`Failed to load LemGendImage: ${loadError.message}`)\r\n                }\r\n            }\r\n\r\n        } else if (file && file.file && file.file instanceof File) {\r\n            console.log('Creating new LemGendImage from file object...')\r\n            lemGendImage = new LemGendImage(file.file)\r\n            await lemGendImage.load()\r\n\r\n        } else if (file instanceof File || file instanceof Blob) {\r\n            console.log('Creating new LemGendImage from File/Blob...')\r\n            lemGendImage = new LemGendImage(file)\r\n            await lemGendImage.load()\r\n\r\n        } else {\r\n            throw new Error(`Invalid file type provided for processing. Got: ${typeof file}, constructor: ${file?.constructor?.name}`)\r\n        }\r\n\r\n        if (!lemGendImage || !(lemGendImage instanceof LemGendImage)) {\r\n            throw new Error('Failed to create valid LemGendImage instance')\r\n        }\r\n\r\n        if (!lemGendImage.file || !(lemGendImage.file instanceof File)) {\r\n            throw new Error('LemGendImage missing file property')\r\n        }\r\n\r\n        if (!lemGendImage.width || !lemGendImage.height) {\r\n            throw new Error('LemGendImage missing dimensions')\r\n        }\r\n\r\n        console.log('Validating task with LemGendImage...', {\r\n            originalName: lemGendImage.originalName,\r\n            width: lemGendImage.width,\r\n            height: lemGendImage.height,\r\n            hasFile: !!lemGendImage.file,\r\n            fileType: lemGendImage.file?.constructor?.name\r\n        })\r\n\r\n        const validation = await task.validate(lemGendImage)\r\n\r\n        if (!validation.isValid) {\r\n            const errorMessage = validation.errors.map(e => e.message).join(', ')\r\n            console.error('Task validation failed:', errorMessage)\r\n            throw new Error(`Task validation failed: ${errorMessage}`)\r\n        }\r\n\r\n        console.log('Task validation passed successfully')\r\n\r\n        const enabledSteps = task.getEnabledSteps()\r\n        let currentFile = lemGendImage.file\r\n        let currentDimensions = {\r\n            width: lemGendImage.width,\r\n            height: lemGendImage.height\r\n        }\r\n\r\n        const processingOrder = ['resize', 'crop', 'optimize', 'rename']\r\n        const sortedSteps = enabledSteps.sort((a, b) => {\r\n            const indexA = processingOrder.indexOf(a.processor)\r\n            const indexB = processingOrder.indexOf(b.processor)\r\n            return indexA - indexB\r\n        })\r\n\r\n        console.log('Processing steps in order:', sortedSteps.map(s => `${s.order}.${s.processor}`))\r\n        console.log('Starting image dimensions:', currentDimensions)\r\n\r\n        for (const step of sortedSteps) {\r\n            try {\r\n                console.log(`\\n=== Processing step ${step.order}: ${step.processor} ===`)\r\n\r\n                switch (step.processor) {\r\n                    case 'resize':\r\n                        const resizeProcessor = new LemGendaryResize(step.options)\r\n                        const resizeResult = await resizeProcessor.process(lemGendImage)\r\n\r\n                        console.log('Resize result:', {\r\n                            original: `${resizeResult.originalDimensions.width}x${resizeResult.originalDimensions.height}`,\r\n                            target: `${resizeResult.newDimensions.width}x${resizeResult.newDimensions.height}`,\r\n                            mode: step.options.mode,\r\n                            dimension: step.options.dimension\r\n                        })\r\n\r\n                        currentFile = await _actuallyResizeImage(\r\n                            currentFile,\r\n                            resizeResult.newDimensions.width,\r\n                            resizeResult.newDimensions.height,\r\n                            step.options.algorithm || 'lanczos3'\r\n                        )\r\n\r\n                        currentDimensions = resizeResult.newDimensions\r\n                        lemGendImage.updateDimensions(currentDimensions.width, currentDimensions.height)\r\n                        lemGendImage.addOperation('resize', resizeResult)\r\n\r\n                        console.log(` Resized to: ${currentDimensions.width}x${currentDimensions.height}`)\r\n                        console.log('File after resize:', {\r\n                            name: currentFile.name,\r\n                            size: currentFile.size,\r\n                            type: currentFile.type\r\n                        })\r\n                        break\r\n\r\n                    case 'crop':\r\n                        const cropProcessor = new LemGendaryCrop(step.options)\r\n                        const cropResult = await cropProcessor.process(lemGendImage, currentDimensions)\r\n\r\n                        console.log('Crop result:', {\r\n                            current: `${currentDimensions.width}x${currentDimensions.height}`,\r\n                            target: `${cropResult.finalDimensions.width}x${cropResult.finalDimensions.height}`,\r\n                            mode: step.options.mode,\r\n                            smartCrop: cropResult.smartCrop\r\n                        })\r\n\r\n                        // Use either smart crop or regular crop\r\n                        if (cropResult.smartCrop) {\r\n                            console.log('Smart crop detected with steps:', {\r\n                                detection: cropResult.steps.detection.confidence,\r\n                                resize: cropResult.steps.resize,\r\n                                crop: cropResult.cropOffsets\r\n                            })\r\n                        }\r\n\r\n                        currentFile = await _actuallyCropImage(\r\n                            currentFile,\r\n                            currentDimensions.width,\r\n                            currentDimensions.height,\r\n                            cropResult.cropOffsets.width,\r\n                            cropResult.cropOffsets.height,\r\n                            cropResult.cropOffsets.x,\r\n                            cropResult.cropOffsets.y\r\n                        )\r\n\r\n                        currentDimensions = cropResult.finalDimensions\r\n                        lemGendImage.updateDimensions(currentDimensions.width, currentDimensions.height)\r\n                        lemGendImage.addOperation('crop', cropResult)\r\n\r\n                        console.log(` Cropped to: ${currentDimensions.width}x${currentDimensions.height}`)\r\n                        console.log('File after crop:', {\r\n                            name: currentFile.name,\r\n                            size: currentFile.size,\r\n                            type: currentFile.type\r\n                        })\r\n                        break\r\n\r\n                    case 'optimize':\r\n                        const optimizeProcessor = new LemGendaryOptimize(step.options)\r\n                        const optimizeResult = await optimizeProcessor.process(lemGendImage)\r\n\r\n                        console.log('Optimize result:', {\r\n                            format: step.options.format,\r\n                            quality: step.options.quality,\r\n                            originalFormat: optimizeResult.originalInfo.format,\r\n                            transparency: optimizeResult.originalInfo.transparency,\r\n                            savings: optimizeResult.savings\r\n                        })\r\n\r\n                        // Apply optimization using the enhanced processor\r\n                        currentFile = await optimizeProcessor.applyOptimization(lemGendImage)\r\n\r\n                        lemGendImage.addOperation('optimize', optimizeResult)\r\n                        console.log(` Optimized to: ${optimizeResult.optimization.selectedFormat} at ${optimizeResult.optimization.compression.quality}%`)\r\n                        console.log('File after optimize:', {\r\n                            name: currentFile.name,\r\n                            size: currentFile.size,\r\n                            type: currentFile.type,\r\n                            savings: `${optimizeResult.savings.savingsPercent}%`\r\n                        })\r\n                        break\r\n\r\n                    case 'rename':\r\n                        const renameProcessor = new LemGendaryRename(step.options)\r\n                        const renameResult = await renameProcessor.process(lemGendImage, index, task.steps.length)\r\n\r\n                        const extension = _getFileExtension(currentFile)\r\n\r\n                        const renamedFile = new File(\r\n                            [currentFile],\r\n                            `${renameResult.newName}.${extension}`,\r\n                            { type: currentFile.type }\r\n                        )\r\n\r\n                        currentFile = renamedFile\r\n                        lemGendImage.addOperation('rename', renameResult)\r\n                        console.log(` Renamed to: ${renameResult.newName}.${extension}`)\r\n                        break\r\n\r\n                    default:\r\n                        console.warn(`Unknown processor: ${step.processor}`)\r\n                }\r\n            } catch (error) {\r\n                console.error(`Error in step ${step.order} (${step.processor}):`, error)\r\n                throw new Error(`Step ${step.order} (${step.processor}) failed: ${error.message}`)\r\n            }\r\n        }\r\n\r\n        const outputFormat = _getFileExtension(currentFile)\r\n        lemGendImage.addOutput(\r\n            outputFormat,\r\n            currentFile,\r\n            null\r\n        )\r\n\r\n        console.log('\\n=== Processing Complete ===')\r\n        console.log('Final result:', {\r\n            originalName: lemGendImage.originalName,\r\n            finalName: currentFile.name,\r\n            originalSize: lemGendImage.originalSize,\r\n            finalSize: currentFile.size,\r\n            dimensions: `${currentDimensions.width}x${currentDimensions.height}`,\r\n            format: outputFormat,\r\n            sizeReduction: `${((lemGendImage.originalSize - currentFile.size) / lemGendImage.originalSize * 100).toFixed(1)}%`\r\n        })\r\n\r\n        return {\r\n            image: lemGendImage,\r\n            file: currentFile,\r\n            success: true,\r\n            metadata: lemGendImage.getInfo()\r\n        }\r\n\r\n    } catch (error) {\r\n        console.error('Error in processSingleFile:', error)\r\n        return {\r\n            image: lemGendImage || file,\r\n            file: lemGendImage?.file || file,\r\n            error: error.message,\r\n            success: false\r\n        }\r\n    }\r\n}\r\n\r\n/**\r\n * Main processing function\r\n * @param {Array<File|LemGendImage|Object>} files - Image files, LemGendImage instances, or objects with file/lemGendImage properties\r\n * @param {LemGendTask} task - Processing task\r\n * @param {Object} options - Processing options\r\n * @returns {Promise<Array>} Processed images\r\n */\r\nexport async function lemGendaryProcessBatch(files, task, options = {}) {\r\n    const {\r\n        onProgress = null,\r\n        onWarning = null,\r\n        onError = null,\r\n        parallel = false,\r\n        maxParallel = 4\r\n    } = options\r\n\r\n    const results = []\r\n    const totalFiles = files.length\r\n\r\n    console.log('=== lemGendaryProcessBatch START ===')\r\n    console.log('Batch processing:', {\r\n        totalFiles,\r\n        hasTask: !!task,\r\n        steps: task?.getEnabledSteps()?.length || 0,\r\n        options\r\n    })\r\n\r\n    console.log('Validating task...')\r\n    const taskValidation = files.length > 0 ? await task.validate(files[0]) : await task.validate()\r\n\r\n    if (!taskValidation.isValid) {\r\n        console.error('Task validation failed:', taskValidation.errors)\r\n\r\n        const hasOnlyImageError = taskValidation.errors.every(e =>\r\n            e.type === 'invalid_image' || e.message.includes('No image provided')\r\n        )\r\n\r\n        if (hasOnlyImageError && files.length > 0) {\r\n            console.warn('Task validation has image-related warnings but proceeding anyway...')\r\n        } else {\r\n            throw new Error(`Task validation failed: ${taskValidation.errors.map(e => e.message).join(', ')}`)\r\n        }\r\n    }\r\n\r\n    if (taskValidation.hasWarnings && onWarning) {\r\n        taskValidation.warnings.forEach(warning => onWarning(warning))\r\n    }\r\n\r\n    if (parallel) {\r\n        const batches = []\r\n        for (let i = 0; i < files.length; i += maxParallel) {\r\n            batches.push(files.slice(i, i + maxParallel))\r\n        }\r\n\r\n        for (let batchIndex = 0; batchIndex < batches.length; batchIndex++) {\r\n            const batch = batches[batchIndex]\r\n            const batchPromises = batch.map((file, fileIndex) =>\r\n                processSingleFile(file, task, batchIndex * maxParallel + fileIndex)\r\n            )\r\n\r\n            const batchResults = await Promise.allSettled(batchPromises)\r\n\r\n            batchResults.forEach((result, index) => {\r\n                if (result.status === 'fulfilled') {\r\n                    results.push(result.value)\r\n                } else {\r\n                    const errorResult = {\r\n                        file: batch[index],\r\n                        error: result.reason.message,\r\n                        success: false\r\n                    }\r\n                    results.push(errorResult)\r\n                    if (onError) onError(result.reason, batch[index])\r\n                }\r\n            })\r\n\r\n            if (onProgress) {\r\n                const progress = results.length / totalFiles\r\n                onProgress(progress, results.length, totalFiles)\r\n            }\r\n        }\r\n    } else {\r\n        for (let i = 0; i < files.length; i++) {\r\n            try {\r\n                console.log(`\\n=== Processing file ${i + 1}/${totalFiles} ===`)\r\n\r\n                const file = files[i]\r\n                console.log('File to process:', {\r\n                    type: file?.constructor?.name,\r\n                    isLemGendImage: file instanceof LemGendImage,\r\n                    name: file?.name || file?.originalName || file?.file?.name\r\n                })\r\n\r\n                const result = await processSingleFile(file, task, i)\r\n                results.push(result)\r\n\r\n                if (onProgress) {\r\n                    const progress = (i + 1) / totalFiles\r\n                    onProgress(progress, i + 1, totalFiles)\r\n                }\r\n            } catch (error) {\r\n                console.error(`Failed to process file ${i}:`, error)\r\n                const errorResult = {\r\n                    file: files[i],\r\n                    error: error.message,\r\n                    success: false\r\n                }\r\n                results.push(errorResult)\r\n                if (onError) onError(error, files[i])\r\n            }\r\n        }\r\n    }\r\n\r\n    console.log('\\n=== Processing complete ===')\r\n    console.log('Summary:', {\r\n        totalFiles,\r\n        successful: results.filter(r => r.success).length,\r\n        failed: results.filter(r => !r.success).length\r\n    })\r\n\r\n    results.forEach((result, index) => {\r\n        if (result.success) {\r\n            console.log(` File ${index + 1}: ${result.image?.originalName || 'Unknown'}`, {\r\n                success: true,\r\n                size: result.file?.size,\r\n                dimensions: result.image ? `${result.image.width}x${result.image.height}` : 'N/A'\r\n            })\r\n        } else {\r\n            console.log(` File ${index + 1}: Failed`, {\r\n                error: result.error,\r\n                fileName: result.file?.name || 'Unknown'\r\n            })\r\n        }\r\n    })\r\n\r\n    return results\r\n}\r\n\r\n/**\r\n * Optimize images for ZIP with advanced optimization\r\n * @param {Array<File|LemGendImage>} images - Images to optimize\r\n * @param {Object} optimizationOptions - Optimization options\r\n * @returns {Promise<Array>} Optimized images with results\r\n */\r\nexport async function optimizeForZip(images, optimizationOptions = {}) {\r\n    const optimizer = new LemGendaryOptimize(optimizationOptions)\r\n    const results = []\r\n\r\n    for (const image of images) {\r\n        try {\r\n            let lemGendImage\r\n\r\n            if (image instanceof LemGendImage) {\r\n                lemGendImage = image\r\n            } else {\r\n                lemGendImage = new LemGendImage(image)\r\n                await lemGendImage.load()\r\n            }\r\n\r\n            // Get optimization plan and apply it\r\n            const optimizationResult = await optimizer.process(lemGendImage)\r\n            const optimizedFile = await optimizer.applyOptimization(lemGendImage)\r\n\r\n            // Create optimized LemGendImage\r\n            const optimizedLemGendImage = new LemGendImage(optimizedFile)\r\n            await optimizedLemGendImage.load()\r\n\r\n            results.push({\r\n                original: lemGendImage,\r\n                optimized: optimizedLemGendImage,\r\n                result: optimizationResult,\r\n                success: true\r\n            })\r\n        } catch (error) {\r\n            console.error('Optimization failed:', error)\r\n            results.push({\r\n                original: image,\r\n                error: error.message,\r\n                success: false\r\n            })\r\n        }\r\n    }\r\n\r\n    return results\r\n}\r\n\r\n/**\r\n * Create optimized ZIP from images\r\n * @param {Array<File|LemGendImage>} images - Images to include in ZIP\r\n * @param {Object} options - Options including optimization settings\r\n * @returns {Promise<Blob>} ZIP file with optimized images\r\n */\r\nexport async function createOptimizedZip(images, options = {}) {\r\n    const {\r\n        optimization = {},\r\n        zipOptions = {},\r\n        includeReport = true\r\n    } = options\r\n\r\n    const optimizer = new LemGendaryOptimize(optimization)\r\n\r\n    // Convert to LemGendImage if needed\r\n    const lemGendImages = await Promise.all(\r\n        images.map(async (img) => {\r\n            if (img instanceof LemGendImage) {\r\n                return img\r\n            } else {\r\n                const lemGendImg = new LemGendImage(img)\r\n                await lemGendImg.load()\r\n                return lemGendImg\r\n            }\r\n        })\r\n    )\r\n\r\n    // Step 1: Optimize all images\r\n    console.log(`Optimizing ${lemGendImages.length} images...`)\r\n    const optimizationResults = await optimizer.prepareForZip(lemGendImages)\r\n\r\n    // Step 2: Filter successful optimizations\r\n    const successful = optimizationResults.filter(r => r.success)\r\n    const failed = optimizationResults.filter(r => !r.success)\r\n\r\n    console.log(`Optimization complete: ${successful.length} successful, ${failed.length} failed`)\r\n\r\n    if (successful.length === 0) {\r\n        throw new Error('No images could be optimized')\r\n    }\r\n\r\n    // Step 3: Create optimized images array for ZIP\r\n    const optimizedImages = successful.map(result => {\r\n        const optimizedImage = new LemGendImage(result.optimized)\r\n        optimizedImage.originalName = result.original.originalName\r\n        return optimizedImage\r\n    })\r\n\r\n    // Step 4: Add optimization report if requested\r\n    if (includeReport) {\r\n        const report = optimizer.generateOptimizationReport(optimizationResults)\r\n        const reportFile = new File(\r\n            [JSON.stringify(report, null, 2)],\r\n            'optimization-report.json',\r\n            { type: 'application/json' }\r\n        )\r\n        const reportImage = new LemGendImage(reportFile)\r\n        reportImage.originalName = 'optimization-report.json'\r\n        optimizedImages.push(reportImage)\r\n    }\r\n\r\n    // Step 5: Create ZIP\r\n    console.log('Creating ZIP from optimized images...')\r\n    const zipBlob = await createLemGendaryZip(optimizedImages, {\r\n        zipName: 'optimized-images.zip',\r\n        ...zipOptions\r\n    })\r\n\r\n    return zipBlob\r\n}\r\n\r\n/**\r\n * Create ZIP from processed images\r\n * @param {Array} processedResults - Results from lemGendaryProcessBatch\r\n * @param {Object} options - ZIP options\r\n * @returns {Promise<Blob>} ZIP file\r\n */\r\nexport async function lemGendBuildZip(processedResults, options = {}) {\r\n    const images = processedResults\r\n        .filter(result => result.success)\r\n        .map(result => result.image)\r\n\r\n    return createLemGendaryZip(images, options)\r\n}\r\n\r\n/**\r\n * Get library version and info\r\n * @returns {Object} Library information\r\n */\r\nexport function getLibraryInfo() {\r\n    return {\r\n        name: 'LemGendary Image Processor',\r\n        version: '2.2.0', // Updated to match LemGendTask version\r\n        description: 'Batch image processing with intelligent operations, AI-powered smart cropping, and advanced optimization',\r\n        author: 'LemGenda',\r\n        license: 'MIT',\r\n        homepage: 'https://github.com/lemgenda/image-lemgendizer-core',\r\n        processors: {\r\n            LemGendaryResize: {\r\n                name: 'LemGendaryResize',\r\n                description: 'Intelligent image resizing using longest dimension',\r\n                version: '1.2.1'\r\n            },\r\n            LemGendaryCrop: {\r\n                name: 'LemGendaryCrop',\r\n                description: 'AI-powered smart cropping with face and object detection',\r\n                version: '2.0.0'\r\n            },\r\n            LemGendaryOptimize: {\r\n                name: 'LemGendaryOptimize',\r\n                description: 'Advanced image optimization with intelligent format selection and adaptive compression',\r\n                version: '2.0.0'\r\n            },\r\n            LemGendaryRename: {\r\n                name: 'LemGendaryRename',\r\n                description: 'Batch renaming'\r\n            }\r\n        },\r\n        templates: {\r\n            total: LemGendTemplates?.ALL?.length || 0,\r\n            categories: TEMPLATE_CATEGORIES?.length || 0,\r\n            platforms: PLATFORMS ? Object.keys(PLATFORMS).length : 0\r\n        },\r\n        features: [\r\n            'Smart AI cropping',\r\n            'Face detection',\r\n            'Object detection',\r\n            'Content-aware resizing',\r\n            'Advanced optimization',\r\n            'Intelligent format selection',\r\n            'Adaptive compression',\r\n            'Batch processing',\r\n            'Favicon generation',\r\n            'Multiple format support',\r\n            'Optimization-first ZIP creation',\r\n            'Flexible dimension templates',\r\n            'Variable height/width support'\r\n        ]\r\n    }\r\n}\r\n\r\n// Add favicon-specific helper functions\r\nexport async function processFaviconSet(file, options = {}) {\r\n    const {\r\n        sizes = [16, 32, 48, 64, 128, 256],\r\n        formats = ['png', 'ico'],\r\n        includeManifest = true,\r\n        includeHTML = true\r\n    } = options\r\n\r\n    const results = []\r\n    const lemGendImage = new LemGendImage(file)\r\n    await lemGendImage.load()\r\n\r\n    for (const size of sizes) {\r\n        for (const format of formats) {\r\n            const processed = await generateFaviconVariant(lemGendImage, size, format)\r\n            results.push(processed)\r\n        }\r\n    }\r\n\r\n    if (includeManifest) {\r\n        results.push(generateManifest(lemGendImage, sizes))\r\n    }\r\n\r\n    if (includeHTML) {\r\n        results.push(generateFaviconHTML(lemGendImage, sizes, formats))\r\n    }\r\n\r\n    return results\r\n}\r\n\r\nasync function generateFaviconVariant(image, size, format) {\r\n    return {\r\n        size,\r\n        format,\r\n        width: size,\r\n        height: size,\r\n        name: `favicon-${size}x${size}.${format}`\r\n    }\r\n}\r\n\r\nfunction generateManifest(image, sizes) {\r\n    return {\r\n        type: 'json',\r\n        name: 'manifest.json',\r\n        content: JSON.stringify({\r\n            name: 'App Icon',\r\n            icons: sizes.map(size => ({\r\n                src: `/favicon-${size}x${size}.png`,\r\n                sizes: `${size}x${size}`,\r\n                type: 'image/png'\r\n            }))\r\n        }, null, 2)\r\n    }\r\n}\r\n\r\nfunction generateFaviconHTML(image, sizes, formats) {\r\n    const htmlLines = [\r\n        '<!-- Favicon tags for HTML -->',\r\n        '<link rel=\"icon\" href=\"/favicon.ico\" sizes=\"any\">'\r\n    ]\r\n\r\n    for (const size of sizes) {\r\n        for (const format of formats) {\r\n            if (format === 'png') {\r\n                htmlLines.push(`<link rel=\"icon\" type=\"image/png\" sizes=\"${size}x${size}\" href=\"/favicon-${size}x${size}.png\">`)\r\n            }\r\n        }\r\n    }\r\n\r\n    htmlLines.push('<link rel=\"apple-touch-icon\" href=\"/apple-touch-icon.png\">')\r\n    htmlLines.push('<link rel=\"manifest\" href=\"/manifest.json\">')\r\n\r\n    return {\r\n        type: 'html',\r\n        name: 'favicon-tags.html',\r\n        content: htmlLines.join('\\n')\r\n    }\r\n}\r\n\r\n/**\r\n * Process images using a template (connects task validation with template processing)\r\n * @param {LemGendImage} image - Image to process\r\n * @param {string} templateId - Template ID to apply\r\n * @param {Object} options - Template options\r\n * @returns {Promise<Object>} Template processing result\r\n */\r\nexport async function processWithTemplate(image, templateId, options = {}) {\r\n    try {\r\n        // Get template from templates system\r\n        const template = getTemplateById(templateId)\r\n        if (!template) {\r\n            throw new Error(`Template not found: ${templateId}`)\r\n        }\r\n\r\n        // Check template compatibility with image\r\n        const compatibility = validateTemplateCompatibility(template, {\r\n            width: image.width,\r\n            height: image.height\r\n        })\r\n\r\n        if (!compatibility.compatible) {\r\n            throw new Error(`Template incompatible: ${compatibility.errors.map(e => e.message).join(', ')}`)\r\n        }\r\n\r\n        // Create a task from template\r\n        const task = new LemGendTask(`Template: ${template.displayName}`, template.description)\r\n\r\n        // Parse template dimensions\r\n        const widthInfo = parseDimension(template.width)\r\n        const heightInfo = parseDimension(template.height)\r\n\r\n        // Add appropriate steps based on template\r\n        if (!widthInfo.isVariable && !heightInfo.isVariable) {\r\n            // Fixed dimensions template\r\n            const aspect = widthInfo.value / heightInfo.value\r\n            const imageAspect = image.width / image.height\r\n\r\n            if (Math.abs(aspect - imageAspect) > 0.1) {\r\n                // Aspect ratio mismatch - need to crop\r\n                task.addCrop(widthInfo.value, heightInfo.value, 'smart')\r\n            } else {\r\n                // Aspect ratio matches - just resize\r\n                task.addResize(Math.max(widthInfo.value, heightInfo.value), 'longest')\r\n            }\r\n        } else if (widthInfo.isVariable && !heightInfo.isVariable) {\r\n            // Flexible width, fixed height\r\n            task.addResize(heightInfo.value, 'height')\r\n        } else if (!widthInfo.isVariable && heightInfo.isVariable) {\r\n            // Fixed width, flexible height\r\n            task.addResize(widthInfo.value, 'width')\r\n        }\r\n\r\n        // Add optimization\r\n        task.addOptimize(85, 'auto', {\r\n            compressionMode: 'adaptive',\r\n            preserveTransparency: template.recommendedFormats.includes('png') || template.recommendedFormats.includes('svg')\r\n        })\r\n\r\n        // Process the image\r\n        const results = await lemGendaryProcessBatch([image], task)\r\n\r\n        if (results.length === 0 || !results[0].success) {\r\n            throw new Error('Template processing failed')\r\n        }\r\n\r\n        return {\r\n            success: true,\r\n            template,\r\n            image: results[0].image,\r\n            file: results[0].file,\r\n            compatibility,\r\n            warnings: compatibility.warnings\r\n        }\r\n    } catch (error) {\r\n        console.error('Template processing failed:', error)\r\n        return {\r\n            success: false,\r\n            error: error.message,\r\n            templateId\r\n        }\r\n    }\r\n}\r\n\r\n/**\r\n * Process flexible dimension template\r\n * @param {LemGendImage} image - Image to process\r\n * @param {Object} template - Template with flexible dimensions\r\n * @param {Object} options - Processing options\r\n * @returns {Promise<Object>} Processing result\r\n */\r\nexport async function processFlexibleTemplate(image, template, options = {}) {\r\n    const widthInfo = parseDimension(template.width)\r\n    const heightInfo = parseDimension(template.height)\r\n\r\n    const task = new LemGendTask(`Flexible: ${template.displayName}`, template.description)\r\n\r\n    if (widthInfo.isVariable && !heightInfo.isVariable) {\r\n        // Fixed height, flexible width - maintain aspect ratio\r\n        const scale = heightInfo.value / image.height\r\n        const targetWidth = Math.round(image.width * scale)\r\n        task.addResize(heightInfo.value, 'height')\r\n    } else if (!widthInfo.isVariable && heightInfo.isVariable) {\r\n        // Fixed width, flexible height - maintain aspect ratio\r\n        const scale = widthInfo.value / image.width\r\n        const targetHeight = Math.round(image.height * scale)\r\n        task.addResize(widthInfo.value, 'width')\r\n    } else if (widthInfo.isVariable && heightInfo.isVariable) {\r\n        // Both dimensions flexible - just optimize\r\n        task.addOptimize(85, 'auto')\r\n    }\r\n\r\n    const results = await lemGendaryProcessBatch([image], task)\r\n    return results[0] || { success: false, error: 'Processing failed' }\r\n}\r\n\r\n// Default export for convenience\r\nexport default {\r\n    // Core classes\r\n    LemGendImage,\r\n    LemGendTask,\r\n\r\n    // Processors\r\n    LemGendaryResize,\r\n    LemGendaryCrop,\r\n    LemGendaryOptimize,\r\n    LemGendaryRename,\r\n\r\n    // Main functions\r\n    lemGendaryProcessBatch,\r\n    lemGendBuildZip,\r\n    getLibraryInfo,\r\n    processFaviconSet,\r\n    optimizeForZip,\r\n    createOptimizedZip,\r\n    processWithTemplate,\r\n    processFlexibleTemplate,\r\n\r\n    // Templates\r\n    LemGendTemplates,\r\n    TEMPLATE_CATEGORIES,\r\n    PLATFORMS,\r\n    getTemplatesByPlatform,\r\n    getTemplatesByCategory,\r\n    getTemplateById,\r\n    getTemplatesByDimensions,\r\n    getRecommendedTemplates,\r\n    getTemplateStats,\r\n    exportTemplates,\r\n    validateTemplate,\r\n    addCustomTemplate,\r\n    getAllPlatforms,\r\n    getTemplatesGroupedByPlatform,\r\n    searchTemplates,\r\n    getTemplateAspectRatio,\r\n    getFlexibleTemplates,\r\n    getTemplatesForImage,\r\n    isVariableDimension,\r\n    parseDimension,\r\n\r\n    // Utilities\r\n    createLemGendaryZip,\r\n    createSimpleZip,\r\n    extractZip,\r\n    getZipInfo,\r\n    createZipWithProgress,\r\n\r\n    // Image utils\r\n    getImageDimensions,\r\n    hasTransparency,\r\n    fileToDataURL,\r\n    dataURLtoFile,\r\n    resizeImage,\r\n    cropImage,\r\n    calculateAspectRatioFit,\r\n    formatFileSize,\r\n    getFileExtension,\r\n    validateImageFile,\r\n    createThumbnail,\r\n    batchProcess,\r\n\r\n    // Validation\r\n    ValidationErrors,\r\n    ValidationWarnings,\r\n    validateImage,\r\n    validateDimensions,\r\n    validateResize,\r\n    validateCrop,\r\n    validateOptimization,\r\n    validateRenamePattern,\r\n    getValidationSummary,\r\n    validateOptimizationOptions,\r\n    validateTemplateCompatibility\r\n}"],"names":["LemGendImage","file","options","__publicField","error","analysis","score","megapixels","text","svgDoc","svgElement","widthAttr","heightAttr","viewBox","x","y","vbWidth","vbHeight","lengthStr","match","value","unit","svgText","indicator","resolve","reject","img","canvas","ctx","data","i","width","height","operation","details","format","template","output","reader","recommendations","newWidth","newHeight","mbSize","estimatedSize","areaReduction","savings","summary","info","threshold","useCase","presets","clone","maxSize","objectUrl","thumbnail","LemGendTask","name","description","processor","validProcessors","step","validatedOptions","a","b","size","validBrowserSupport","support","ph","dimension","mode","additionalOptions","quality","pattern","templateId","sizes","formats","identifier","index","idx","enabled","lemGendImage","enabledSteps","image","minSize","validFormats","upscale","confidenceThreshold","aspect","optimizationValidation","validateOptimizationOptions","warning","ValidationWarnings","preserveExtension","hasFaviconStep","s","hasSmartCrop","hasOptimization","optimizationStep","hasResize","hasCrop","hasOptimize","optimizeSteps","renameIndex","faviconIndex","stepsBefore","hasResizeBefore","hasCropBefore","faviconStep","optimizeStep","errorCount","warningCount","processorCount","taskType","hasAutoOptimization","compressionMode","count","stepNum","cropDesc","formatStr","optimizeDesc","sizeCount","formatCount","imageCount","stepTimes","totalMs","complexityFactor","baseTime","ms","minutes","seconds","mimeType","hasFavicon","compatible","warnings","errors","config","task","stepConfig","lastStep","templateName","_actuallyResizeImage","targetWidth","targetHeight","algorithm","blob","resizedFile","_actuallyCropImage","originalWidth","originalHeight","cropWidth","cropHeight","offsetX","offsetY","croppedFile","_getFileExtension","processSingleFile","loadError","validation","errorMessage","e","currentFile","currentDimensions","processingOrder","sortedSteps","indexA","indexB","resizeResult","LemGendaryResize","cropResult","LemGendaryCrop","optimizeProcessor","LemGendaryOptimize","optimizeResult","renameResult","LemGendaryRename","extension","outputFormat","lemGendaryProcessBatch","files","onProgress","onWarning","onError","parallel","maxParallel","results","totalFiles","taskValidation","batches","batchIndex","batch","batchPromises","fileIndex","result","errorResult","progress","r","optimizeForZip","images","optimizationOptions","optimizer","optimizationResult","optimizedFile","optimizedLemGendImage","createOptimizedZip","optimization","zipOptions","includeReport","lemGendImages","lemGendImg","optimizationResults","successful","failed","optimizedImages","optimizedImage","report","reportFile","reportImage","createLemGendaryZip","lemGendBuildZip","processedResults","getLibraryInfo","LemGendTemplates","TEMPLATE_CATEGORIES","PLATFORMS","processFaviconSet","includeManifest","includeHTML","processed","generateFaviconVariant","generateManifest","generateFaviconHTML","htmlLines","processWithTemplate","getTemplateById","compatibility","validateTemplateCompatibility","widthInfo","parseDimension","heightInfo","imageAspect","processFlexibleTemplate","scale","getTemplatesByPlatform","getTemplatesByCategory","getTemplatesByDimensions","getRecommendedTemplates","getTemplateStats","exportTemplates","validateTemplate","addCustomTemplate","getAllPlatforms","getTemplatesGroupedByPlatform","searchTemplates","getTemplateAspectRatio","getFlexibleTemplates","getTemplatesForImage","isVariableDimension","createSimpleZip","extractZip","getZipInfo","createZipWithProgress","getImageDimensions","hasTransparency","fileToDataURL","dataURLtoFile","resizeImage","cropImage","calculateAspectRatioFit","formatFileSize","getFileExtension","validateImageFile","createThumbnail","batchProcess","ValidationErrors","validateImage","validateDimensions","validateResize","validateCrop","validateOptimization","validateRenamePattern","getValidationSummary"],"mappings":"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"}