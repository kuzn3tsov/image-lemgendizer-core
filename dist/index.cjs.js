"use strict";var P=Object.defineProperty;var W=(m,e,t)=>e in m?P(m,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):m[e]=t;var l=(m,e,t)=>W(m,typeof e!="symbol"?e+"":e,t);Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});const u=require("./validation-DU-FiGJX.cjs"),z=require("./LemGendaryRename-wKbMw7Xe.cjs"),h=require("./templates/index.cjs.js"),g=require("./utils/index.cjs.js");class v{constructor(e,t={}){l(this,"load",async()=>{try{return this.type==="image/svg+xml"?await this._loadSVG():this.type==="image/x-icon"||this.type==="image/vnd.microsoft.icon"?await this._loadFavicon():await this._loadRaster(),this.width&&this.height&&(this.aspectRatio=this.width/this.height,this.orientation=this.width>=this.height?"landscape":"portrait"),this.metadata.originalDimensions={width:this.width,height:this.height,orientation:this.orientation,aspectRatio:this.aspectRatio},await this._analyzeForOptimization(),(this.type==="image/png"||this.type==="image/webp"||this.type.includes("icon"))&&await this._checkTransparency(),this}catch(e){throw new Error(`Failed to load image: ${e.message}`)}});l(this,"_analyzeForOptimization",async()=>{const e={fileSize:this.originalSize,dimensions:{width:this.width,height:this.height},aspectRatio:this.aspectRatio,orientation:this.orientation,mimeType:this.type,extension:this.extension,optimizationScore:0,recommendations:[]};let t=0;this.originalSize>5*1024*1024?(t+=40,e.recommendations.push("File is very large - high optimization potential")):this.originalSize>1*1024*1024?t+=20:this.originalSize>100*1024&&(t+=10);const i=this.width*this.height/1e6;return i>16?(t+=30,e.recommendations.push("Very high resolution - consider resizing")):i>4&&(t+=15),["webp","avif","svg"].includes(this.extension)||(t+=20,e.recommendations.push(`Consider converting from ${this.extension} to modern format`)),this.optimizationScore=Math.min(100,t),this.optimizationRecommendations=e.recommendations,this.metadata.analysis=e,this.metadata.optimizationLevel=t>50?"high":t>25?"medium":"low",e});l(this,"_loadFavicon",async()=>{try{return this.width=32,this.height=32,this.aspectRatio=1,this.orientation="square",this.metadata.favicon=!0,this.metadata.possibleSizes=[16,32,48,64,128,256],this}catch(e){throw new Error(`Failed to load favicon: ${e.message}`)}});l(this,"_loadSVG",async()=>{try{const e=await this.file.text(),i=new DOMParser().parseFromString(e,"image/svg+xml"),s=i.documentElement;if(i.querySelector("parsererror"))throw new Error("Invalid SVG format");const a=s.getAttribute("width"),o=s.getAttribute("height"),r=s.getAttribute("viewBox");if(a&&o)this.width=this._parseSVGLength(a),this.height=this._parseSVGLength(o);else if(r){const[c,f,p,d]=r.split(/\s+|,/).map(parseFloat);this.width=p||100,this.height=d||100}else this.width=100,this.height=100;this._svgDocument=i,this.metadata.svgContent=e,this.metadata.svgElement=s,this.transparency=this._checkSVGTransparency(e)}catch(e){throw new Error(`Failed to load SVG: ${e.message}`)}});l(this,"_parseSVGLength",e=>{const t=e.match(/^([\d.]+)(px|pt|pc|mm|cm|in|em|ex|%)?$/);if(!t)return 100;const i=parseFloat(t[1]),s=t[2]||"px";return i*({px:1,pt:1.33,pc:16,mm:3.78,cm:37.8,in:96,em:16,ex:8,"%":i}[s]||1)});l(this,"_checkSVGTransparency",e=>['fill="none"','fill="transparent"',"fill-opacity","opacity=","rgba(","hsla(","fill:#00000000","fill:transparent","stroke-opacity","stop-opacity"].some(i=>e.includes(i)));l(this,"_loadRaster",async()=>new Promise((e,t)=>{const i=new Image;i.onload=()=>{this.width=i.naturalWidth||i.width,this.height=i.naturalHeight||i.height,this._imageElement=i,this._objectURL=i.src,e(this)},i.onerror=()=>{t(new Error("Failed to load raster image"))},i.src=URL.createObjectURL(this.file)}));l(this,"_checkTransparency",async()=>new Promise(e=>{const t=new Image;t.onload=()=>{const i=document.createElement("canvas");i.width=t.width,i.height=t.height;const s=i.getContext("2d");s.drawImage(t,0,0);const a=s.getImageData(0,0,i.width,i.height).data;for(let o=3;o<a.length;o+=4)if(a[o]<255){this.transparency=!0,e(!0);return}this.transparency=!1,e(!1)},t.onerror=()=>{this.transparency=!1,e(!1)},t.src=URL.createObjectURL(this.file)}));l(this,"updateDimensions",(e,t)=>{if(typeof e!="number"||typeof t!="number"||e<=0||t<=0)throw new Error("Dimensions must be positive numbers");this.width=e,this.height=t,this.aspectRatio=e/t,this.orientation=e>=t?"landscape":"portrait",this.metadata.processedDimensions={width:e,height:t,aspectRatio:this.aspectRatio},this.metadata.lastModified=new Date().toISOString()});l(this,"addOperation",(e,t)=>{this.metadata.operations.push({operation:e,details:t,timestamp:new Date().toISOString(),previousDimensions:this.metadata.processedDimensions||this.metadata.originalDimensions}),e==="optimize"&&this.metadata.optimizationHistory.push({...t,timestamp:new Date().toISOString()})});l(this,"addOutput",(e,t,i=null)=>{if(!(t instanceof File))throw new TypeError("Output must be a File object");this.outputs.set(e,{file:t,format:e,template:i,dimensions:{width:this.width,height:this.height},size:t.size,addedAt:new Date().toISOString()}),this.processed=!0});l(this,"getOutput",e=>this.outputs.get(e)||null);l(this,"getAllOutputs",()=>Array.from(this.outputs.values()));l(this,"getOutputAsDataURL",async e=>{const t=this.getOutput(e);if(!t)throw new Error(`No output found for format: ${e}`);return new Promise((i,s)=>{const n=new FileReader;n.onload=()=>i(n.result),n.onerror=s,n.readAsDataURL(t.file)})});l(this,"toDataURL",async()=>new Promise((e,t)=>{const i=new FileReader;i.onload=()=>e(i.result),i.onerror=t,i.readAsDataURL(this.file)}));l(this,"getOptimizationRecommendations",()=>{const e={format:this._recommendFormat(),quality:this._recommendQuality(),resize:this._recommendResize(),warnings:this.optimizationRecommendations,suggestions:[],priority:this._getOptimizationPriority()};return this.transparency&&this.extension==="jpg"&&e.suggestions.push("JPEG format does not support transparency - consider PNG or WebP"),(this.width>4e3||this.height>4e3)&&e.suggestions.push("Image dimensions very large - consider resizing for web"),this.originalSize>10*1024*1024&&e.suggestions.push("Image is very large (>10MB) - consider aggressive compression"),e});l(this,"_recommendFormat",()=>this.type==="image/svg+xml"?"svg":this.type.includes("icon")?"ico":this.transparency?"webp":this.width*this.height>1e6?"avif":"webp");l(this,"_recommendQuality",()=>this.type==="image/svg+xml"||this.type.includes("icon")?100:this.transparency?90:this.width*this.height>2e6?80:85);l(this,"_recommendResize",()=>{if(this.width<=1920&&this.height<=1920)return null;let t,i;return this.width>=this.height?(t=Math.min(this.width,1920),i=Math.round(this.height/this.width*t)):(i=Math.min(this.height,1920),t=Math.round(this.width/this.height*i)),{width:t,height:i,reason:`Resize to ${t}x${i} for web display`}});l(this,"_getOptimizationPriority",()=>{const e=this.width*this.height/1e6,t=this.originalSize/(1024*1024);return t>10||e>16?"high":t>2||e>4?"medium":"low"});l(this,"getOptimizationSummary",()=>{const e=this.getOptimizationRecommendations();return{original:{name:this.originalName,size:this.originalSize,dimensions:`${this.width}x${this.height}`,format:this.extension,hasTransparency:this.transparency,mimeType:this.type},recommendations:e,estimatedSavings:this._estimateOptimizationSavings(e),priority:e.priority,optimizationScore:this.optimizationScore,optimizationLevel:this.metadata.optimizationLevel||"unknown"}});l(this,"_estimateOptimizationSavings",e=>{let t=this.originalSize;switch(e.format){case"webp":t*=.7;break;case"avif":t*=.6;break;case"png":t*=.9;break;case"jpg":t*=.8;break;case"svg":t*=.3;break}if(t*=e.quality/100,e.resize){const s=e.resize.width*e.resize.height/(this.width*this.height);t*=s}const i=this.originalSize-t;return{originalSize:this.originalSize,estimatedSize:Math.round(t),savings:Math.round(i),savingsPercent:Math.round(i/this.originalSize*1e3)/10}});l(this,"getInfo",()=>({id:this.id,name:this.originalName,type:this.type,originalSize:this.originalSize,width:this.width,height:this.height,orientation:this.orientation,aspectRatio:this.aspectRatio,transparency:this.transparency,processed:this.processed,outputs:this.getAllOutputs().map(e=>e.format),metadata:{...this.metadata},optimization:{score:this.optimizationScore,level:this.metadata.optimizationLevel,recommendations:this.optimizationRecommendations.length}}));l(this,"getOptimizationReport",()=>{const e=this.getOptimizationSummary(),t=this.getInfo();return{...e,imageInfo:{id:t.id,name:t.name,type:t.type,processed:t.processed},analysis:this.metadata.analysis,optimizationHistory:this.metadata.optimizationHistory,generatedAt:new Date().toISOString()}});l(this,"needsOptimization",(e=30)=>this.optimizationScore>=e);l(this,"getRecommendedSettings",(e="web")=>{const t=this.getOptimizationRecommendations(),i={web:{quality:t.quality,format:t.format,maxDisplayWidth:1920,compressionMode:"adaptive",browserSupport:["modern","legacy"]},social:{quality:90,format:"jpg",maxDisplayWidth:1080,compressionMode:"balanced",stripMetadata:!1},ecommerce:{quality:92,format:"webp",maxDisplayWidth:1200,compressionMode:"balanced",preserveTransparency:!0},print:{quality:100,format:"png",maxDisplayWidth:null,compressionMode:"balanced",lossless:!0}};return i[e]||i.web});l(this,"destroy",()=>{this._objectURL&&URL.revokeObjectURL(this._objectURL),this._imageElement?.src&&this._imageElement.src.startsWith("blob:")&&URL.revokeObjectURL(this._imageElement.src),this._imageElement=null,this._svgDocument=null,this._objectURL=null,this.outputs.clear()});l(this,"clone",()=>{const e=new v(this.file,{orientation:this.orientation,width:this.width,height:this.height});return e.metadata=JSON.parse(JSON.stringify(this.metadata)),e.transparency=this.transparency,e.aspectRatio=this.aspectRatio,e.optimizationScore=this.optimizationScore,e.optimizationRecommendations=[...this.optimizationRecommendations],e});l(this,"createThumbnail",async(e=200)=>new Promise((t,i)=>{if(this.type==="image/svg+xml"){this.toDataURL().then(t).catch(i);return}if(this.type==="image/x-icon"||this.type==="image/vnd.microsoft.icon"){t("data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iIzM4ODJlZiIvPjxjaXJjbGUgY3g9IjEwMCIgY3k9IjEwMCIgcj0iNjAiIGZpbGw9IiNmZmYiLz48Y2lyY2xlIGN4PSIxMDAiIGN5PSIxMDAiIHI9IjQwIiBmaWxsPSIjMzg4MmVmIi8+PC9zdmc+");return}const s=new Image,n=URL.createObjectURL(this.file);s.onload=()=>{let a,o;s.width>s.height?(a=e,o=Math.round(s.height/s.width*e)):(o=e,a=Math.round(s.width/s.height*e));const r=document.createElement("canvas");r.width=a,r.height=o,r.getContext("2d").drawImage(s,0,0,a,o);const f=r.toDataURL("image/jpeg",.7);URL.revokeObjectURL(n),t(f)},s.onerror=()=>{URL.revokeObjectURL(n),i(new Error("Failed to create thumbnail"))},s.src=n}));if(!(e instanceof File))throw new TypeError("LemGendImage requires a File object");this.id=`lemgend_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,this.file=e,this.originalName=e.name,this.originalSize=e.size,this.type=e.type,this.mimeType=e.type,this.extension=e.name.split(".").pop().toLowerCase(),this.extension==="ico"&&!this.type.includes("image")&&(this.type="image/x-icon",this.mimeType="image/x-icon"),this.metadata={originalDimensions:null,processedDimensions:null,operations:[],createdAt:new Date().toISOString(),lastModified:new Date().toISOString(),optimizationHistory:[],analysis:null},this.outputs=new Map,this.processed=!1,this.orientation=t.orientation||null,this.width=t.width||null,this.height=t.height||null,this.aspectRatio=null,this.transparency=null,this._imageElement=null,this._svgDocument=null,this._objectURL=null,this.optimizationScore=0,this.optimizationRecommendations=[],this.width&&this.height&&(this.aspectRatio=this.width/this.height,this.orientation=this.width>=this.height?"landscape":"portrait")}}class R{constructor(e="Untitled Task",t=""){l(this,"addStep",(e,t)=>{const i=["resize","crop","optimize","rename","template","favicon"];if(!i.includes(e))throw new Error(`Invalid processor: ${e}. Valid options: ${i.join(", ")}`);const s={id:`step_${this.steps.length+1}_${Date.now()}_${Math.random().toString(36).substr(2,4)}`,processor:e,options:this._validateStepOptions(e,t),order:this.steps.length+1,addedAt:new Date().toISOString(),enabled:!0,metadata:{requiresFavicon:e==="favicon",isBatchable:!["favicon","template"].includes(e),outputType:this._getStepOutputType(e,t),supportsOptimizationFirst:e==="optimize"}};return this.steps.push(s),this.updatedAt=new Date().toISOString(),this._updateMetadata(),this});l(this,"_validateStepOptions",(e,t)=>{const s={...{resize:{dimension:1024,mode:"longest",maintainAspectRatio:!0,upscale:!0,algorithm:"lanczos3"},crop:{width:500,height:500,mode:"smart",upscale:!1,preserveAspectRatio:!0,confidenceThreshold:70,cropToFit:!0,objectsToDetect:["person","face","car","dog","cat"]},optimize:{quality:85,format:"auto",lossless:!1,stripMetadata:!0,preserveTransparency:!0,maxDisplayWidth:null,browserSupport:["modern","legacy"],compressionMode:"adaptive",analyzeContent:!0,icoSizes:[16,32,48,64,128,256]},rename:{pattern:"{name}-{dimensions}",preserveExtension:!0,addIndex:!0,addTimestamp:!1,customSeparator:"-"},template:{templateId:null,applyToAll:!0,preserveOriginal:!1},favicon:{sizes:[16,32,48,64,128,180,192,256,512],formats:["png","ico"],generateManifest:!0,generateHTML:!0,includeAppleTouch:!0,includeAndroid:!0,roundCorners:!0,backgroundColor:"#ffffff"}}[e],...t};switch(e){case"favicon":s.sizes=[...new Set(s.sizes.sort((r,c)=>r-c))],s.sizes=s.sizes.filter(r=>r>=16&&r<=512);break;case"optimize":s.format==="jpg"&&t.preserveTransparency&&(s.format="png");const n=["modern","legacy","all"];s.browserSupport=s.browserSupport.filter(r=>n.includes(r)),s.browserSupport.length===0&&(s.browserSupport=["modern","legacy"]),["adaptive","aggressive","balanced"].includes(s.compressionMode)||(s.compressionMode="adaptive"),s.format==="avif"&&(s.quality=Math.min(63,s.quality));break;case"crop":["smart","face","object","saliency","entropy"].includes(s.mode)&&(s.confidenceThreshold=Math.max(0,Math.min(100,s.confidenceThreshold||70)),s.multipleFaces=s.multipleFaces||!1,Array.isArray(s.objectsToDetect)||(s.objectsToDetect=["person","face","car","dog","cat"]));break;case"rename":["{name}","{index}","{timestamp}","{width}","{height}","{dimensions}"].some(r=>s.pattern.includes(r))||(s.pattern="{name}-{index}");break}return s});l(this,"_getStepOutputType",(e,t)=>{switch(e){case"optimize":return t.format==="auto"?"optimized-auto":`optimized-${t.format}`;case"favicon":return"favicon-set";case"template":return"template-applied";default:return"processed"}});l(this,"addResize",(e,t="longest",i={})=>this.addStep("resize",{dimension:e,mode:t,...i}));l(this,"addCrop",(e,t,i="smart",s={})=>this.addStep("crop",{width:e,height:t,mode:i,...s}));l(this,"addSmartCrop",(e,t,i={})=>this.addStep("crop",{width:e,height:t,mode:"smart",confidenceThreshold:70,multipleFaces:!0,cropToFit:!0,...i}));l(this,"addOptimize",(e=85,t="auto",i={})=>this.addStep("optimize",{quality:e,format:t,maxDisplayWidth:i.maxDisplayWidth||null,browserSupport:i.browserSupport||["modern","legacy"],compressionMode:i.compressionMode||"adaptive",analyzeContent:i.analyzeContent!==!1,...i}));l(this,"addWebOptimization",(e={})=>this.addStep("optimize",{quality:85,format:"auto",maxDisplayWidth:1920,browserSupport:["modern","legacy"],compressionMode:"adaptive",stripMetadata:!0,preserveTransparency:!0,...e}));l(this,"addRename",(e,t={})=>this.addStep("rename",{pattern:e,...t}));l(this,"addTemplate",(e,t={})=>this.addStep("template",{templateId:e,...t}));l(this,"addFavicon",(e=[16,32,48,64,128,180,192,256,512],t=["png","ico"],i={})=>this.addStep("favicon",{sizes:e,formats:t,...i}));l(this,"removeStep",e=>{let t;return typeof e=="number"?t=e:t=this.steps.findIndex(i=>i.id===e),t>=0&&t<this.steps.length?(this.steps.splice(t,1),this.steps.forEach((i,s)=>{i.order=s+1}),this.updatedAt=new Date().toISOString(),this._updateMetadata(),!0):!1});l(this,"moveStepUp",e=>e<=0||e>=this.steps.length?!1:([this.steps[e-1],this.steps[e]]=[this.steps[e],this.steps[e-1]],this.steps.forEach((t,i)=>{t.order=i+1}),this.updatedAt=new Date().toISOString(),!0));l(this,"moveStepDown",e=>e<0||e>=this.steps.length-1?!1:([this.steps[e],this.steps[e+1]]=[this.steps[e+1],this.steps[e]],this.steps.forEach((t,i)=>{t.order=i+1}),this.updatedAt=new Date().toISOString(),!0));l(this,"setStepEnabled",(e,t=!0)=>e>=0&&e<this.steps.length?(this.steps[e].enabled=t,this.updatedAt=new Date().toISOString(),this._updateMetadata(),!0):!1);l(this,"getEnabledSteps",()=>this.steps.filter(e=>e.enabled));l(this,"getStepsByProcessor",e=>this.steps.filter(t=>t.processor===e));l(this,"hasProcessor",e=>this.getEnabledSteps().some(t=>t.processor===e));l(this,"hasOptimization",()=>this.hasProcessor("optimize"));l(this,"getOptimizationStep",()=>this.getEnabledSteps().find(e=>e.processor==="optimize")||null);l(this,"validate",async e=>{if(this.validationWarnings=[],this.validationErrors=[],!e){const i=this.getEnabledSteps();i.length===0&&this.validationWarnings.push({type:"empty_task",message:"Task has no enabled processing steps",severity:"warning"});for(const s of i)await this._validateStep(s,null);return this._validateTaskLogic(),{isValid:this.validationErrors.length===0,hasWarnings:this.validationWarnings.length>0,errors:[...this.validationErrors],warnings:[...this.validationWarnings],summary:this.getValidationSummary()}}(!e.file||!(e.file instanceof File))&&this.validationErrors.push({type:"invalid_image",message:"Image missing valid file property",severity:"error"});const t=this.getEnabledSteps();t.length===0&&this.validationWarnings.push({type:"empty_task",message:"Task has no enabled processing steps",severity:"warning"});for(const i of t)await this._validateStep(i,e);return this._validateTaskLogic(),e.file&&e.file instanceof File&&this._validateImageCompatibility(e),{isValid:this.validationErrors.length===0,hasWarnings:this.validationWarnings.length>0,errors:[...this.validationErrors],warnings:[...this.validationWarnings],summary:this.getValidationSummary()}});l(this,"_validateStep",async(e,t)=>{if(!t){switch(e.processor){case"optimize":this._validateOptimizeStep(e,null);break;case"rename":this._validateRenameStep(e);break;case"template":this._validateTemplateStep(e);break;case"favicon":this._validateFaviconStep(e,null);break;case"resize":case"crop":this._validateBasicStepOptions(e);break}return}switch(e.processor){case"resize":this._validateResizeStep(e,t);break;case"crop":this._validateCropStep(e,t);break;case"optimize":this._validateOptimizeStep(e,t);break;case"rename":this._validateRenameStep(e);break;case"template":this._validateTemplateStep(e);break;case"favicon":this._validateFaviconStep(e,t);break}});l(this,"_validateBasicStepOptions",e=>{switch(e.processor){case"resize":const{dimension:t}=e.options;t<=0&&this.validationErrors.push({type:"invalid_resize",step:e.order,message:`Resize dimension must be positive: ${t}`,severity:"error"});break;case"crop":const{width:i,height:s}=e.options;(i<=0||s<=0)&&this.validationErrors.push({type:"invalid_crop",step:e.order,message:`Crop dimensions must be positive: ${i}x${s}`,severity:"error"});break}});l(this,"_validateFaviconStep",(e,t)=>{const{sizes:i,formats:s}=e.options;if((!Array.isArray(i)||i.length===0)&&this.validationErrors.push({type:"invalid_favicon_sizes",step:e.order,message:"Favicon sizes must be a non-empty array",severity:"error"}),i.forEach(a=>{a<16&&this.validationWarnings.push({type:"small_favicon_size",step:e.order,message:`Favicon size ${a}px is below recommended minimum (16px)`,severity:"warning"}),a>1024&&this.validationWarnings.push({type:"large_favicon_size",step:e.order,message:`Favicon size ${a}px is unusually large`,severity:"info"})}),t){const a=Math.min(...i);(t.width<a||t.height<a)&&this.validationWarnings.push({type:"small_source_favicon",step:e.order,message:`Source image (${t.width}x${t.height}) smaller than smallest favicon size (${a}px)`,severity:"warning",suggestion:"Consider using a larger source image or enable upscaling"}),Math.abs(t.width/t.height-1)>.1&&this.validationWarnings.push({type:"non_square_favicon",step:e.order,message:"Source image is not square; favicons may be distorted",severity:"warning",suggestion:"Consider adding a crop step before favicon generation"})}const n=["png","ico","svg"];s.forEach(a=>{n.includes(a)||this.validationWarnings.push({type:"unsupported_favicon_format",step:e.order,message:`Unsupported favicon format: ${a}`,severity:"warning",suggestion:`Use one of: ${n.join(", ")}`})})});l(this,"_validateResizeStep",(e,t)=>{if(!t)return;const{dimension:i,mode:s,upscale:n}=e.options;i<=0&&this.validationErrors.push({type:"invalid_resize",step:e.order,message:`Resize dimension must be positive: ${i}`,severity:"error"}),i<10&&this.validationWarnings.push({type:"very_small_resize",step:e.order,message:`Resize dimension very small (${i}px)`,severity:"warning",suggestion:"Consider larger dimensions for usable output"}),i>1e4&&this.validationWarnings.push({type:"very_large_resize",step:e.order,message:`Resize dimension very large (${i}px)`,severity:"warning",suggestion:"Large dimensions may cause performance issues"}),i>Math.max(t.width,t.height)&&!n&&this.validationWarnings.push({type:"upscale_needed",step:e.order,message:`Target size (${i}px) larger than source, upscaling disabled`,severity:"warning",suggestion:"Enable upscaling or use smaller target dimension"})});l(this,"_validateCropStep",(e,t)=>{if(!t)return;const{width:i,height:s,mode:n,upscale:a,confidenceThreshold:o}=e.options;(i<=0||s<=0)&&this.validationErrors.push({type:"invalid_crop",step:e.order,message:`Crop dimensions must be positive: ${i}x${s}`,severity:"error"}),["smart","face","object"].includes(n)&&(this.validationWarnings.push({type:"ai_crop_mode",step:e.order,message:`Using AI-powered ${n} cropping`,severity:"info",suggestion:"Ensure images have clear subjects for best results"}),o<50&&this.validationWarnings.push({type:"low_confidence_threshold",step:e.order,message:`Low confidence threshold (${o}%) may result in poor detection`,severity:"warning",suggestion:"Increase confidence threshold to 70% or higher for better accuracy"})),(i<10||s<10)&&this.validationWarnings.push({type:"very_small_crop",step:e.order,message:`Crop dimensions very small (${i}x${s})`,severity:"warning",suggestion:"Consider larger crop area for usable output"});const r=i/s;(r>10||r<.1)&&this.validationWarnings.push({type:"extreme_aspect",step:e.order,message:`Extreme aspect ratio: ${r.toFixed(2)}`,severity:"warning",suggestion:"Consider more balanced dimensions"}),(i>t.width||s>t.height)&&!a&&this.validationWarnings.push({type:"crop_larger_than_source",step:e.order,message:`Crop area (${i}x${s}) larger than source (${t.width}x${t.height})`,severity:"warning",suggestion:"Enable upscaling or resize first"})});l(this,"_validateOptimizeStep",(e,t)=>{const i=u.validateOptimizationOptions(e.options);i.errors.forEach(s=>{this.validationErrors.push({type:s.code,step:e.order,message:s.message,severity:"error",suggestion:s.suggestion})}),i.warnings.forEach(s=>{this.validationWarnings.push({type:s.code,step:e.order,message:s.message,severity:"warning",suggestion:s.suggestion})}),t&&((e.options.format==="jpg"||e.options.format==="jpeg")&&(t.transparency||e.options.preserveTransparency)&&this.validationWarnings.push({type:u.ValidationWarnings.TRANSPARENCY_LOSS,step:e.order,message:"JPEG format will remove transparency",severity:"warning",suggestion:"Use PNG or WebP to preserve transparency"}),e.options.maxDisplayWidth&&(t.width>e.options.maxDisplayWidth||t.height>e.options.maxDisplayWidth)&&this.validationWarnings.push({type:"resize_optimization",step:e.order,message:`Image will be resized to ${e.options.maxDisplayWidth}px maximum dimension`,severity:"info"}),e.options.format==="avif"&&this.validationWarnings.push({type:u.ValidationWarnings.AVIF_BROWSER_SUPPORT,step:e.order,message:"AVIF format provides excellent compression but limited browser support",severity:"info",suggestion:"Consider providing WebP fallback"}),e.options.compressionMode==="aggressive"&&t.width*t.height>4e6&&this.validationWarnings.push({type:"aggressive_compression_large",step:e.order,message:"Aggressive compression on large images may take longer",severity:"info"}))});l(this,"_validateRenameStep",e=>{const{pattern:t,preserveExtension:i}=e.options;(!t||t.trim()==="")&&this.validationErrors.push({type:"empty_pattern",step:e.order,message:"Rename pattern cannot be empty",severity:"error"}),/[<>:"/\\|?*\x00-\x1F]/.test(t)&&this.validationErrors.push({type:"invalid_pattern_chars",step:e.order,message:"Pattern contains invalid filename characters",severity:"error",suggestion:'Remove <>:"/\\|?* and control characters from pattern'}),!t.includes("{name}")&&!t.includes("{index}")&&this.validationWarnings.push({type:"no_unique_placeholder",step:e.order,message:"Pattern may create duplicate filenames",severity:"warning",suggestion:"Include {index} or {timestamp} for unique filenames"})});l(this,"_validateTemplateStep",e=>{const{templateId:t}=e.options;t||this.validationErrors.push({type:"missing_template",step:e.order,message:"Template ID is required",severity:"error"})});l(this,"_validateImageCompatibility",e=>{const t=this.getEnabledSteps(),i=t.some(o=>o.processor==="favicon"),s=t.some(o=>o.processor==="crop"&&["smart","face","object"].includes(o.options.mode)),n=t.some(o=>o.processor==="optimize");if(i&&(e.type==="image/svg+xml"&&this.validationWarnings.push({type:"svg_favicon",message:"SVG images may not convert well to favicon formats",severity:"warning",suggestion:"Consider using raster image for favicon generation"}),e.type.includes("gif")&&this.validationWarnings.push({type:"animated_favicon",message:"Animated GIFs will lose animation in favicon conversion",severity:"info"})),s&&(e.width<200||e.height<200)&&this.validationWarnings.push({type:"small_image_smart_crop",message:"Smart crop works best with images larger than 200x200 pixels",severity:"warning",suggestion:"Consider resizing before smart crop or use larger source images"}),n){const o=t.find(r=>r.processor==="optimize");o&&o.options.format==="auto"&&this.validationWarnings.push({type:"auto_format_selection",message:"Format will be automatically selected based on image content and browser support",severity:"info"})}Math.min(e.width,e.height)<100&&this.validationWarnings.push({type:"low_resolution",message:`Source image resolution low (${e.width}x${e.height})`,severity:"warning",suggestion:"Consider using higher resolution source for better quality"})});l(this,"_validateTaskLogic",()=>{const e=this.getEnabledSteps(),t=e.some(c=>c.processor==="resize"),i=e.some(c=>c.processor==="crop"),s=e.some(c=>c.processor==="optimize");i&&!t&&this.validationWarnings.push({type:"crop_without_resize",message:"Crop without resize may result in unexpected output",severity:"info",suggestion:"Consider adding resize step before crop for better control"});const n=e.filter(c=>c.processor==="optimize");n.length>1&&this.validationWarnings.push({type:"multiple_optimize",message:`Multiple optimization steps (${n.length})`,severity:"warning",suggestion:"Multiple optimizations may degrade quality unnecessarily"});const a=e.findIndex(c=>c.processor==="rename");a>=0&&a<e.length-2&&this.validationWarnings.push({type:"early_rename",message:"Rename step placed before other operations",severity:"info",suggestion:"Consider moving rename to end to reflect final output"});const o=e.findIndex(c=>c.processor==="favicon");if(o>=0){const c=e.slice(0,o),f=c.some(d=>d.processor==="resize"),p=c.some(d=>d.processor==="crop");!f&&!p&&this.validationWarnings.push({type:"favicon_without_preparation",message:"Favicon generation without prior resize/crop",severity:"warning",suggestion:"Add resize/crop step before favicon for optimal results"})}e.filter(c=>c.processor==="favicon").forEach(c=>{e.filter(p=>p.processor==="optimize").some(p=>p.order>c.order)&&this.validationWarnings.push({type:"optimize_after_favicon",message:"Optimization after favicon generation may affect favicon quality",severity:"warning",suggestion:"Move optimization step before favicon generation"})}),s&&!t&&!i&&this.validationWarnings.push({type:"optimization_only",message:"Task contains only optimization step",severity:"info",suggestion:"Consider adding resize/crop steps for complete image processing"})});l(this,"getValidationSummary",()=>{const e=this.getEnabledSteps(),t=this.validationErrors.length,i=this.validationWarnings.length,s={};e.forEach(r=>{s[r.processor]=(s[r.processor]||0)+1});let n="general";e.some(r=>r.processor==="favicon")?n="favicon":e.some(r=>r.processor==="template")?n="template":e.every(r=>["resize","crop","optimize"].includes(r.processor))?n="basic":e.length===1&&e[0].processor==="optimize"&&(n="optimization-only");const a=e.some(r=>r.processor==="crop"&&["smart","face","object"].includes(r.options.mode)),o=e.some(r=>r.processor==="optimize"&&r.options.format==="auto");return{totalSteps:e.length,enabledSteps:e.length,disabledSteps:this.steps.length-e.length,errorCount:t,warningCount:i,processorCount:s,taskType:n,status:t>0?"invalid":i>0?"has_warnings":"valid",canProceed:t===0,requiresImage:e.some(r=>["resize","crop","optimize","favicon"].includes(r.processor)),hasFavicon:s.favicon>0,hasSmartCrop:a,hasAutoOptimization:o,estimatedOutputs:this._estimateOutputCount(),optimizationLevel:this._getOptimizationLevel()}});l(this,"_getOptimizationLevel",()=>{const e=this.getEnabledSteps().find(n=>n.processor==="optimize");if(!e)return"none";const{compressionMode:t,quality:i,format:s}=e.options;return t==="aggressive"&&i<70?"aggressive":t==="adaptive"||i>=70&&i<=90?"balanced":t==="balanced"&&i>90?"high-quality":"standard"});l(this,"_estimateOutputCount",()=>{const e=this.getEnabledSteps();let t=1;return e.forEach(i=>{if(i.processor==="favicon"){const{sizes:s=[],formats:n=[]}=i.options;t+=s.length*n.length,i.options.generateManifest&&t++,i.options.generateHTML&&t++,i.options.includeAppleTouch&&t++,i.options.includeAndroid&&t++}else if(i.processor==="optimize"){const{format:s}=i.options;Array.isArray(s)&&(t+=s.length-1)}}),t});l(this,"getDescription",()=>{const e=this.getEnabledSteps();return e.length===0?"No processing steps configured":e.map((t,i)=>{const s=i+1,n=t.processor.charAt(0).toUpperCase()+t.processor.slice(1);switch(t.processor){case"resize":return`${s}. LemGendaryResize™ to ${t.options.dimension}px (${t.options.mode})`;case"crop":const{mode:a,width:o,height:r}=t.options;let c=`${s}. LemGendaryCrop™ to ${o}×${r}`;return["smart","face","object","saliency","entropy"].includes(a)?c+=` (AI ${a} mode)`:c+=` (${a})`,c;case"optimize":const f=t.options.format==="auto"?"auto (intelligent selection)":t.options.format.toUpperCase();let p=`${s}. LemGendaryOptimize™ to ${f} (${t.options.quality}%)`;return t.options.maxDisplayWidth&&(p+=`, max ${t.options.maxDisplayWidth}px`),t.options.compressionMode&&t.options.compressionMode!=="adaptive"&&(p+=`, ${t.options.compressionMode} compression`),t.options.browserSupport&&(p+=`, ${t.options.browserSupport.join("+")} browsers`),p;case"rename":return`${s}. Rename with pattern: "${t.options.pattern}"`;case"template":return`${s}. Apply template: ${t.options.templateId}`;case"favicon":const d=t.options.sizes?.length||0,y=t.options.formats?.length||0;return`${s}. Generate favicon set (${d} sizes, ${y} formats)`;default:return`${s}. ${n}`}}).join(`
`)});l(this,"getTimeEstimate",(e=1)=>{const t=this.getEnabledSteps(),i={resize:100,crop:150,optimize:200,rename:10,template:300,favicon:500};let s=0,n=1;return t.forEach(a=>{const o=i[a.processor]||100;if(a.processor==="favicon"){const r=a.options.sizes?.length||1,c=a.options.formats?.length||1;n=r*c}else a.processor==="crop"&&["smart","face","object"].includes(a.options.mode)?n=3:a.processor==="optimize"&&(a.options.compressionMode==="aggressive"&&(n=1.5),a.options.analyzeContent&&(n*=1.2));s+=o*n}),s*=e,{perImage:s/e,total:s,formatted:this._formatTime(s),stepCount:t.length,imageCount:e,complexityFactor:Math.round(n*10)/10}});l(this,"_formatTime",e=>{if(e<1e3)return`${Math.round(e)}ms`;if(e<6e4)return`${(e/1e3).toFixed(1)}s`;const t=Math.floor(e/6e4),i=Math.round(e%6e4/1e3);return`${t}m ${i}s`});l(this,"exportConfig",()=>({id:this.id,name:this.name,description:this.description,version:"2.2.0",steps:this.steps.map(e=>({id:e.id,processor:e.processor,options:{...e.options},enabled:e.enabled,order:e.order,metadata:e.metadata})),metadata:{...this.metadata},createdAt:this.createdAt,updatedAt:this.updatedAt,validation:{warnings:this.validationWarnings,errors:this.validationErrors}}));l(this,"_updateMetadata",()=>{const e=this.getEnabledSteps();this.metadata.estimatedDuration=this.getTimeEstimate().total,this.metadata.estimatedOutputs=this._estimateOutputCount(),this.metadata.stepCount=e.length;const t={};e.forEach(i=>{t[i.processor]=(t[i.processor]||0)+1}),this.metadata.processorCount=t,t.favicon>0?this.metadata.category="favicon":t.template>0?this.metadata.category="template":t.optimize>0&&t.resize===0&&t.crop===0?this.metadata.category="optimization-only":this.metadata.category="general",this.metadata.hasSmartCrop=e.some(i=>i.processor==="crop"&&["smart","face","object"].includes(i.options.mode)),this.metadata.hasAutoOptimization=e.some(i=>i.processor==="optimize"&&i.options.format==="auto")});l(this,"clone",()=>R.importConfig(this.exportConfig()));l(this,"toSimpleObject",()=>{const e=this.getValidationSummary();return{id:this.id,name:this.name,description:this.description,stepCount:this.steps.length,enabledStepCount:this.getEnabledSteps().length,hasFavicon:e.hasFavicon,hasSmartCrop:e.hasSmartCrop,hasAutoOptimization:e.hasAutoOptimization,taskType:e.taskType,status:e.status,canProceed:e.canProceed,estimatedOutputs:e.estimatedOutputs,optimizationLevel:e.optimizationLevel,createdAt:this.createdAt,updatedAt:this.updatedAt}});l(this,"checkCompatibility",e=>{const t=this.getEnabledSteps(),i=t.some(c=>c.processor==="favicon"),s=t.some(c=>c.processor==="crop"&&["smart","face","object"].includes(c.options.mode)),n=t.some(c=>c.processor==="optimize");let a=!0;const o=[],r=[];return e==="image/svg+xml"&&(i&&o.push("SVG to favicon conversion may not preserve all features"),s&&o.push("SVG images will be rasterized before smart cropping")),e==="image/gif"&&(i&&o.push("Animated GIFs will lose animation in favicon conversion"),s&&o.push("Smart crop will use first frame of animated GIF"),n&&o.push("GIF optimization may reduce animation quality")),(e==="image/x-icon"||e==="image/vnd.microsoft.icon")&&o.push("ICO files contain multiple images; processing may use first frame only"),{compatible:a,warnings:o,errors:r,recommended:o.length===0&&r.length===0}});this.id=`task_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,this.name=e,this.description=t,this.steps=[],this.validationWarnings=[],this.validationErrors=[],this.createdAt=new Date().toISOString(),this.updatedAt=new Date().toISOString(),this.metadata={version:"2.2.0",processorVersions:{resize:"1.2.1",crop:"2.0.0",optimize:"2.0.0",rename:"1.0.0",template:"1.3.0",favicon:"2.0.0"},estimatedDuration:null,estimatedOutputs:0,supportsFavicon:!0,supportsSVG:!0,supportsAICropping:!0,maxBatchSize:50,defaultResizeMode:"longest",supportsOptimizationFirst:!0,optimizationModes:["adaptive","aggressive","balanced"]}}static importConfig(e){const t=new R(e.name,e.description);return t.id=e.id||t.id,t.createdAt=e.createdAt||t.createdAt,t.updatedAt=e.updatedAt||t.updatedAt,t.metadata=e.metadata||t.metadata,t.validationWarnings=e.validation?.warnings||[],t.validationErrors=e.validation?.errors||[],e.steps?.forEach(i=>{t.addStep(i.processor,i.options);const s=t.steps[t.steps.length-1];s.enabled=i.enabled!==!1,s.id=i.id||s.id,s.metadata=i.metadata||s.metadata}),t}static fromTemplate(e){const i={"web-optimized":{name:"Web Optimization",description:"Optimize images for web with modern formats",steps:[{processor:"resize",options:{dimension:1920,mode:"longest"}},{processor:"optimize",options:{quality:85,format:"auto",compressionMode:"adaptive"}},{processor:"rename",options:{pattern:"{name}-{width}w"}}]},"social-media":{name:"Social Media Posts",description:"Prepare images for social media platforms",steps:[{processor:"resize",options:{dimension:1080,mode:"longest"}},{processor:"crop",options:{width:1080,height:1080,mode:"smart",confidenceThreshold:70,multipleFaces:!0}},{processor:"optimize",options:{quality:90,format:"auto",compressionMode:"balanced"}}]},"portrait-smart":{name:"Smart Portrait Cropping",description:"AI-powered portrait cropping with face detection",steps:[{processor:"resize",options:{dimension:1080,mode:"longest"}},{processor:"crop",options:{width:1080,height:1350,mode:"face",confidenceThreshold:80,preserveAspectRatio:!0}},{processor:"optimize",options:{quality:95,format:"auto",compressionMode:"adaptive"}}]},"product-showcase":{name:"Product Showcase",description:"Smart cropping for product images",steps:[{processor:"resize",options:{dimension:1200,mode:"longest"}},{processor:"crop",options:{width:1200,height:1200,mode:"object",objectsToDetect:["product","item"],confidenceThreshold:75}},{processor:"optimize",options:{quality:90,format:"auto",compressionMode:"balanced"}}]},"favicon-package":{name:"Favicon Package",description:"Generate complete favicon set for all devices",steps:[{processor:"resize",options:{dimension:512,mode:"longest"}},{processor:"crop",options:{width:512,height:512,mode:"smart",confidenceThreshold:70}},{processor:"favicon",options:{sizes:[16,32,48,64,128,180,192,256,512],formats:["png","ico"],generateManifest:!0,generateHTML:!0}},{processor:"rename",options:{pattern:"{name}-favicon-{size}"}}]},"optimization-only":{name:"Optimization Only",description:"Optimize images without resizing or cropping",steps:[{processor:"optimize",options:{quality:85,format:"auto",maxDisplayWidth:1920,compressionMode:"adaptive",browserSupport:["modern","legacy"]}}]}}[e];if(!i)throw new Error(`Unknown template: ${e}`);return R.importConfig(i)}}async function k(m,e,t,i="lanczos3"){return new Promise((s,n)=>{const a=new Image;a.onload=()=>{try{const o=document.createElement("canvas");o.width=e,o.height=t;const r=o.getContext("2d");if(!r){n(new Error("Canvas context not supported"));return}r.imageSmoothingEnabled=!0,r.imageSmoothingQuality="high",r.drawImage(a,0,0,e,t),o.toBlob(c=>{if(!c){n(new Error("Failed to create blob from canvas"));return}const f=new File([c],m.name,{type:m.type});URL.revokeObjectURL(a.src),s(f)},m.type,.95)}catch(o){URL.revokeObjectURL(a.src),n(new Error(`Resize failed: ${o.message}`))}},a.onerror=()=>{n(new Error("Failed to load image for resizing"))},a.src=URL.createObjectURL(m)})}async function j(m,e,t,i,s,n,a){return new Promise((o,r)=>{const c=new Image;c.onload=()=>{try{const f=document.createElement("canvas");f.width=i,f.height=s;const p=f.getContext("2d");if(!p){r(new Error("Canvas context not supported"));return}p.drawImage(c,n,a,i,s,0,0,i,s),f.toBlob(d=>{if(!d){r(new Error("Failed to create blob from canvas"));return}const y=new File([d],m.name,{type:m.type});URL.revokeObjectURL(c.src),o(y)},m.type,.95)}catch(f){URL.revokeObjectURL(c.src),r(new Error(`Crop failed: ${f.message}`))}},c.onerror=()=>{r(new Error("Failed to load image for cropping"))},c.src=URL.createObjectURL(m)})}function L(m){return m.name.split(".").pop().toLowerCase()}async function E(m,e,t){console.log("processSingleFile called with:",{fileType:m?.constructor?.name,isLemGendImage:m instanceof v,hasFileProperty:!!m?.file,filePropertyType:m?.file?.constructor?.name});let i;try{if(m instanceof v){if(i=m,console.log("Using existing LemGendImage:",{hasFile:!!i.file,fileType:i.file?.constructor?.name,width:i.width,height:i.height,originalName:i.originalName}),!i.file||!(i.file instanceof File))throw console.warn("LemGendImage missing valid file property"),new Error("LemGendImage has no valid file property");if(!i.width||!i.height)try{console.log("LemGendImage missing dimensions, loading..."),await i.load()}catch(p){throw console.warn("Failed to load existing LemGendImage:",p),new Error(`Failed to load LemGendImage: ${p.message}`)}}else if(m&&m.file&&m.file instanceof File)console.log("Creating new LemGendImage from file object..."),i=new v(m.file),await i.load();else if(m instanceof File||m instanceof Blob)console.log("Creating new LemGendImage from File/Blob..."),i=new v(m),await i.load();else throw new Error(`Invalid file type provided for processing. Got: ${typeof m}, constructor: ${m?.constructor?.name}`);if(!i||!(i instanceof v))throw new Error("Failed to create valid LemGendImage instance");if(!i.file||!(i.file instanceof File))throw new Error("LemGendImage missing file property");if(!i.width||!i.height)throw new Error("LemGendImage missing dimensions");console.log("Validating task with LemGendImage...",{originalName:i.originalName,width:i.width,height:i.height,hasFile:!!i.file,fileType:i.file?.constructor?.name});const s=await e.validate(i);if(!s.isValid){const p=s.errors.map(d=>d.message).join(", ");throw console.error("Task validation failed:",p),new Error(`Task validation failed: ${p}`)}console.log("Task validation passed successfully");const n=e.getEnabledSteps();let a=i.file,o={width:i.width,height:i.height};const r=["resize","crop","optimize","rename"],c=n.sort((p,d)=>{const y=r.indexOf(p.processor),T=r.indexOf(d.processor);return y-T});console.log("Processing steps in order:",c.map(p=>`${p.order}.${p.processor}`)),console.log("Starting image dimensions:",o);for(const p of c)try{switch(console.log(`
=== Processing step ${p.order}: ${p.processor} ===`),p.processor){case"resize":const y=await new z.LemGendaryResize(p.options).process(i);console.log("Resize result:",{original:`${y.originalDimensions.width}x${y.originalDimensions.height}`,target:`${y.newDimensions.width}x${y.newDimensions.height}`,mode:p.options.mode,dimension:p.options.dimension}),a=await k(a,y.newDimensions.width,y.newDimensions.height,p.options.algorithm||"lanczos3"),o=y.newDimensions,i.updateDimensions(o.width,o.height),i.addOperation("resize",y),console.log(`✓ Resized to: ${o.width}x${o.height}`),console.log("File after resize:",{name:a.name,size:a.size,type:a.type});break;case"crop":const w=await new z.LemGendaryCrop(p.options).process(i,o);console.log("Crop result:",{current:`${o.width}x${o.height}`,target:`${w.finalDimensions.width}x${w.finalDimensions.height}`,mode:p.options.mode,smartCrop:w.smartCrop}),w.smartCrop&&console.log("Smart crop detected with steps:",{detection:w.steps.detection.confidence,resize:w.steps.resize,crop:w.cropOffsets}),a=await j(a,o.width,o.height,w.cropOffsets.width,w.cropOffsets.height,w.cropOffsets.x,w.cropOffsets.y),o=w.finalDimensions,i.updateDimensions(o.width,o.height),i.addOperation("crop",w),console.log(`✓ Cropped to: ${o.width}x${o.height}`),console.log("File after crop:",{name:a.name,size:a.size,type:a.type});break;case"optimize":const S=new z.LemGendaryOptimize(p.options),b=await S.process(i);console.log("Optimize result:",{format:p.options.format,quality:p.options.quality,originalFormat:b.originalInfo.format,transparency:b.originalInfo.transparency,savings:b.savings}),a=await S.applyOptimization(i),i.addOperation("optimize",b),console.log(`✓ Optimized to: ${b.optimization.selectedFormat} at ${b.optimization.compression.quality}%`),console.log("File after optimize:",{name:a.name,size:a.size,type:a.type,savings:`${b.savings.savingsPercent}%`});break;case"rename":const O=await new z.LemGendaryRename(p.options).process(i,t,e.steps.length),F=L(a);a=new File([a],`${O.newName}.${F}`,{type:a.type}),i.addOperation("rename",O),console.log(`✓ Renamed to: ${O.newName}.${F}`);break;default:console.warn(`Unknown processor: ${p.processor}`)}}catch(d){throw console.error(`Error in step ${p.order} (${p.processor}):`,d),new Error(`Step ${p.order} (${p.processor}) failed: ${d.message}`)}const f=L(a);return i.addOutput(f,a,null),console.log(`
=== Processing Complete ===`),console.log("Final result:",{originalName:i.originalName,finalName:a.name,originalSize:i.originalSize,finalSize:a.size,dimensions:`${o.width}x${o.height}`,format:f,sizeReduction:`${((i.originalSize-a.size)/i.originalSize*100).toFixed(1)}%`}),{image:i,file:a,success:!0,metadata:i.getInfo()}}catch(s){return console.error("Error in processSingleFile:",s),{image:i||m,file:i?.file||m,error:s.message,success:!1}}}async function I(m,e,t={}){const{onProgress:i=null,onWarning:s=null,onError:n=null,parallel:a=!1,maxParallel:o=4}=t,r=[],c=m.length;console.log("=== lemGendaryProcessBatch START ==="),console.log("Batch processing:",{totalFiles:c,hasTask:!!e,steps:e?.getEnabledSteps()?.length||0,options:t}),console.log("Validating task...");const f=m.length>0?await e.validate(m[0]):await e.validate();if(!f.isValid)if(console.error("Task validation failed:",f.errors),f.errors.every(d=>d.type==="invalid_image"||d.message.includes("No image provided"))&&m.length>0)console.warn("Task validation has image-related warnings but proceeding anyway...");else throw new Error(`Task validation failed: ${f.errors.map(d=>d.message).join(", ")}`);if(f.hasWarnings&&s&&f.warnings.forEach(p=>s(p)),a){const p=[];for(let d=0;d<m.length;d+=o)p.push(m.slice(d,d+o));for(let d=0;d<p.length;d++){const y=p[d],T=y.map((S,b)=>E(S,e,d*o+b));if((await Promise.allSettled(T)).forEach((S,b)=>{if(S.status==="fulfilled")r.push(S.value);else{const _={file:y[b],error:S.reason.message,success:!1};r.push(_),n&&n(S.reason,y[b])}}),i){const S=r.length/c;i(S,r.length,c)}}}else for(let p=0;p<m.length;p++)try{console.log(`
=== Processing file ${p+1}/${c} ===`);const d=m[p];console.log("File to process:",{type:d?.constructor?.name,isLemGendImage:d instanceof v,name:d?.name||d?.originalName||d?.file?.name});const y=await E(d,e,p);if(r.push(y),i){const T=(p+1)/c;i(T,p+1,c)}}catch(d){console.error(`Failed to process file ${p}:`,d);const y={file:m[p],error:d.message,success:!1};r.push(y),n&&n(d,m[p])}return console.log(`
=== Processing complete ===`),console.log("Summary:",{totalFiles:c,successful:r.filter(p=>p.success).length,failed:r.filter(p=>!p.success).length}),r.forEach((p,d)=>{p.success?console.log(`✓ File ${d+1}: ${p.image?.originalName||"Unknown"}`,{success:!0,size:p.file?.size,dimensions:p.image?`${p.image.width}x${p.image.height}`:"N/A"}):console.log(`✗ File ${d+1}: Failed`,{error:p.error,fileName:p.file?.name||"Unknown"})}),r}async function x(m,e={}){const t=new z.LemGendaryOptimize(e),i=[];for(const s of m)try{let n;s instanceof v?n=s:(n=new v(s),await n.load());const a=await t.process(n),o=await t.applyOptimization(n),r=new v(o);await r.load(),i.push({original:n,optimized:r,result:a,success:!0})}catch(n){console.error("Optimization failed:",n),i.push({original:s,error:n.message,success:!1})}return i}async function $(m,e={}){const{optimization:t={},zipOptions:i={},includeReport:s=!0}=e,n=new z.LemGendaryOptimize(t),a=await Promise.all(m.map(async d=>{if(d instanceof v)return d;{const y=new v(d);return await y.load(),y}}));console.log(`Optimizing ${a.length} images...`);const o=await n.prepareForZip(a),r=o.filter(d=>d.success),c=o.filter(d=>!d.success);if(console.log(`Optimization complete: ${r.length} successful, ${c.length} failed`),r.length===0)throw new Error("No images could be optimized");const f=r.map(d=>{const y=new v(d.optimized);return y.originalName=d.original.originalName,y});if(s){const d=n.generateOptimizationReport(o),y=new File([JSON.stringify(d,null,2)],"optimization-report.json",{type:"application/json"}),T=new v(y);T.originalName="optimization-report.json",f.push(T)}return console.log("Creating ZIP from optimized images..."),await g.createLemGendaryZip(f,{zipName:"optimized-images.zip",...i})}async function C(m,e={}){const t=m.filter(i=>i.success).map(i=>i.image);return g.createLemGendaryZip(t,e)}function D(){return{name:"LemGendary Image Processor",version:"2.2.0",description:"Batch image processing with intelligent operations, AI-powered smart cropping, and advanced optimization",author:"LemGenda",license:"MIT",homepage:"https://github.com/lemgenda/image-lemgendizer-core",processors:{LemGendaryResize:{name:"LemGendaryResize",description:"Intelligent image resizing using longest dimension",version:"1.2.1"},LemGendaryCrop:{name:"LemGendaryCrop",description:"AI-powered smart cropping with face and object detection",version:"2.0.0"},LemGendaryOptimize:{name:"LemGendaryOptimize",description:"Advanced image optimization with intelligent format selection and adaptive compression",version:"2.0.0"},LemGendaryRename:{name:"LemGendaryRename",description:"Batch renaming"}},templates:{total:h.LemGendTemplates?.ALL?.length||0,categories:h.TEMPLATE_CATEGORIES?.length||0,platforms:h.PLATFORMS?Object.keys(h.PLATFORMS).length:0},features:["Smart AI cropping","Face detection","Object detection","Content-aware resizing","Advanced optimization","Intelligent format selection","Adaptive compression","Batch processing","Favicon generation","Multiple format support","Optimization-first ZIP creation","Flexible dimension templates","Variable height/width support"]}}async function A(m,e={}){const{sizes:t=[16,32,48,64,128,256],formats:i=["png","ico"],includeManifest:s=!0,includeHTML:n=!0}=e,a=[],o=new v(m);await o.load();for(const r of t)for(const c of i){const f=await V(o,r,c);a.push(f)}return s&&a.push(U(o,t)),n&&a.push(B(o,t,i)),a}async function V(m,e,t){return{size:e,format:t,width:e,height:e,name:`favicon-${e}x${e}.${t}`}}function U(m,e){return{type:"json",name:"manifest.json",content:JSON.stringify({name:"App Icon",icons:e.map(t=>({src:`/favicon-${t}x${t}.png`,sizes:`${t}x${t}`,type:"image/png"}))},null,2)}}function B(m,e,t){const i=["<!-- Favicon tags for HTML -->",'<link rel="icon" href="/favicon.ico" sizes="any">'];for(const s of e)for(const n of t)n==="png"&&i.push(`<link rel="icon" type="image/png" sizes="${s}x${s}" href="/favicon-${s}x${s}.png">`);return i.push('<link rel="apple-touch-icon" href="/apple-touch-icon.png">'),i.push('<link rel="manifest" href="/manifest.json">'),{type:"html",name:"favicon-tags.html",content:i.join(`
`)}}async function M(m,e,t={}){try{const i=h.getTemplateById(e);if(!i)throw new Error(`Template not found: ${e}`);const s=u.validateTemplateCompatibility(i,{width:m.width,height:m.height});if(!s.compatible)throw new Error(`Template incompatible: ${s.errors.map(c=>c.message).join(", ")}`);const n=new R(`Template: ${i.displayName}`,i.description),a=u.parseDimension(i.width),o=u.parseDimension(i.height);if(!a.isVariable&&!o.isVariable){const c=a.value/o.value,f=m.width/m.height;Math.abs(c-f)>.1?n.addCrop(a.value,o.value,"smart"):n.addResize(Math.max(a.value,o.value),"longest")}else a.isVariable&&!o.isVariable?n.addResize(o.value,"height"):!a.isVariable&&o.isVariable&&n.addResize(a.value,"width");n.addOptimize(85,"auto",{compressionMode:"adaptive",preserveTransparency:i.recommendedFormats.includes("png")||i.recommendedFormats.includes("svg")});const r=await I([m],n);if(r.length===0||!r[0].success)throw new Error("Template processing failed");return{success:!0,template:i,image:r[0].image,file:r[0].file,compatibility:s,warnings:s.warnings}}catch(i){return console.error("Template processing failed:",i),{success:!1,error:i.message,templateId:e}}}async function G(m,e,t={}){const i=u.parseDimension(e.width),s=u.parseDimension(e.height),n=new R(`Flexible: ${e.displayName}`,e.description);if(i.isVariable&&!s.isVariable){const o=s.value/m.height;Math.round(m.width*o),n.addResize(s.value,"height")}else if(!i.isVariable&&s.isVariable){const o=i.value/m.width;Math.round(m.height*o),n.addResize(i.value,"width")}else i.isVariable&&s.isVariable&&n.addOptimize(85,"auto");return(await I([m],n))[0]||{success:!1,error:"Processing failed"}}const q={LemGendImage:v,LemGendTask:R,LemGendaryResize:z.LemGendaryResize,LemGendaryCrop:z.LemGendaryCrop,LemGendaryOptimize:z.LemGendaryOptimize,LemGendaryRename:z.LemGendaryRename,lemGendaryProcessBatch:I,lemGendBuildZip:C,getLibraryInfo:D,processFaviconSet:A,optimizeForZip:x,createOptimizedZip:$,processWithTemplate:M,processFlexibleTemplate:G,LemGendTemplates:h.LemGendTemplates,TEMPLATE_CATEGORIES:h.TEMPLATE_CATEGORIES,PLATFORMS:h.PLATFORMS,getTemplatesByPlatform:h.getTemplatesByPlatform,getTemplatesByCategory:h.getTemplatesByCategory,getTemplateById:h.getTemplateById,getTemplatesByDimensions:h.getTemplatesByDimensions,getRecommendedTemplates:h.getRecommendedTemplates,getTemplateStats:h.getTemplateStats,exportTemplates:h.exportTemplates,validateTemplate:h.validateTemplate,addCustomTemplate:h.addCustomTemplate,getAllPlatforms:h.getAllPlatforms,getTemplatesGroupedByPlatform:h.getTemplatesGroupedByPlatform,searchTemplates:h.searchTemplates,getTemplateAspectRatio:h.getTemplateAspectRatio,getFlexibleTemplates:h.getFlexibleTemplates,getTemplatesForImage:h.getTemplatesForImage,isVariableDimension:u.isVariableDimension,parseDimension:u.parseDimension,createLemGendaryZip:g.createLemGendaryZip,createSimpleZip:g.createSimpleZip,extractZip:g.extractZip,getZipInfo:g.getZipInfo,createZipWithProgress:g.createZipWithProgress,getImageDimensions:g.getImageDimensions,hasTransparency:g.hasTransparency,fileToDataURL:g.fileToDataURL,dataURLtoFile:g.dataURLtoFile,resizeImage:g.resizeImage,cropImage:g.cropImage,calculateAspectRatioFit:g.calculateAspectRatioFit,formatFileSize:g.formatFileSize,getFileExtension:g.getFileExtension,validateImageFile:g.validateImageFile,createThumbnail:g.createThumbnail,batchProcess:g.batchProcess,ValidationErrors:u.ValidationErrors,ValidationWarnings:u.ValidationWarnings,validateImage:u.validateImage,validateDimensions:u.validateDimensions,validateResize:u.validateResize,validateCrop:u.validateCrop,validateOptimization:u.validateOptimization,validateRenamePattern:u.validateRenamePattern,getValidationSummary:u.getValidationSummary,validateOptimizationOptions:u.validateOptimizationOptions,validateTemplateCompatibility:u.validateTemplateCompatibility};exports.ValidationErrors=u.ValidationErrors;exports.ValidationWarnings=u.ValidationWarnings;exports.getValidationSummary=u.getValidationSummary;exports.isVariableDimension=u.isVariableDimension;exports.parseDimension=u.parseDimension;exports.validateCrop=u.validateCrop;exports.validateDimensions=u.validateDimensions;exports.validateImage=u.validateImage;exports.validateOptimization=u.validateOptimization;exports.validateOptimizationOptions=u.validateOptimizationOptions;exports.validateRenamePattern=u.validateRenamePattern;exports.validateResize=u.validateResize;exports.validateTemplateCompatibility=u.validateTemplateCompatibility;exports.LemGendaryCrop=z.LemGendaryCrop;exports.LemGendaryOptimize=z.LemGendaryOptimize;exports.LemGendaryRename=z.LemGendaryRename;exports.LemGendaryResize=z.LemGendaryResize;exports.LemGendTemplates=h.LemGendTemplates;exports.PLATFORMS=h.PLATFORMS;exports.TEMPLATE_CATEGORIES=h.TEMPLATE_CATEGORIES;exports.addCustomTemplate=h.addCustomTemplate;exports.exportTemplates=h.exportTemplates;exports.getAllPlatforms=h.getAllPlatforms;exports.getFlexibleTemplates=h.getFlexibleTemplates;exports.getRecommendedTemplates=h.getRecommendedTemplates;exports.getTemplateAspectRatio=h.getTemplateAspectRatio;exports.getTemplateById=h.getTemplateById;exports.getTemplateStats=h.getTemplateStats;exports.getTemplatesByCategory=h.getTemplatesByCategory;exports.getTemplatesByDimensions=h.getTemplatesByDimensions;exports.getTemplatesByPlatform=h.getTemplatesByPlatform;exports.getTemplatesForImage=h.getTemplatesForImage;exports.getTemplatesGroupedByPlatform=h.getTemplatesGroupedByPlatform;exports.searchTemplates=h.searchTemplates;exports.validateTemplate=h.validateTemplate;exports.batchProcess=g.batchProcess;exports.calculateAspectRatioFit=g.calculateAspectRatioFit;exports.createLemGendaryZip=g.createLemGendaryZip;exports.createSimpleZip=g.createSimpleZip;exports.createThumbnail=g.createThumbnail;exports.createZipWithProgress=g.createZipWithProgress;exports.cropImage=g.cropImage;exports.dataURLtoFile=g.dataURLtoFile;exports.extractZip=g.extractZip;exports.fileToDataURL=g.fileToDataURL;exports.formatFileSize=g.formatFileSize;exports.getFileExtension=g.getFileExtension;exports.getImageDimensions=g.getImageDimensions;exports.getZipInfo=g.getZipInfo;exports.hasTransparency=g.hasTransparency;exports.resizeImage=g.resizeImage;exports.validateImageFile=g.validateImageFile;exports.LemGendImage=v;exports.LemGendTask=R;exports.createOptimizedZip=$;exports.default=q;exports.getLibraryInfo=D;exports.lemGendBuildZip=C;exports.lemGendaryProcessBatch=I;exports.optimizeForZip=x;exports.processFaviconSet=A;exports.processFlexibleTemplate=G;exports.processWithTemplate=M;
//# sourceMappingURL=index.cjs.js.map
