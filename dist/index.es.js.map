{"version":3,"file":"index.es.js","sources":["../src/LemGendImage.js","../src/tasks/LemGendTask.js","../src/index.js"],"sourcesContent":["/**\r\n * LemGendImage - Core image representation class\r\n * @class\r\n * @description Represents an image throughout the processing pipeline\r\n */\r\nexport class LemGendImage {\r\n    /**\r\n     * Create a new LemGendImage instance\r\n     * @param {File} file - The original image file\r\n     * @param {Object} options - Configuration options\r\n     */\r\n    constructor(file, options = {}) {\r\n        if (!(file instanceof File)) {\r\n            throw new TypeError('LemGendImage requires a File object')\r\n        }\r\n\r\n        this.id = `lemgend_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`\r\n        this.file = file\r\n        this.originalName = file.name\r\n        this.originalSize = file.size\r\n        this.type = file.type\r\n        this.mimeType = file.type\r\n        this.extension = file.name.split('.').pop().toLowerCase()\r\n\r\n        if (this.extension === 'ico' && !this.type.includes('image')) {\r\n            this.type = 'image/x-icon'\r\n            this.mimeType = 'image/x-icon'\r\n        }\r\n\r\n        this.metadata = {\r\n            originalDimensions: null,\r\n            processedDimensions: null,\r\n            operations: [],\r\n            createdAt: new Date().toISOString(),\r\n            lastModified: new Date().toISOString(),\r\n            optimizationHistory: [],\r\n            analysis: null\r\n        }\r\n        this.outputs = new Map()\r\n        this.processed = false\r\n        this.orientation = options.orientation || null\r\n        this.width = options.width || null\r\n        this.height = options.height || null\r\n        this.aspectRatio = null\r\n        this.transparency = null\r\n        this._imageElement = null\r\n        this._svgDocument = null\r\n        this._objectURL = null\r\n        this.optimizationScore = 0\r\n        this.optimizationRecommendations = []\r\n\r\n        if (this.width && this.height) {\r\n            this.aspectRatio = this.width / this.height\r\n            this.orientation = this.width >= this.height ? 'landscape' : 'portrait'\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Load and analyze the image\r\n     * @returns {Promise<LemGendImage>} The loaded image instance\r\n     */\r\n    load = async () => {\r\n        try {\r\n            if (this.type === 'image/svg+xml') {\r\n                await this._loadSVG()\r\n            } else if (this.type === 'image/x-icon' || this.type === 'image/vnd.microsoft.icon') {\r\n                await this._loadFavicon()\r\n            } else {\r\n                await this._loadRaster()\r\n            }\r\n\r\n            if (this.width && this.height) {\r\n                this.aspectRatio = this.width / this.height\r\n                this.orientation = this.width >= this.height ? 'landscape' : 'portrait'\r\n            }\r\n\r\n            this.metadata.originalDimensions = {\r\n                width: this.width,\r\n                height: this.height,\r\n                orientation: this.orientation,\r\n                aspectRatio: this.aspectRatio\r\n            }\r\n\r\n            // Analyze image for optimization\r\n            await this._analyzeForOptimization()\r\n\r\n            if (this.type === 'image/png' || this.type === 'image/webp' || this.type.includes('icon')) {\r\n                await this._checkTransparency()\r\n            }\r\n\r\n            return this\r\n        } catch (error) {\r\n            throw new Error(`Failed to load image: ${error.message}`)\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Analyze image for optimization potential\r\n     * @private\r\n     */\r\n    _analyzeForOptimization = async () => {\r\n        const analysis = {\r\n            fileSize: this.originalSize,\r\n            dimensions: { width: this.width, height: this.height },\r\n            aspectRatio: this.aspectRatio,\r\n            orientation: this.orientation,\r\n            mimeType: this.type,\r\n            extension: this.extension,\r\n            optimizationScore: 0,\r\n            recommendations: []\r\n        }\r\n\r\n        // Calculate optimization score (0-100)\r\n        let score = 0\r\n\r\n        // Size-based scoring\r\n        if (this.originalSize > 5 * 1024 * 1024) {\r\n            score += 40\r\n            analysis.recommendations.push('File is very large - high optimization potential')\r\n        } else if (this.originalSize > 1 * 1024 * 1024) {\r\n            score += 20\r\n        } else if (this.originalSize > 100 * 1024) {\r\n            score += 10\r\n        }\r\n\r\n        // Dimension-based scoring\r\n        const megapixels = (this.width * this.height) / 1000000\r\n        if (megapixels > 16) {\r\n            score += 30\r\n            analysis.recommendations.push('Very high resolution - consider resizing')\r\n        } else if (megapixels > 4) {\r\n            score += 15\r\n        }\r\n\r\n        // Format-based scoring\r\n        const modernFormats = ['webp', 'avif', 'svg']\r\n        if (!modernFormats.includes(this.extension)) {\r\n            score += 20\r\n            analysis.recommendations.push(`Consider converting from ${this.extension} to modern format`)\r\n        }\r\n\r\n        this.optimizationScore = Math.min(100, score)\r\n        this.optimizationRecommendations = analysis.recommendations\r\n        this.metadata.analysis = analysis\r\n        this.metadata.optimizationLevel = score > 50 ? 'high' : score > 25 ? 'medium' : 'low'\r\n\r\n        return analysis\r\n    }\r\n\r\n    /**\r\n     * Load and analyze favicon (ICO) file\r\n     * @private\r\n     */\r\n    _loadFavicon = async () => {\r\n        try {\r\n            this.width = 32\r\n            this.height = 32\r\n            this.aspectRatio = 1\r\n            this.orientation = 'square'\r\n\r\n            this.metadata.favicon = true\r\n            this.metadata.possibleSizes = [16, 32, 48, 64, 128, 256]\r\n\r\n            return this\r\n        } catch (error) {\r\n            throw new Error(`Failed to load favicon: ${error.message}`)\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Load and analyze SVG image\r\n     * @private\r\n     */\r\n    _loadSVG = async () => {\r\n        try {\r\n            const text = await this.file.text()\r\n            const parser = new DOMParser()\r\n            const svgDoc = parser.parseFromString(text, 'image/svg+xml')\r\n            const svgElement = svgDoc.documentElement\r\n\r\n            const parserError = svgDoc.querySelector('parsererror')\r\n            if (parserError) {\r\n                throw new Error('Invalid SVG format')\r\n            }\r\n\r\n            const widthAttr = svgElement.getAttribute('width')\r\n            const heightAttr = svgElement.getAttribute('height')\r\n            const viewBox = svgElement.getAttribute('viewBox')\r\n\r\n            if (widthAttr && heightAttr) {\r\n                this.width = this._parseSVGLength(widthAttr)\r\n                this.height = this._parseSVGLength(heightAttr)\r\n            } else if (viewBox) {\r\n                const [x, y, vbWidth, vbHeight] = viewBox.split(/\\s+|,/).map(parseFloat)\r\n                this.width = vbWidth || 100\r\n                this.height = vbHeight || 100\r\n            } else {\r\n                this.width = 100\r\n                this.height = 100\r\n            }\r\n\r\n            this._svgDocument = svgDoc\r\n            this.metadata.svgContent = text\r\n            this.metadata.svgElement = svgElement\r\n            this.transparency = this._checkSVGTransparency(text)\r\n\r\n        } catch (error) {\r\n            throw new Error(`Failed to load SVG: ${error.message}`)\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Parse SVG length string to pixels\r\n     * @private\r\n     */\r\n    _parseSVGLength = (lengthStr) => {\r\n        const match = lengthStr.match(/^([\\d.]+)(px|pt|pc|mm|cm|in|em|ex|%)?$/)\r\n        if (!match) return 100\r\n\r\n        const value = parseFloat(match[1])\r\n        const unit = match[2] || 'px'\r\n\r\n        const unitMap = {\r\n            'px': 1,\r\n            'pt': 1.33,\r\n            'pc': 16,\r\n            'mm': 3.78,\r\n            'cm': 37.8,\r\n            'in': 96,\r\n            'em': 16,\r\n            'ex': 8,\r\n            '%': value\r\n        }\r\n\r\n        return value * (unitMap[unit] || 1)\r\n    }\r\n\r\n    /**\r\n     * Check if SVG has transparent elements\r\n     * @private\r\n     */\r\n    _checkSVGTransparency = (svgText) => {\r\n        const transparencyIndicators = [\r\n            'fill=\"none\"',\r\n            'fill=\"transparent\"',\r\n            'fill-opacity',\r\n            'opacity=',\r\n            'rgba(',\r\n            'hsla(',\r\n            'fill:#00000000',\r\n            'fill:transparent',\r\n            'stroke-opacity',\r\n            'stop-opacity'\r\n        ]\r\n\r\n        return transparencyIndicators.some(indicator =>\r\n            svgText.includes(indicator)\r\n        )\r\n    }\r\n\r\n    /**\r\n     * Load and analyze raster image\r\n     * @private\r\n     */\r\n    _loadRaster = async () => {\r\n        return new Promise((resolve, reject) => {\r\n            const img = new Image()\r\n\r\n            img.onload = () => {\r\n                this.width = img.naturalWidth || img.width\r\n                this.height = img.naturalHeight || img.height\r\n                this._imageElement = img\r\n                this._objectURL = img.src\r\n                resolve(this)\r\n            }\r\n\r\n            img.onerror = () => {\r\n                reject(new Error('Failed to load raster image'))\r\n            }\r\n\r\n            img.src = URL.createObjectURL(this.file)\r\n        })\r\n    }\r\n\r\n    /**\r\n     * Check raster image for transparency\r\n     * @private\r\n     */\r\n    _checkTransparency = async () => {\r\n        return new Promise((resolve) => {\r\n            const img = new Image()\r\n\r\n            img.onload = () => {\r\n                const canvas = document.createElement('canvas')\r\n                canvas.width = img.width\r\n                canvas.height = img.height\r\n                const ctx = canvas.getContext('2d')\r\n                ctx.drawImage(img, 0, 0)\r\n\r\n                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height)\r\n                const data = imageData.data\r\n\r\n                for (let i = 3; i < data.length; i += 4) {\r\n                    if (data[i] < 255) {\r\n                        this.transparency = true\r\n                        resolve(true)\r\n                        return\r\n                    }\r\n                }\r\n\r\n                this.transparency = false\r\n                resolve(false)\r\n            }\r\n\r\n            img.onerror = () => {\r\n                this.transparency = false\r\n                resolve(false)\r\n            }\r\n\r\n            img.src = URL.createObjectURL(this.file)\r\n        })\r\n    }\r\n\r\n    /**\r\n     * Update image dimensions\r\n     * @param {number} width - New width in pixels\r\n     * @param {number} height - New height in pixels\r\n     */\r\n    updateDimensions = (width, height) => {\r\n        if (typeof width !== 'number' || typeof height !== 'number' || width <= 0 || height <= 0) {\r\n            throw new Error('Dimensions must be positive numbers')\r\n        }\r\n\r\n        this.width = width\r\n        this.height = height\r\n        this.aspectRatio = width / height\r\n        this.orientation = width >= height ? 'landscape' : 'portrait'\r\n\r\n        this.metadata.processedDimensions = { width, height, aspectRatio: this.aspectRatio }\r\n        this.metadata.lastModified = new Date().toISOString()\r\n    }\r\n\r\n    /**\r\n     * Add an operation to metadata\r\n     * @param {string} operation - Operation name\r\n     * @param {Object} details - Operation details\r\n     */\r\n    addOperation = (operation, details) => {\r\n        this.metadata.operations.push({\r\n            operation,\r\n            details,\r\n            timestamp: new Date().toISOString(),\r\n            previousDimensions: this.metadata.processedDimensions || this.metadata.originalDimensions\r\n        })\r\n\r\n        // Track optimization operations separately\r\n        if (operation === 'optimize') {\r\n            this.metadata.optimizationHistory.push({\r\n                ...details,\r\n                timestamp: new Date().toISOString()\r\n            })\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Add processed output\r\n     * @param {string} format - Output format\r\n     * @param {File} file - Processed file\r\n     * @param {Object} template - Template used (if any)\r\n     */\r\n    addOutput = (format, file, template = null) => {\r\n        if (!(file instanceof File)) {\r\n            throw new TypeError('Output must be a File object')\r\n        }\r\n\r\n        this.outputs.set(format, {\r\n            file,\r\n            format,\r\n            template,\r\n            dimensions: { width: this.width, height: this.height },\r\n            size: file.size,\r\n            addedAt: new Date().toISOString()\r\n        })\r\n\r\n        this.processed = true\r\n    }\r\n\r\n    /**\r\n     * Get output by format\r\n     * @param {string} format - Output format\r\n     * @returns {Object|null} Output object or null\r\n     */\r\n    getOutput = (format) => {\r\n        return this.outputs.get(format) || null\r\n    }\r\n\r\n    /**\r\n     * Get all outputs\r\n     * @returns {Array} Array of output objects\r\n     */\r\n    getAllOutputs = () => {\r\n        return Array.from(this.outputs.values())\r\n    }\r\n\r\n    /**\r\n     * Get output as Data URL\r\n     * @param {string} format - Output format\r\n     * @returns {Promise<string>} Data URL\r\n     */\r\n    getOutputAsDataURL = async (format) => {\r\n        const output = this.getOutput(format)\r\n        if (!output) {\r\n            throw new Error(`No output found for format: ${format}`)\r\n        }\r\n\r\n        return new Promise((resolve, reject) => {\r\n            const reader = new FileReader()\r\n            reader.onload = () => resolve(reader.result)\r\n            reader.onerror = reject\r\n            reader.readAsDataURL(output.file)\r\n        })\r\n    }\r\n\r\n    /**\r\n     * Get original image as Data URL\r\n     * @returns {Promise<string>} Data URL\r\n     */\r\n    toDataURL = async () => {\r\n        return new Promise((resolve, reject) => {\r\n            const reader = new FileReader()\r\n            reader.onload = () => resolve(reader.result)\r\n            reader.onerror = reject\r\n            reader.readAsDataURL(this.file)\r\n        })\r\n    }\r\n\r\n    /**\r\n     * Get optimization recommendations based on image analysis\r\n     * @returns {Object} Optimization recommendations\r\n     */\r\n    getOptimizationRecommendations = () => {\r\n        const recommendations = {\r\n            format: this._recommendFormat(),\r\n            quality: this._recommendQuality(),\r\n            resize: this._recommendResize(),\r\n            warnings: this.optimizationRecommendations,\r\n            suggestions: [],\r\n            priority: this._getOptimizationPriority()\r\n        }\r\n\r\n        // Additional suggestions based on image characteristics\r\n        if (this.transparency && this.extension === 'jpg') {\r\n            recommendations.suggestions.push('JPEG format does not support transparency - consider PNG or WebP')\r\n        }\r\n\r\n        if (this.width > 4000 || this.height > 4000) {\r\n            recommendations.suggestions.push('Image dimensions very large - consider resizing for web')\r\n        }\r\n\r\n        if (this.originalSize > 10 * 1024 * 1024) {\r\n            recommendations.suggestions.push('Image is very large (>10MB) - consider aggressive compression')\r\n        }\r\n\r\n        return recommendations\r\n    }\r\n\r\n    /**\r\n     * Recommend best format based on image characteristics\r\n     * @private\r\n     */\r\n    _recommendFormat = () => {\r\n        if (this.type === 'image/svg+xml') return 'svg'\r\n        if (this.type.includes('icon')) return 'ico'\r\n\r\n        if (this.transparency) {\r\n            return 'webp' // WebP supports transparency and has good compression\r\n        }\r\n\r\n        // For photographic images, recommend modern formats\r\n        if (this.width * this.height > 1000000) {\r\n            return 'avif' // AVIF is great for large images\r\n        }\r\n\r\n        return 'webp' // Default to WebP for good balance\r\n    }\r\n\r\n    /**\r\n     * Recommend quality setting\r\n     * @private\r\n     */\r\n    _recommendQuality = () => {\r\n        if (this.type === 'image/svg+xml' || this.type.includes('icon')) {\r\n            return 100 // Vector and icons should be lossless\r\n        }\r\n\r\n        if (this.transparency) {\r\n            return 90 // Higher quality for transparency\r\n        }\r\n\r\n        if (this.width * this.height > 2000000) {\r\n            return 80 // Lower quality for very large images\r\n        }\r\n\r\n        return 85 // Default good quality\r\n    }\r\n\r\n    /**\r\n     * Recommend resize dimensions\r\n     * @private\r\n     */\r\n    _recommendResize = () => {\r\n        const maxWebDimension = 1920\r\n\r\n        if (this.width <= maxWebDimension && this.height <= maxWebDimension) {\r\n            return null // No resize needed\r\n        }\r\n\r\n        let newWidth, newHeight\r\n\r\n        if (this.width >= this.height) {\r\n            newWidth = Math.min(this.width, maxWebDimension)\r\n            newHeight = Math.round((this.height / this.width) * newWidth)\r\n        } else {\r\n            newHeight = Math.min(this.height, maxWebDimension)\r\n            newWidth = Math.round((this.width / this.height) * newHeight)\r\n        }\r\n\r\n        return {\r\n            width: newWidth,\r\n            height: newHeight,\r\n            reason: `Resize to ${newWidth}x${newHeight} for web display`\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Get optimization priority\r\n     * @private\r\n     */\r\n    _getOptimizationPriority = () => {\r\n        const megapixels = (this.width * this.height) / 1000000\r\n        const mbSize = this.originalSize / (1024 * 1024)\r\n\r\n        if (mbSize > 10 || megapixels > 16) {\r\n            return 'high' // Very large images need optimization\r\n        }\r\n\r\n        if (mbSize > 2 || megapixels > 4) {\r\n            return 'medium' // Large images benefit from optimization\r\n        }\r\n\r\n        return 'low' // Small images are already fairly optimized\r\n    }\r\n\r\n    /**\r\n     * Get optimization summary for reporting\r\n     * @returns {Object} Optimization summary\r\n     */\r\n    getOptimizationSummary = () => {\r\n        const recommendations = this.getOptimizationRecommendations()\r\n\r\n        return {\r\n            original: {\r\n                name: this.originalName,\r\n                size: this.originalSize,\r\n                dimensions: `${this.width}x${this.height}`,\r\n                format: this.extension,\r\n                hasTransparency: this.transparency,\r\n                mimeType: this.type\r\n            },\r\n            recommendations,\r\n            estimatedSavings: this._estimateOptimizationSavings(recommendations),\r\n            priority: recommendations.priority,\r\n            optimizationScore: this.optimizationScore,\r\n            optimizationLevel: this.metadata.optimizationLevel || 'unknown'\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Estimate optimization savings\r\n     * @private\r\n     */\r\n    _estimateOptimizationSavings = (recommendations) => {\r\n        // Simple estimation based on format and quality\r\n        let estimatedSize = this.originalSize\r\n\r\n        switch (recommendations.format) {\r\n            case 'webp':\r\n                estimatedSize *= 0.7\r\n                break\r\n            case 'avif':\r\n                estimatedSize *= 0.6\r\n                break\r\n            case 'png':\r\n                estimatedSize *= 0.9\r\n                break\r\n            case 'jpg':\r\n                estimatedSize *= 0.8\r\n                break\r\n            case 'svg':\r\n                estimatedSize *= 0.3\r\n                break\r\n        }\r\n\r\n        // Apply quality adjustment\r\n        estimatedSize *= (recommendations.quality / 100)\r\n\r\n        // Apply resize if recommended\r\n        if (recommendations.resize) {\r\n            const areaReduction = (recommendations.resize.width * recommendations.resize.height) /\r\n                (this.width * this.height)\r\n            estimatedSize *= areaReduction\r\n        }\r\n\r\n        const savings = this.originalSize - estimatedSize\r\n\r\n        return {\r\n            originalSize: this.originalSize,\r\n            estimatedSize: Math.round(estimatedSize),\r\n            savings: Math.round(savings),\r\n            savingsPercent: Math.round((savings / this.originalSize) * 1000) / 10\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Get image info summary\r\n     * @returns {Object} Image information\r\n     */\r\n    getInfo = () => {\r\n        return {\r\n            id: this.id,\r\n            name: this.originalName,\r\n            type: this.type,\r\n            originalSize: this.originalSize,\r\n            width: this.width,\r\n            height: this.height,\r\n            orientation: this.orientation,\r\n            aspectRatio: this.aspectRatio,\r\n            transparency: this.transparency,\r\n            processed: this.processed,\r\n            outputs: this.getAllOutputs().map(output => output.format),\r\n            metadata: { ...this.metadata },\r\n            optimization: {\r\n                score: this.optimizationScore,\r\n                level: this.metadata.optimizationLevel,\r\n                recommendations: this.optimizationRecommendations.length\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Get detailed optimization report\r\n     * @returns {Object} Detailed optimization report\r\n     */\r\n    getOptimizationReport = () => {\r\n        const summary = this.getOptimizationSummary()\r\n        const info = this.getInfo()\r\n\r\n        return {\r\n            ...summary,\r\n            imageInfo: {\r\n                id: info.id,\r\n                name: info.name,\r\n                type: info.type,\r\n                processed: info.processed\r\n            },\r\n            analysis: this.metadata.analysis,\r\n            optimizationHistory: this.metadata.optimizationHistory,\r\n            generatedAt: new Date().toISOString()\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Check if image needs optimization\r\n     * @param {number} threshold - Optimization score threshold (0-100)\r\n     * @returns {boolean} True if optimization needed\r\n     */\r\n    needsOptimization = (threshold = 30) => {\r\n        return this.optimizationScore >= threshold\r\n    }\r\n\r\n    /**\r\n     * Get recommended optimization settings\r\n     * @param {string} useCase - Use case identifier\r\n     * @returns {Object} Recommended settings\r\n     */\r\n    getRecommendedSettings = (useCase = 'web') => {\r\n        const recommendations = this.getOptimizationRecommendations()\r\n\r\n        const presets = {\r\n            'web': {\r\n                quality: recommendations.quality,\r\n                format: recommendations.format,\r\n                maxDisplayWidth: 1920,\r\n                compressionMode: 'adaptive',\r\n                browserSupport: ['modern', 'legacy']\r\n            },\r\n            'social': {\r\n                quality: 90,\r\n                format: 'jpg',\r\n                maxDisplayWidth: 1080,\r\n                compressionMode: 'balanced',\r\n                stripMetadata: false\r\n            },\r\n            'ecommerce': {\r\n                quality: 92,\r\n                format: 'webp',\r\n                maxDisplayWidth: 1200,\r\n                compressionMode: 'balanced',\r\n                preserveTransparency: true\r\n            },\r\n            'print': {\r\n                quality: 100,\r\n                format: 'png',\r\n                maxDisplayWidth: null,\r\n                compressionMode: 'balanced',\r\n                lossless: true\r\n            }\r\n        }\r\n\r\n        return presets[useCase] || presets['web']\r\n    }\r\n\r\n    /**\r\n     * Clean up resources\r\n     */\r\n    destroy = () => {\r\n        if (this._objectURL) {\r\n            URL.revokeObjectURL(this._objectURL)\r\n        }\r\n\r\n        if (this._imageElement?.src && this._imageElement.src.startsWith('blob:')) {\r\n            URL.revokeObjectURL(this._imageElement.src)\r\n        }\r\n\r\n        this._imageElement = null\r\n        this._svgDocument = null\r\n        this._objectURL = null\r\n        this.outputs.clear()\r\n    }\r\n\r\n    /**\r\n     * Clone the image instance (without outputs)\r\n     * @returns {LemGendImage} Cloned instance\r\n     */\r\n    clone = () => {\r\n        const clone = new LemGendImage(this.file, {\r\n            orientation: this.orientation,\r\n            width: this.width,\r\n            height: this.height\r\n        })\r\n\r\n        clone.metadata = JSON.parse(JSON.stringify(this.metadata))\r\n        clone.transparency = this.transparency\r\n        clone.aspectRatio = this.aspectRatio\r\n        clone.optimizationScore = this.optimizationScore\r\n        clone.optimizationRecommendations = [...this.optimizationRecommendations]\r\n\r\n        return clone\r\n    }\r\n\r\n    /**\r\n     * Create thumbnail preview\r\n     * @param {number} maxSize - Maximum thumbnail dimension\r\n     * @returns {Promise<string>} Thumbnail as Data URL\r\n     */\r\n    createThumbnail = async (maxSize = 200) => {\r\n        return new Promise((resolve, reject) => {\r\n            if (this.type === 'image/svg+xml') {\r\n                // For SVG, return as-is\r\n                this.toDataURL().then(resolve).catch(reject)\r\n                return\r\n            }\r\n\r\n            if (this.type === 'image/x-icon' || this.type === 'image/vnd.microsoft.icon') {\r\n                // Use a default favicon icon as thumbnail\r\n                resolve('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iIzM4ODJlZiIvPjxjaXJjbGUgY3g9IjEwMCIgY3k9IjEwMCIgcj0iNjAiIGZpbGw9IiNmZmYiLz48Y2lyY2xlIGN4PSIxMDAiIGN5PSIxMDAiIHI9IjQwIiBmaWxsPSIjMzg4MmVmIi8+PC9zdmc+')\r\n                return\r\n            }\r\n\r\n            const img = new Image()\r\n            const objectUrl = URL.createObjectURL(this.file)\r\n\r\n            img.onload = () => {\r\n                // Calculate thumbnail dimensions\r\n                let width, height\r\n                if (img.width > img.height) {\r\n                    width = maxSize\r\n                    height = Math.round((img.height / img.width) * maxSize)\r\n                } else {\r\n                    height = maxSize\r\n                    width = Math.round((img.width / img.height) * maxSize)\r\n                }\r\n\r\n                // Create canvas for thumbnail\r\n                const canvas = document.createElement('canvas')\r\n                canvas.width = width\r\n                canvas.height = height\r\n                const ctx = canvas.getContext('2d')\r\n\r\n                // Draw image\r\n                ctx.drawImage(img, 0, 0, width, height)\r\n\r\n                // Convert to Data URL\r\n                const thumbnail = canvas.toDataURL('image/jpeg', 0.7)\r\n\r\n                // Clean up\r\n                URL.revokeObjectURL(objectUrl)\r\n                resolve(thumbnail)\r\n            }\r\n\r\n            img.onerror = () => {\r\n                URL.revokeObjectURL(objectUrl)\r\n                reject(new Error('Failed to create thumbnail'))\r\n            }\r\n\r\n            img.src = objectUrl\r\n        })\r\n    }\r\n}","/**\r\n * LemGendTask - Unified processing pipeline with favicon support\r\n * @class\r\n * @description Orchestrates multiple image processing operations in sequence\r\n */\r\n\r\n// Import validation functions\r\nimport { validateOptimizationOptions, ValidationWarnings } from '../utils/validation.js'\r\n\r\nexport class LemGendTask {\r\n    /**\r\n     * Create a new LemGendTask\r\n     * @param {string} name - Task name\r\n     * @param {string} description - Task description\r\n     */\r\n    constructor(name = 'Untitled Task', description = '') {\r\n        this.id = `task_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`\r\n        this.name = name\r\n        this.description = description\r\n        this.steps = []\r\n        this.validationWarnings = []\r\n        this.validationErrors = []\r\n        this.createdAt = new Date().toISOString()\r\n        this.updatedAt = new Date().toISOString()\r\n        this.metadata = {\r\n            version: '2.2.0',\r\n            processorVersions: {\r\n                resize: '1.2.1',\r\n                crop: '2.0.0',\r\n                optimize: '2.0.0', // Updated version\r\n                rename: '1.0.0',\r\n                template: '1.3.0',\r\n                favicon: '2.0.0'\r\n            },\r\n            estimatedDuration: null,\r\n            estimatedOutputs: 0,\r\n            supportsFavicon: true,\r\n            supportsSVG: true,\r\n            supportsAICropping: true,\r\n            maxBatchSize: 50,\r\n            defaultResizeMode: 'longest',\r\n            supportsOptimizationFirst: true,\r\n            optimizationModes: ['adaptive', 'aggressive', 'balanced']\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Add a processing step\r\n     * @param {string} processor - Processor name ('resize', 'crop', 'optimize', 'rename', 'template', 'favicon')\r\n     * @param {Object} options - Processor options\r\n     * @returns {LemGendTask} This task instance for chaining\r\n     */\r\n    addStep = (processor, options) => {\r\n        const validProcessors = ['resize', 'crop', 'optimize', 'rename', 'template', 'favicon']\r\n\r\n        if (!validProcessors.includes(processor)) {\r\n            throw new Error(`Invalid processor: ${processor}. Valid options: ${validProcessors.join(', ')}`)\r\n        }\r\n\r\n        const step = {\r\n            id: `step_${this.steps.length + 1}_${Date.now()}_${Math.random().toString(36).substr(2, 4)}`,\r\n            processor,\r\n            options: this._validateStepOptions(processor, options),\r\n            order: this.steps.length + 1,\r\n            addedAt: new Date().toISOString(),\r\n            enabled: true,\r\n            metadata: {\r\n                requiresFavicon: processor === 'favicon',\r\n                isBatchable: !['favicon', 'template'].includes(processor),\r\n                outputType: this._getStepOutputType(processor, options),\r\n                supportsOptimizationFirst: processor === 'optimize'\r\n            }\r\n        }\r\n\r\n        this.steps.push(step)\r\n        this.updatedAt = new Date().toISOString()\r\n        this._updateMetadata()\r\n\r\n        return this\r\n    }\r\n\r\n    /**\r\n     * Validate step options based on processor type\r\n     * @private\r\n     */\r\n    _validateStepOptions = (processor, options) => {\r\n        const defaults = {\r\n            resize: {\r\n                dimension: 1024,\r\n                mode: 'longest',\r\n                maintainAspectRatio: true,\r\n                upscale: true,\r\n                algorithm: 'lanczos3'\r\n            },\r\n            crop: {\r\n                width: 500,\r\n                height: 500,\r\n                mode: 'smart',\r\n                upscale: false,\r\n                preserveAspectRatio: true,\r\n                confidenceThreshold: 70,\r\n                cropToFit: true,\r\n                objectsToDetect: ['person', 'face', 'car', 'dog', 'cat']\r\n            },\r\n            optimize: {\r\n                quality: 85,\r\n                format: 'auto',\r\n                lossless: false,\r\n                stripMetadata: true,\r\n                preserveTransparency: true,\r\n                maxDisplayWidth: null,\r\n                browserSupport: ['modern', 'legacy'],\r\n                compressionMode: 'adaptive',\r\n                analyzeContent: true,\r\n                icoSizes: [16, 32, 48, 64, 128, 256]\r\n            },\r\n            rename: {\r\n                pattern: '{name}-{dimensions}',\r\n                preserveExtension: true,\r\n                addIndex: true,\r\n                addTimestamp: false,\r\n                customSeparator: '-'\r\n            },\r\n            template: {\r\n                templateId: null,\r\n                applyToAll: true,\r\n                preserveOriginal: false\r\n            },\r\n            favicon: {\r\n                sizes: [16, 32, 48, 64, 128, 180, 192, 256, 512],\r\n                formats: ['png', 'ico'],\r\n                generateManifest: true,\r\n                generateHTML: true,\r\n                includeAppleTouch: true,\r\n                includeAndroid: true,\r\n                roundCorners: true,\r\n                backgroundColor: '#ffffff'\r\n            }\r\n        }\r\n\r\n        const validatedOptions = { ...defaults[processor], ...options }\r\n\r\n        switch (processor) {\r\n            case 'favicon':\r\n                validatedOptions.sizes = [...new Set(validatedOptions.sizes.sort((a, b) => a - b))]\r\n                validatedOptions.sizes = validatedOptions.sizes.filter(size => size >= 16 && size <= 512)\r\n                break\r\n\r\n            case 'optimize':\r\n                if (validatedOptions.format === 'jpg' && options.preserveTransparency) {\r\n                    validatedOptions.format = 'png'\r\n                }\r\n\r\n                // Validate browser support\r\n                const validBrowserSupport = ['modern', 'legacy', 'all']\r\n                validatedOptions.browserSupport = validatedOptions.browserSupport.filter(support =>\r\n                    validBrowserSupport.includes(support)\r\n                )\r\n                if (validatedOptions.browserSupport.length === 0) {\r\n                    validatedOptions.browserSupport = ['modern', 'legacy']\r\n                }\r\n\r\n                // Validate compression mode\r\n                const validCompressionModes = ['adaptive', 'aggressive', 'balanced']\r\n                if (!validCompressionModes.includes(validatedOptions.compressionMode)) {\r\n                    validatedOptions.compressionMode = 'adaptive'\r\n                }\r\n\r\n                // Adjust quality for specific formats\r\n                if (validatedOptions.format === 'avif') {\r\n                    validatedOptions.quality = Math.min(63, validatedOptions.quality)\r\n                }\r\n                break\r\n\r\n            case 'crop':\r\n                if (['smart', 'face', 'object', 'saliency', 'entropy'].includes(validatedOptions.mode)) {\r\n                    validatedOptions.confidenceThreshold = Math.max(0, Math.min(100, validatedOptions.confidenceThreshold || 70))\r\n                    validatedOptions.multipleFaces = validatedOptions.multipleFaces || false\r\n\r\n                    if (!Array.isArray(validatedOptions.objectsToDetect)) {\r\n                        validatedOptions.objectsToDetect = ['person', 'face', 'car', 'dog', 'cat']\r\n                    }\r\n                }\r\n                break\r\n\r\n            case 'rename':\r\n                // Validate pattern has at least one placeholder\r\n                const placeholders = ['{name}', '{index}', '{timestamp}', '{width}', '{height}', '{dimensions}']\r\n                if (!placeholders.some(ph => validatedOptions.pattern.includes(ph))) {\r\n                    validatedOptions.pattern = '{name}-{index}'\r\n                }\r\n                break\r\n        }\r\n\r\n        return validatedOptions\r\n    }\r\n\r\n    /**\r\n     * Get step output type\r\n     * @private\r\n     */\r\n    _getStepOutputType = (processor, options) => {\r\n        switch (processor) {\r\n            case 'optimize':\r\n                return options.format === 'auto' ? 'optimized-auto' : `optimized-${options.format}`\r\n            case 'favicon':\r\n                return 'favicon-set'\r\n            case 'template':\r\n                return 'template-applied'\r\n            default:\r\n                return 'processed'\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Add resize step\r\n     * @param {number} dimension - Target dimension\r\n     * @param {string} mode - 'auto', 'width', 'height', 'longest', or 'fit'\r\n     * @param {Object} additionalOptions - Additional options\r\n     * @returns {LemGendTask} This task instance for chaining\r\n     */\r\n    addResize = (dimension, mode = 'longest', additionalOptions = {}) => {\r\n        return this.addStep('resize', {\r\n            dimension,\r\n            mode,\r\n            ...additionalOptions\r\n        })\r\n    }\r\n\r\n    /**\r\n     * Add crop step\r\n     * @param {number} width - Crop width\r\n     * @param {number} height - Crop height\r\n     * @param {string} mode - Crop mode: 'smart', 'face', 'object', 'saliency', 'entropy', 'center', 'top', 'bottom', 'left', 'right'\r\n     * @param {Object} additionalOptions - Additional options\r\n     * @returns {LemGendTask} This task instance for chaining\r\n     */\r\n    addCrop = (width, height, mode = 'smart', additionalOptions = {}) => {\r\n        return this.addStep('crop', {\r\n            width,\r\n            height,\r\n            mode,\r\n            ...additionalOptions\r\n        })\r\n    }\r\n\r\n    /**\r\n     * Add smart crop step with AI detection\r\n     * @param {number} width - Crop width\r\n     * @param {number} height - Crop height\r\n     * @param {Object} options - Smart crop options\r\n     * @returns {LemGendTask} This task instance for chaining\r\n     */\r\n    addSmartCrop = (width, height, options = {}) => {\r\n        return this.addStep('crop', {\r\n            width,\r\n            height,\r\n            mode: 'smart',\r\n            confidenceThreshold: 70,\r\n            multipleFaces: true,\r\n            cropToFit: true,\r\n            ...options\r\n        })\r\n    }\r\n\r\n    /**\r\n     * Add optimization step with enhanced options\r\n     * @param {number} quality - Quality percentage\r\n     * @param {string} format - Output format ('auto', 'webp', 'jpg', 'png', 'avif', 'original')\r\n     * @param {Object} additionalOptions - Additional options\r\n     * @returns {LemGendTask} This task instance for chaining\r\n     */\r\n    addOptimize = (quality = 85, format = 'auto', additionalOptions = {}) => {\r\n        return this.addStep('optimize', {\r\n            quality,\r\n            format,\r\n            maxDisplayWidth: additionalOptions.maxDisplayWidth || null,\r\n            browserSupport: additionalOptions.browserSupport || ['modern', 'legacy'],\r\n            compressionMode: additionalOptions.compressionMode || 'adaptive',\r\n            analyzeContent: additionalOptions.analyzeContent !== false,\r\n            ...additionalOptions\r\n        })\r\n    }\r\n\r\n    /**\r\n     * Add optimization-first step for web delivery\r\n     * @param {Object} options - Optimization options\r\n     * @returns {LemGendTask} This task instance for chaining\r\n     */\r\n    addWebOptimization = (options = {}) => {\r\n        return this.addStep('optimize', {\r\n            quality: 85,\r\n            format: 'auto',\r\n            maxDisplayWidth: 1920,\r\n            browserSupport: ['modern', 'legacy'],\r\n            compressionMode: 'adaptive',\r\n            stripMetadata: true,\r\n            preserveTransparency: true,\r\n            ...options\r\n        })\r\n    }\r\n\r\n    /**\r\n     * Add rename step\r\n     * @param {string} pattern - Rename pattern (supports {name}, {width}, {height}, {dimensions}, {index}, {timestamp})\r\n     * @param {Object} additionalOptions - Additional options\r\n     * @returns {LemGendTask} This task instance for chaining\r\n     */\r\n    addRename = (pattern, additionalOptions = {}) => {\r\n        return this.addStep('rename', {\r\n            pattern,\r\n            ...additionalOptions\r\n        })\r\n    }\r\n\r\n    /**\r\n     * Add template step\r\n     * @param {string} templateId - Template ID\r\n     * @param {Object} additionalOptions - Additional options\r\n     * @returns {LemGendTask} This task instance for chaining\r\n     */\r\n    addTemplate = (templateId, additionalOptions = {}) => {\r\n        return this.addStep('template', {\r\n            templateId,\r\n            ...additionalOptions\r\n        })\r\n    }\r\n\r\n    /**\r\n     * Add favicon generation step\r\n     * @param {Array<number>} sizes - Array of sizes to generate\r\n     * @param {Array<string>} formats - Formats to generate ('png', 'ico', 'svg')\r\n     * @param {Object} additionalOptions - Additional options\r\n     * @returns {LemGendTask} This task instance for chaining\r\n     */\r\n    addFavicon = (sizes = [16, 32, 48, 64, 128, 180, 192, 256, 512], formats = ['png', 'ico'], additionalOptions = {}) => {\r\n        return this.addStep('favicon', {\r\n            sizes,\r\n            formats,\r\n            ...additionalOptions\r\n        })\r\n    }\r\n\r\n    /**\r\n     * Remove a step by ID or index\r\n     * @param {string|number} identifier - Step ID or index\r\n     * @returns {boolean} True if step was removed\r\n     */\r\n    removeStep = (identifier) => {\r\n        let index\r\n\r\n        if (typeof identifier === 'number') {\r\n            index = identifier\r\n        } else {\r\n            index = this.steps.findIndex(step => step.id === identifier)\r\n        }\r\n\r\n        if (index >= 0 && index < this.steps.length) {\r\n            this.steps.splice(index, 1)\r\n\r\n            this.steps.forEach((step, idx) => {\r\n                step.order = idx + 1\r\n            })\r\n\r\n            this.updatedAt = new Date().toISOString()\r\n            this._updateMetadata()\r\n            return true\r\n        }\r\n\r\n        return false\r\n    }\r\n\r\n    /**\r\n     * Move step up in order\r\n     * @param {number} index - Step index\r\n     * @returns {boolean} True if step was moved\r\n     */\r\n    moveStepUp = (index) => {\r\n        if (index <= 0 || index >= this.steps.length) {\r\n            return false\r\n        }\r\n\r\n        [this.steps[index - 1], this.steps[index]] = [this.steps[index], this.steps[index - 1]]\r\n\r\n        this.steps.forEach((step, idx) => {\r\n            step.order = idx + 1\r\n        })\r\n\r\n        this.updatedAt = new Date().toISOString()\r\n        return true\r\n    }\r\n\r\n    /**\r\n     * Move step down in order\r\n     * @param {number} index - Step index\r\n     * @returns {boolean} True if step was moved\r\n     */\r\n    moveStepDown = (index) => {\r\n        if (index < 0 || index >= this.steps.length - 1) {\r\n            return false\r\n        }\r\n\r\n        [this.steps[index], this.steps[index + 1]] = [this.steps[index + 1], this.steps[index]]\r\n\r\n        this.steps.forEach((step, idx) => {\r\n            step.order = idx + 1\r\n        })\r\n\r\n        this.updatedAt = new Date().toISOString()\r\n        return true\r\n    }\r\n\r\n    /**\r\n     * Enable/disable a step\r\n     * @param {number} index - Step index\r\n     * @param {boolean} enabled - Enable state\r\n     * @returns {boolean} True if step was updated\r\n     */\r\n    setStepEnabled = (index, enabled = true) => {\r\n        if (index >= 0 && index < this.steps.length) {\r\n            this.steps[index].enabled = enabled\r\n            this.updatedAt = new Date().toISOString()\r\n            this._updateMetadata()\r\n            return true\r\n        }\r\n        return false\r\n    }\r\n\r\n    /**\r\n     * Get enabled steps only\r\n     * @returns {Array} Enabled steps\r\n     */\r\n    getEnabledSteps = () => {\r\n        return this.steps.filter(step => step.enabled)\r\n    }\r\n\r\n    /**\r\n     * Get steps by processor type\r\n     * @param {string} processor - Processor type\r\n     * @returns {Array} Matching steps\r\n     */\r\n    getStepsByProcessor = (processor) => {\r\n        return this.steps.filter(step => step.processor === processor)\r\n    }\r\n\r\n    /**\r\n     * Check if task has specific processor\r\n     * @param {string} processor - Processor type\r\n     * @returns {boolean} True if processor exists\r\n     */\r\n    hasProcessor = (processor) => {\r\n        return this.getEnabledSteps().some(step => step.processor === processor)\r\n    }\r\n\r\n    /**\r\n     * Check if task has optimization step\r\n     * @returns {boolean} True if has optimization\r\n     */\r\n    hasOptimization = () => {\r\n        return this.hasProcessor('optimize')\r\n    }\r\n\r\n    /**\r\n     * Get optimization step if exists\r\n     * @returns {Object|null} Optimization step\r\n     */\r\n    getOptimizationStep = () => {\r\n        return this.getEnabledSteps().find(step => step.processor === 'optimize') || null\r\n    }\r\n\r\n    /**\r\n     * Validate task against an image\r\n     * @param {LemGendImage} lemGendImage - Image to validate against\r\n     * @returns {Promise<Object>} Validation result\r\n     */\r\n    validate = async (lemGendImage) => {\r\n        this.validationWarnings = []\r\n        this.validationErrors = []\r\n\r\n        if (!lemGendImage) {\r\n            const enabledSteps = this.getEnabledSteps()\r\n\r\n            if (enabledSteps.length === 0) {\r\n                this.validationWarnings.push({\r\n                    type: 'empty_task',\r\n                    message: 'Task has no enabled processing steps',\r\n                    severity: 'warning'\r\n                })\r\n            }\r\n\r\n            for (const step of enabledSteps) {\r\n                await this._validateStep(step, null)\r\n            }\r\n\r\n            this._validateTaskLogic()\r\n\r\n            return {\r\n                isValid: this.validationErrors.length === 0,\r\n                hasWarnings: this.validationWarnings.length > 0,\r\n                errors: [...this.validationErrors],\r\n                warnings: [...this.validationWarnings],\r\n                summary: this.getValidationSummary()\r\n            }\r\n        }\r\n\r\n        if (!lemGendImage.file || !(lemGendImage.file instanceof File)) {\r\n            this.validationErrors.push({\r\n                type: 'invalid_image',\r\n                message: 'Image missing valid file property',\r\n                severity: 'error'\r\n            })\r\n        }\r\n\r\n        const enabledSteps = this.getEnabledSteps()\r\n\r\n        if (enabledSteps.length === 0) {\r\n            this.validationWarnings.push({\r\n                type: 'empty_task',\r\n                message: 'Task has no enabled processing steps',\r\n                severity: 'warning'\r\n            })\r\n        }\r\n\r\n        for (const step of enabledSteps) {\r\n            await this._validateStep(step, lemGendImage)\r\n        }\r\n\r\n        this._validateTaskLogic()\r\n\r\n        if (lemGendImage.file && lemGendImage.file instanceof File) {\r\n            this._validateImageCompatibility(lemGendImage)\r\n        }\r\n\r\n        return {\r\n            isValid: this.validationErrors.length === 0,\r\n            hasWarnings: this.validationWarnings.length > 0,\r\n            errors: [...this.validationErrors],\r\n            warnings: [...this.validationWarnings],\r\n            summary: this.getValidationSummary()\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Validate individual step\r\n     * @private\r\n     */\r\n    _validateStep = async (step, image) => {\r\n        if (!image) {\r\n            switch (step.processor) {\r\n                case 'optimize':\r\n                    this._validateOptimizeStep(step, null)\r\n                    break\r\n                case 'rename':\r\n                    this._validateRenameStep(step)\r\n                    break\r\n                case 'template':\r\n                    this._validateTemplateStep(step)\r\n                    break\r\n                case 'favicon':\r\n                    this._validateFaviconStep(step, null)\r\n                    break\r\n                case 'resize':\r\n                case 'crop':\r\n                    this._validateBasicStepOptions(step)\r\n                    break\r\n            }\r\n            return\r\n        }\r\n\r\n        switch (step.processor) {\r\n            case 'resize':\r\n                this._validateResizeStep(step, image)\r\n                break\r\n            case 'crop':\r\n                this._validateCropStep(step, image)\r\n                break\r\n            case 'optimize':\r\n                this._validateOptimizeStep(step, image)\r\n                break\r\n            case 'rename':\r\n                this._validateRenameStep(step)\r\n                break\r\n            case 'template':\r\n                this._validateTemplateStep(step)\r\n                break\r\n            case 'favicon':\r\n                this._validateFaviconStep(step, image)\r\n                break\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Validate basic step options (without image)\r\n     * @private\r\n     */\r\n    _validateBasicStepOptions = (step) => {\r\n        switch (step.processor) {\r\n            case 'resize':\r\n                const { dimension } = step.options\r\n                if (dimension <= 0) {\r\n                    this.validationErrors.push({\r\n                        type: 'invalid_resize',\r\n                        step: step.order,\r\n                        message: `Resize dimension must be positive: ${dimension}`,\r\n                        severity: 'error'\r\n                    })\r\n                }\r\n                break\r\n\r\n            case 'crop':\r\n                const { width, height } = step.options\r\n                if (width <= 0 || height <= 0) {\r\n                    this.validationErrors.push({\r\n                        type: 'invalid_crop',\r\n                        step: step.order,\r\n                        message: `Crop dimensions must be positive: ${width}x${height}`,\r\n                        severity: 'error'\r\n                    })\r\n                }\r\n                break\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Validate favicon step\r\n     * @private\r\n     */\r\n    _validateFaviconStep = (step, image) => {\r\n        const { sizes, formats } = step.options\r\n\r\n        if (!Array.isArray(sizes) || sizes.length === 0) {\r\n            this.validationErrors.push({\r\n                type: 'invalid_favicon_sizes',\r\n                step: step.order,\r\n                message: 'Favicon sizes must be a non-empty array',\r\n                severity: 'error'\r\n            })\r\n        }\r\n\r\n        sizes.forEach(size => {\r\n            if (size < 16) {\r\n                this.validationWarnings.push({\r\n                    type: 'small_favicon_size',\r\n                    step: step.order,\r\n                    message: `Favicon size ${size}px is below recommended minimum (16px)`,\r\n                    severity: 'warning'\r\n                })\r\n            }\r\n\r\n            if (size > 1024) {\r\n                this.validationWarnings.push({\r\n                    type: 'large_favicon_size',\r\n                    step: step.order,\r\n                    message: `Favicon size ${size}px is unusually large`,\r\n                    severity: 'info'\r\n                })\r\n            }\r\n        })\r\n\r\n        if (image) {\r\n            const minSize = Math.min(...sizes)\r\n            if (image.width < minSize || image.height < minSize) {\r\n                this.validationWarnings.push({\r\n                    type: 'small_source_favicon',\r\n                    step: step.order,\r\n                    message: `Source image (${image.width}x${image.height}) smaller than smallest favicon size (${minSize}px)`,\r\n                    severity: 'warning',\r\n                    suggestion: 'Consider using a larger source image or enable upscaling'\r\n                })\r\n            }\r\n\r\n            if (Math.abs(image.width / image.height - 1) > 0.1) {\r\n                this.validationWarnings.push({\r\n                    type: 'non_square_favicon',\r\n                    step: step.order,\r\n                    message: 'Source image is not square; favicons may be distorted',\r\n                    severity: 'warning',\r\n                    suggestion: 'Consider adding a crop step before favicon generation'\r\n                })\r\n            }\r\n        }\r\n\r\n        const validFormats = ['png', 'ico', 'svg']\r\n        formats.forEach(format => {\r\n            if (!validFormats.includes(format)) {\r\n                this.validationWarnings.push({\r\n                    type: 'unsupported_favicon_format',\r\n                    step: step.order,\r\n                    message: `Unsupported favicon format: ${format}`,\r\n                    severity: 'warning',\r\n                    suggestion: `Use one of: ${validFormats.join(', ')}`\r\n                })\r\n            }\r\n        })\r\n    }\r\n\r\n    /**\r\n     * Validate resize step\r\n     * @private\r\n     */\r\n    _validateResizeStep = (step, image) => {\r\n        if (!image) return\r\n\r\n        const { dimension, mode, upscale } = step.options\r\n\r\n        if (dimension <= 0) {\r\n            this.validationErrors.push({\r\n                type: 'invalid_resize',\r\n                step: step.order,\r\n                message: `Resize dimension must be positive: ${dimension}`,\r\n                severity: 'error'\r\n            })\r\n        }\r\n\r\n        if (dimension < 10) {\r\n            this.validationWarnings.push({\r\n                type: 'very_small_resize',\r\n                step: step.order,\r\n                message: `Resize dimension very small (${dimension}px)`,\r\n                severity: 'warning',\r\n                suggestion: 'Consider larger dimensions for usable output'\r\n            })\r\n        }\r\n\r\n        if (dimension > 10000) {\r\n            this.validationWarnings.push({\r\n                type: 'very_large_resize',\r\n                step: step.order,\r\n                message: `Resize dimension very large (${dimension}px)`,\r\n                severity: 'warning',\r\n                suggestion: 'Large dimensions may cause performance issues'\r\n            })\r\n        }\r\n\r\n        if (dimension > Math.max(image.width, image.height) && !upscale) {\r\n            this.validationWarnings.push({\r\n                type: 'upscale_needed',\r\n                step: step.order,\r\n                message: `Target size (${dimension}px) larger than source, upscaling disabled`,\r\n                severity: 'warning',\r\n                suggestion: 'Enable upscaling or use smaller target dimension'\r\n            })\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Validate crop step\r\n     * @private\r\n     */\r\n    _validateCropStep = (step, image) => {\r\n        if (!image) return\r\n\r\n        const { width, height, mode, upscale, confidenceThreshold } = step.options\r\n\r\n        if (width <= 0 || height <= 0) {\r\n            this.validationErrors.push({\r\n                type: 'invalid_crop',\r\n                step: step.order,\r\n                message: `Crop dimensions must be positive: ${width}x${height}`,\r\n                severity: 'error'\r\n            })\r\n        }\r\n\r\n        if (['smart', 'face', 'object'].includes(mode)) {\r\n            this.validationWarnings.push({\r\n                type: 'ai_crop_mode',\r\n                step: step.order,\r\n                message: `Using AI-powered ${mode} cropping`,\r\n                severity: 'info',\r\n                suggestion: 'Ensure images have clear subjects for best results'\r\n            })\r\n\r\n            if (confidenceThreshold < 50) {\r\n                this.validationWarnings.push({\r\n                    type: 'low_confidence_threshold',\r\n                    step: step.order,\r\n                    message: `Low confidence threshold (${confidenceThreshold}%) may result in poor detection`,\r\n                    severity: 'warning',\r\n                    suggestion: 'Increase confidence threshold to 70% or higher for better accuracy'\r\n                })\r\n            }\r\n        }\r\n\r\n        if (width < 10 || height < 10) {\r\n            this.validationWarnings.push({\r\n                type: 'very_small_crop',\r\n                step: step.order,\r\n                message: `Crop dimensions very small (${width}x${height})`,\r\n                severity: 'warning',\r\n                suggestion: 'Consider larger crop area for usable output'\r\n            })\r\n        }\r\n\r\n        const aspect = width / height\r\n        if (aspect > 10 || aspect < 0.1) {\r\n            this.validationWarnings.push({\r\n                type: 'extreme_aspect',\r\n                step: step.order,\r\n                message: `Extreme aspect ratio: ${aspect.toFixed(2)}`,\r\n                severity: 'warning',\r\n                suggestion: 'Consider more balanced dimensions'\r\n            })\r\n        }\r\n\r\n        if ((width > image.width || height > image.height) && !upscale) {\r\n            this.validationWarnings.push({\r\n                type: 'crop_larger_than_source',\r\n                step: step.order,\r\n                message: `Crop area (${width}x${height}) larger than source (${image.width}x${image.height})`,\r\n                severity: 'warning',\r\n                suggestion: 'Enable upscaling or resize first'\r\n            })\r\n        }\r\n    }\r\n\r\n    /**\r\n    * Validate optimize step with enhanced validation\r\n    * @private\r\n    */\r\n    _validateOptimizeStep = (step, image) => {\r\n        // Use the imported validation function\r\n        const optimizationValidation = validateOptimizationOptions(step.options)\r\n\r\n        // Add validation errors\r\n        optimizationValidation.errors.forEach(error => {\r\n            this.validationErrors.push({\r\n                type: error.code,\r\n                step: step.order,\r\n                message: error.message,\r\n                severity: 'error',\r\n                suggestion: error.suggestion\r\n            })\r\n        })\r\n\r\n        // Add validation warnings\r\n        optimizationValidation.warnings.forEach(warning => {\r\n            this.validationWarnings.push({\r\n                type: warning.code,\r\n                step: step.order,\r\n                message: warning.message,\r\n                severity: 'warning',\r\n                suggestion: warning.suggestion\r\n            })\r\n        })\r\n\r\n        if (image) {\r\n            if ((step.options.format === 'jpg' || step.options.format === 'jpeg') && (image.transparency || step.options.preserveTransparency)) {\r\n                this.validationWarnings.push({\r\n                    type: ValidationWarnings.TRANSPARENCY_LOSS,\r\n                    step: step.order,\r\n                    message: 'JPEG format will remove transparency',\r\n                    severity: 'warning',\r\n                    suggestion: 'Use PNG or WebP to preserve transparency'\r\n                })\r\n            }\r\n\r\n            if (step.options.maxDisplayWidth && (image.width > step.options.maxDisplayWidth || image.height > step.options.maxDisplayWidth)) {\r\n                this.validationWarnings.push({\r\n                    type: 'resize_optimization',\r\n                    step: step.order,\r\n                    message: `Image will be resized to ${step.options.maxDisplayWidth}px maximum dimension`,\r\n                    severity: 'info'\r\n                })\r\n            }\r\n\r\n            if (step.options.format === 'avif') {\r\n                this.validationWarnings.push({\r\n                    type: ValidationWarnings.AVIF_BROWSER_SUPPORT,\r\n                    step: step.order,\r\n                    message: 'AVIF format provides excellent compression but limited browser support',\r\n                    severity: 'info',\r\n                    suggestion: 'Consider providing WebP fallback'\r\n                })\r\n            }\r\n\r\n            if (step.options.compressionMode === 'aggressive' && image.width * image.height > 4000000) {\r\n                this.validationWarnings.push({\r\n                    type: 'aggressive_compression_large',\r\n                    step: step.order,\r\n                    message: 'Aggressive compression on large images may take longer',\r\n                    severity: 'info'\r\n                })\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Validate rename step\r\n     * @private\r\n     */\r\n    _validateRenameStep = (step) => {\r\n        const { pattern, preserveExtension } = step.options\r\n\r\n        if (!pattern || pattern.trim() === '') {\r\n            this.validationErrors.push({\r\n                type: 'empty_pattern',\r\n                step: step.order,\r\n                message: 'Rename pattern cannot be empty',\r\n                severity: 'error'\r\n            })\r\n        }\r\n\r\n        const invalidChars = /[<>:\"/\\\\|?*\\x00-\\x1F]/\r\n        if (invalidChars.test(pattern)) {\r\n            this.validationErrors.push({\r\n                type: 'invalid_pattern_chars',\r\n                step: step.order,\r\n                message: 'Pattern contains invalid filename characters',\r\n                severity: 'error',\r\n                suggestion: 'Remove <>:\"/\\\\|?* and control characters from pattern'\r\n            })\r\n        }\r\n\r\n        if (!pattern.includes('{name}') && !pattern.includes('{index}')) {\r\n            this.validationWarnings.push({\r\n                type: 'no_unique_placeholder',\r\n                step: step.order,\r\n                message: 'Pattern may create duplicate filenames',\r\n                severity: 'warning',\r\n                suggestion: 'Include {index} or {timestamp} for unique filenames'\r\n            })\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Validate template step\r\n     * @private\r\n     */\r\n    _validateTemplateStep = (step) => {\r\n        const { templateId } = step.options\r\n\r\n        if (!templateId) {\r\n            this.validationErrors.push({\r\n                type: 'missing_template',\r\n                step: step.order,\r\n                message: 'Template ID is required',\r\n                severity: 'error'\r\n            })\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Validate image compatibility\r\n     * @private\r\n     */\r\n    _validateImageCompatibility = (image) => {\r\n        const enabledSteps = this.getEnabledSteps()\r\n        const hasFaviconStep = enabledSteps.some(s => s.processor === 'favicon')\r\n        const hasSmartCrop = enabledSteps.some(s => s.processor === 'crop' &&\r\n            ['smart', 'face', 'object'].includes(s.options.mode))\r\n        const hasOptimization = enabledSteps.some(s => s.processor === 'optimize')\r\n\r\n        if (hasFaviconStep) {\r\n            if (image.type === 'image/svg+xml') {\r\n                this.validationWarnings.push({\r\n                    type: 'svg_favicon',\r\n                    message: 'SVG images may not convert well to favicon formats',\r\n                    severity: 'warning',\r\n                    suggestion: 'Consider using raster image for favicon generation'\r\n                })\r\n            }\r\n\r\n            if (image.type.includes('gif')) {\r\n                this.validationWarnings.push({\r\n                    type: 'animated_favicon',\r\n                    message: 'Animated GIFs will lose animation in favicon conversion',\r\n                    severity: 'info'\r\n                })\r\n            }\r\n        }\r\n\r\n        if (hasSmartCrop) {\r\n            if (image.width < 200 || image.height < 200) {\r\n                this.validationWarnings.push({\r\n                    type: 'small_image_smart_crop',\r\n                    message: 'Smart crop works best with images larger than 200x200 pixels',\r\n                    severity: 'warning',\r\n                    suggestion: 'Consider resizing before smart crop or use larger source images'\r\n                })\r\n            }\r\n        }\r\n\r\n        if (hasOptimization) {\r\n            const optimizationStep = enabledSteps.find(s => s.processor === 'optimize')\r\n            if (optimizationStep && optimizationStep.options.format === 'auto') {\r\n                this.validationWarnings.push({\r\n                    type: 'auto_format_selection',\r\n                    message: 'Format will be automatically selected based on image content and browser support',\r\n                    severity: 'info'\r\n                })\r\n            }\r\n        }\r\n\r\n        const minDimension = Math.min(image.width, image.height)\r\n        if (minDimension < 100) {\r\n            this.validationWarnings.push({\r\n                type: 'low_resolution',\r\n                message: `Source image resolution low (${image.width}x${image.height})`,\r\n                severity: 'warning',\r\n                suggestion: 'Consider using higher resolution source for better quality'\r\n            })\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Validate task logic\r\n     * @private\r\n     */\r\n    _validateTaskLogic = () => {\r\n        const enabledSteps = this.getEnabledSteps()\r\n\r\n        const hasResize = enabledSteps.some(s => s.processor === 'resize')\r\n        const hasCrop = enabledSteps.some(s => s.processor === 'crop')\r\n        const hasOptimize = enabledSteps.some(s => s.processor === 'optimize')\r\n\r\n        if (hasCrop && !hasResize) {\r\n            this.validationWarnings.push({\r\n                type: 'crop_without_resize',\r\n                message: 'Crop without resize may result in unexpected output',\r\n                severity: 'info',\r\n                suggestion: 'Consider adding resize step before crop for better control'\r\n            })\r\n        }\r\n\r\n        const optimizeSteps = enabledSteps.filter(s => s.processor === 'optimize')\r\n        if (optimizeSteps.length > 1) {\r\n            this.validationWarnings.push({\r\n                type: 'multiple_optimize',\r\n                message: `Multiple optimization steps (${optimizeSteps.length})`,\r\n                severity: 'warning',\r\n                suggestion: 'Multiple optimizations may degrade quality unnecessarily'\r\n            })\r\n        }\r\n\r\n        const renameIndex = enabledSteps.findIndex(s => s.processor === 'rename')\r\n        if (renameIndex >= 0 && renameIndex < enabledSteps.length - 2) {\r\n            this.validationWarnings.push({\r\n                type: 'early_rename',\r\n                message: 'Rename step placed before other operations',\r\n                severity: 'info',\r\n                suggestion: 'Consider moving rename to end to reflect final output'\r\n            })\r\n        }\r\n\r\n        const faviconIndex = enabledSteps.findIndex(s => s.processor === 'favicon')\r\n        if (faviconIndex >= 0) {\r\n            const stepsBefore = enabledSteps.slice(0, faviconIndex)\r\n            const hasResizeBefore = stepsBefore.some(s => s.processor === 'resize')\r\n            const hasCropBefore = stepsBefore.some(s => s.processor === 'crop')\r\n\r\n            if (!hasResizeBefore && !hasCropBefore) {\r\n                this.validationWarnings.push({\r\n                    type: 'favicon_without_preparation',\r\n                    message: 'Favicon generation without prior resize/crop',\r\n                    severity: 'warning',\r\n                    suggestion: 'Add resize/crop step before favicon for optimal results'\r\n                })\r\n            }\r\n        }\r\n\r\n        const faviconSteps = enabledSteps.filter(s => s.processor === 'favicon')\r\n        faviconSteps.forEach(faviconStep => {\r\n            const optimizeAfter = enabledSteps\r\n                .filter(s => s.processor === 'optimize')\r\n                .some(optimizeStep => optimizeStep.order > faviconStep.order)\r\n\r\n            if (optimizeAfter) {\r\n                this.validationWarnings.push({\r\n                    type: 'optimize_after_favicon',\r\n                    message: 'Optimization after favicon generation may affect favicon quality',\r\n                    severity: 'warning',\r\n                    suggestion: 'Move optimization step before favicon generation'\r\n                })\r\n            }\r\n        })\r\n\r\n        // Validate optimization-first approach\r\n        if (hasOptimize && !hasResize && !hasCrop) {\r\n            this.validationWarnings.push({\r\n                type: 'optimization_only',\r\n                message: 'Task contains only optimization step',\r\n                severity: 'info',\r\n                suggestion: 'Consider adding resize/crop steps for complete image processing'\r\n            })\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Get validation summary\r\n     * @returns {Object} Validation summary\r\n     */\r\n    getValidationSummary = () => {\r\n        const enabledSteps = this.getEnabledSteps()\r\n        const errorCount = this.validationErrors.length\r\n        const warningCount = this.validationWarnings.length\r\n\r\n        const processorCount = {}\r\n        enabledSteps.forEach(step => {\r\n            processorCount[step.processor] = (processorCount[step.processor] || 0) + 1\r\n        })\r\n\r\n        let taskType = 'general'\r\n        if (enabledSteps.some(s => s.processor === 'favicon')) {\r\n            taskType = 'favicon'\r\n        } else if (enabledSteps.some(s => s.processor === 'template')) {\r\n            taskType = 'template'\r\n        } else if (enabledSteps.every(s => ['resize', 'crop', 'optimize'].includes(s.processor))) {\r\n            taskType = 'basic'\r\n        } else if (enabledSteps.length === 1 && enabledSteps[0].processor === 'optimize') {\r\n            taskType = 'optimization-only'\r\n        }\r\n\r\n        const hasSmartCrop = enabledSteps.some(s => s.processor === 'crop' &&\r\n            ['smart', 'face', 'object'].includes(s.options.mode))\r\n        const hasAutoOptimization = enabledSteps.some(s =>\r\n            s.processor === 'optimize' && s.options.format === 'auto'\r\n        )\r\n\r\n        return {\r\n            totalSteps: enabledSteps.length,\r\n            enabledSteps: enabledSteps.length,\r\n            disabledSteps: this.steps.length - enabledSteps.length,\r\n            errorCount,\r\n            warningCount,\r\n            processorCount,\r\n            taskType,\r\n            status: errorCount > 0 ? 'invalid' : warningCount > 0 ? 'has_warnings' : 'valid',\r\n            canProceed: errorCount === 0,\r\n            requiresImage: enabledSteps.some(s => ['resize', 'crop', 'optimize', 'favicon'].includes(s.processor)),\r\n            hasFavicon: processorCount.favicon > 0,\r\n            hasSmartCrop,\r\n            hasAutoOptimization,\r\n            estimatedOutputs: this._estimateOutputCount(),\r\n            optimizationLevel: this._getOptimizationLevel()\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Get optimization level based on settings\r\n     * @private\r\n     */\r\n    _getOptimizationLevel = () => {\r\n        const optimizeStep = this.getEnabledSteps().find(s => s.processor === 'optimize')\r\n        if (!optimizeStep) return 'none'\r\n\r\n        const { compressionMode, quality, format } = optimizeStep.options\r\n\r\n        if (compressionMode === 'aggressive' && quality < 70) {\r\n            return 'aggressive'\r\n        } else if (compressionMode === 'adaptive' || (quality >= 70 && quality <= 90)) {\r\n            return 'balanced'\r\n        } else if (compressionMode === 'balanced' && quality > 90) {\r\n            return 'high-quality'\r\n        }\r\n\r\n        return 'standard'\r\n    }\r\n\r\n    /**\r\n     * Estimate number of outputs\r\n     * @private\r\n     */\r\n    _estimateOutputCount = () => {\r\n        const enabledSteps = this.getEnabledSteps()\r\n        let count = 1\r\n\r\n        enabledSteps.forEach(step => {\r\n            if (step.processor === 'favicon') {\r\n                const { sizes = [], formats = [] } = step.options\r\n                count += sizes.length * formats.length\r\n\r\n                if (step.options.generateManifest) count++\r\n                if (step.options.generateHTML) count++\r\n                if (step.options.includeAppleTouch) count++\r\n                if (step.options.includeAndroid) count++\r\n            } else if (step.processor === 'optimize') {\r\n                const { format } = step.options\r\n                if (Array.isArray(format)) {\r\n                    count += format.length - 1\r\n                }\r\n            }\r\n        })\r\n\r\n        return count\r\n    }\r\n\r\n    /**\r\n     * Get task description\r\n     * @returns {string} Human-readable description\r\n     */\r\n    getDescription = () => {\r\n        const enabledSteps = this.getEnabledSteps()\r\n\r\n        if (enabledSteps.length === 0) {\r\n            return 'No processing steps configured'\r\n        }\r\n\r\n        return enabledSteps.map((step, index) => {\r\n            const stepNum = index + 1\r\n            const processor = step.processor.charAt(0).toUpperCase() + step.processor.slice(1)\r\n\r\n            switch (step.processor) {\r\n                case 'resize':\r\n                    return `${stepNum}. LemGendaryResize to ${step.options.dimension}px (${step.options.mode})`\r\n                case 'crop':\r\n                    const { mode, width, height } = step.options\r\n                    let cropDesc = `${stepNum}. LemGendaryCrop to ${width}${height}`\r\n\r\n                    if (['smart', 'face', 'object', 'saliency', 'entropy'].includes(mode)) {\r\n                        cropDesc += ` (AI ${mode} mode)`\r\n                    } else {\r\n                        cropDesc += ` (${mode})`\r\n                    }\r\n\r\n                    return cropDesc\r\n                case 'optimize':\r\n                    const formatStr = step.options.format === 'auto'\r\n                        ? 'auto (intelligent selection)'\r\n                        : step.options.format.toUpperCase()\r\n\r\n                    let optimizeDesc = `${stepNum}. LemGendaryOptimize to ${formatStr} (${step.options.quality}%)`\r\n\r\n                    if (step.options.maxDisplayWidth) {\r\n                        optimizeDesc += `, max ${step.options.maxDisplayWidth}px`\r\n                    }\r\n\r\n                    if (step.options.compressionMode && step.options.compressionMode !== 'adaptive') {\r\n                        optimizeDesc += `, ${step.options.compressionMode} compression`\r\n                    }\r\n\r\n                    if (step.options.browserSupport) {\r\n                        optimizeDesc += `, ${step.options.browserSupport.join('+')} browsers`\r\n                    }\r\n\r\n                    return optimizeDesc\r\n                case 'rename':\r\n                    return `${stepNum}. Rename with pattern: \"${step.options.pattern}\"`\r\n                case 'template':\r\n                    return `${stepNum}. Apply template: ${step.options.templateId}`\r\n                case 'favicon':\r\n                    const sizeCount = step.options.sizes?.length || 0\r\n                    const formatCount = step.options.formats?.length || 0\r\n                    return `${stepNum}. Generate favicon set (${sizeCount} sizes, ${formatCount} formats)`\r\n                default:\r\n                    return `${stepNum}. ${processor}`\r\n            }\r\n        }).join('\\n')\r\n    }\r\n\r\n    /**\r\n     * Get estimated processing time\r\n     * @param {number} imageCount - Number of images\r\n     * @returns {Object} Time estimates\r\n     */\r\n    getTimeEstimate = (imageCount = 1) => {\r\n        const enabledSteps = this.getEnabledSteps()\r\n\r\n        const stepTimes = {\r\n            'resize': 100,\r\n            'crop': 150,\r\n            'optimize': 200,\r\n            'rename': 10,\r\n            'template': 300,\r\n            'favicon': 500\r\n        }\r\n\r\n        let totalMs = 0\r\n        let complexityFactor = 1\r\n\r\n        enabledSteps.forEach(step => {\r\n            const baseTime = stepTimes[step.processor] || 100\r\n\r\n            if (step.processor === 'favicon') {\r\n                const sizeCount = step.options.sizes?.length || 1\r\n                const formatCount = step.options.formats?.length || 1\r\n                complexityFactor = sizeCount * formatCount\r\n            } else if (step.processor === 'crop' &&\r\n                ['smart', 'face', 'object'].includes(step.options.mode)) {\r\n                complexityFactor = 3 // AI processing takes longer\r\n            } else if (step.processor === 'optimize') {\r\n                if (step.options.compressionMode === 'aggressive') {\r\n                    complexityFactor = 1.5\r\n                }\r\n                if (step.options.analyzeContent) {\r\n                    complexityFactor *= 1.2\r\n                }\r\n            }\r\n\r\n            totalMs += baseTime * complexityFactor\r\n        })\r\n\r\n        totalMs *= imageCount\r\n\r\n        return {\r\n            perImage: totalMs / imageCount,\r\n            total: totalMs,\r\n            formatted: this._formatTime(totalMs),\r\n            stepCount: enabledSteps.length,\r\n            imageCount,\r\n            complexityFactor: Math.round(complexityFactor * 10) / 10\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Format time in milliseconds\r\n     * @private\r\n     */\r\n    _formatTime = (ms) => {\r\n        if (ms < 1000) return `${Math.round(ms)}ms`\r\n        if (ms < 60000) return `${(ms / 1000).toFixed(1)}s`\r\n        const minutes = Math.floor(ms / 60000)\r\n        const seconds = Math.round((ms % 60000) / 1000)\r\n        return `${minutes}m ${seconds}s`\r\n    }\r\n\r\n    /**\r\n     * Export task configuration\r\n     * @returns {Object} Task configuration\r\n     */\r\n    exportConfig = () => {\r\n        return {\r\n            id: this.id,\r\n            name: this.name,\r\n            description: this.description,\r\n            version: '2.2.0',\r\n            steps: this.steps.map(step => ({\r\n                id: step.id,\r\n                processor: step.processor,\r\n                options: { ...step.options },\r\n                enabled: step.enabled,\r\n                order: step.order,\r\n                metadata: step.metadata\r\n            })),\r\n            metadata: { ...this.metadata },\r\n            createdAt: this.createdAt,\r\n            updatedAt: this.updatedAt,\r\n            validation: {\r\n                warnings: this.validationWarnings,\r\n                errors: this.validationErrors\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Import task configuration\r\n     * @param {Object} config - Task configuration\r\n     * @returns {LemGendTask} New task instance\r\n     */\r\n    static importConfig(config) {\r\n        const task = new LemGendTask(config.name, config.description)\r\n        task.id = config.id || task.id\r\n        task.createdAt = config.createdAt || task.createdAt\r\n        task.updatedAt = config.updatedAt || task.updatedAt\r\n        task.metadata = config.metadata || task.metadata\r\n        task.validationWarnings = config.validation?.warnings || []\r\n        task.validationErrors = config.validation?.errors || []\r\n\r\n        config.steps?.forEach(stepConfig => {\r\n            task.addStep(stepConfig.processor, stepConfig.options)\r\n            const lastStep = task.steps[task.steps.length - 1]\r\n            lastStep.enabled = stepConfig.enabled !== false\r\n            lastStep.id = stepConfig.id || lastStep.id\r\n            lastStep.metadata = stepConfig.metadata || lastStep.metadata\r\n        })\r\n\r\n        return task\r\n    }\r\n\r\n    /**\r\n     * Create task from template\r\n     * @param {string} templateName - Template name\r\n     * @returns {LemGendTask} New task instance\r\n     */\r\n    static fromTemplate(templateName) {\r\n        const templates = {\r\n            'web-optimized': {\r\n                name: 'Web Optimization',\r\n                description: 'Optimize images for web with modern formats',\r\n                steps: [\r\n                    { processor: 'resize', options: { dimension: 1920, mode: 'longest' } },\r\n                    { processor: 'optimize', options: { quality: 85, format: 'auto', compressionMode: 'adaptive' } },\r\n                    { processor: 'rename', options: { pattern: '{name}-{width}w' } }\r\n                ]\r\n            },\r\n            'social-media': {\r\n                name: 'Social Media Posts',\r\n                description: 'Prepare images for social media platforms',\r\n                steps: [\r\n                    { processor: 'resize', options: { dimension: 1080, mode: 'longest' } },\r\n                    {\r\n                        processor: 'crop',\r\n                        options: {\r\n                            width: 1080,\r\n                            height: 1080,\r\n                            mode: 'smart',\r\n                            confidenceThreshold: 70,\r\n                            multipleFaces: true\r\n                        }\r\n                    },\r\n                    { processor: 'optimize', options: { quality: 90, format: 'auto', compressionMode: 'balanced' } }\r\n                ]\r\n            },\r\n            'portrait-smart': {\r\n                name: 'Smart Portrait Cropping',\r\n                description: 'AI-powered portrait cropping with face detection',\r\n                steps: [\r\n                    { processor: 'resize', options: { dimension: 1080, mode: 'longest' } },\r\n                    {\r\n                        processor: 'crop',\r\n                        options: {\r\n                            width: 1080,\r\n                            height: 1350,\r\n                            mode: 'face',\r\n                            confidenceThreshold: 80,\r\n                            preserveAspectRatio: true\r\n                        }\r\n                    },\r\n                    { processor: 'optimize', options: { quality: 95, format: 'auto', compressionMode: 'adaptive' } }\r\n                ]\r\n            },\r\n            'product-showcase': {\r\n                name: 'Product Showcase',\r\n                description: 'Smart cropping for product images',\r\n                steps: [\r\n                    { processor: 'resize', options: { dimension: 1200, mode: 'longest' } },\r\n                    {\r\n                        processor: 'crop',\r\n                        options: {\r\n                            width: 1200,\r\n                            height: 1200,\r\n                            mode: 'object',\r\n                            objectsToDetect: ['product', 'item'],\r\n                            confidenceThreshold: 75\r\n                        }\r\n                    },\r\n                    { processor: 'optimize', options: { quality: 90, format: 'auto', compressionMode: 'balanced' } }\r\n                ]\r\n            },\r\n            'favicon-package': {\r\n                name: 'Favicon Package',\r\n                description: 'Generate complete favicon set for all devices',\r\n                steps: [\r\n                    { processor: 'resize', options: { dimension: 512, mode: 'longest' } },\r\n                    {\r\n                        processor: 'crop',\r\n                        options: {\r\n                            width: 512,\r\n                            height: 512,\r\n                            mode: 'smart',\r\n                            confidenceThreshold: 70\r\n                        }\r\n                    },\r\n                    {\r\n                        processor: 'favicon', options: {\r\n                            sizes: [16, 32, 48, 64, 128, 180, 192, 256, 512],\r\n                            formats: ['png', 'ico'],\r\n                            generateManifest: true,\r\n                            generateHTML: true\r\n                        }\r\n                    },\r\n                    { processor: 'rename', options: { pattern: '{name}-favicon-{size}' } }\r\n                ]\r\n            },\r\n            'optimization-only': {\r\n                name: 'Optimization Only',\r\n                description: 'Optimize images without resizing or cropping',\r\n                steps: [\r\n                    {\r\n                        processor: 'optimize',\r\n                        options: {\r\n                            quality: 85,\r\n                            format: 'auto',\r\n                            maxDisplayWidth: 1920,\r\n                            compressionMode: 'adaptive',\r\n                            browserSupport: ['modern', 'legacy']\r\n                        }\r\n                    }\r\n                ]\r\n            }\r\n        }\r\n\r\n        const template = templates[templateName]\r\n        if (!template) {\r\n            throw new Error(`Unknown template: ${templateName}`)\r\n        }\r\n\r\n        return LemGendTask.importConfig(template)\r\n    }\r\n\r\n    /**\r\n     * Update metadata\r\n     * @private\r\n     */\r\n    _updateMetadata = () => {\r\n        const enabledSteps = this.getEnabledSteps()\r\n\r\n        this.metadata.estimatedDuration = this.getTimeEstimate().total\r\n        this.metadata.estimatedOutputs = this._estimateOutputCount()\r\n        this.metadata.stepCount = enabledSteps.length\r\n\r\n        const processorCount = {}\r\n        enabledSteps.forEach(step => {\r\n            processorCount[step.processor] = (processorCount[step.processor] || 0) + 1\r\n        })\r\n        this.metadata.processorCount = processorCount\r\n\r\n        if (processorCount.favicon > 0) {\r\n            this.metadata.category = 'favicon'\r\n        } else if (processorCount.template > 0) {\r\n            this.metadata.category = 'template'\r\n        } else if (processorCount.optimize > 0 && processorCount.resize === 0 && processorCount.crop === 0) {\r\n            this.metadata.category = 'optimization-only'\r\n        } else {\r\n            this.metadata.category = 'general'\r\n        }\r\n\r\n        this.metadata.hasSmartCrop = enabledSteps.some(s => s.processor === 'crop' &&\r\n            ['smart', 'face', 'object'].includes(s.options.mode))\r\n        this.metadata.hasAutoOptimization = enabledSteps.some(s =>\r\n            s.processor === 'optimize' && s.options.format === 'auto'\r\n        )\r\n    }\r\n\r\n    /**\r\n     * Clone the task\r\n     * @returns {LemGendTask} Cloned task\r\n     */\r\n    clone = () => {\r\n        return LemGendTask.importConfig(this.exportConfig())\r\n    }\r\n\r\n    /**\r\n     * Create a simplified version of the task for UI display\r\n     * @returns {Object} Simplified task info\r\n     */\r\n    toSimpleObject = () => {\r\n        const summary = this.getValidationSummary()\r\n\r\n        return {\r\n            id: this.id,\r\n            name: this.name,\r\n            description: this.description,\r\n            stepCount: this.steps.length,\r\n            enabledStepCount: this.getEnabledSteps().length,\r\n            hasFavicon: summary.hasFavicon,\r\n            hasSmartCrop: summary.hasSmartCrop,\r\n            hasAutoOptimization: summary.hasAutoOptimization,\r\n            taskType: summary.taskType,\r\n            status: summary.status,\r\n            canProceed: summary.canProceed,\r\n            estimatedOutputs: summary.estimatedOutputs,\r\n            optimizationLevel: summary.optimizationLevel,\r\n            createdAt: this.createdAt,\r\n            updatedAt: this.updatedAt\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Check if task is compatible with image type\r\n     * @param {string} mimeType - Image MIME type\r\n     * @returns {Object} Compatibility result\r\n     */\r\n    checkCompatibility = (mimeType) => {\r\n        const enabledSteps = this.getEnabledSteps()\r\n        const hasFavicon = enabledSteps.some(s => s.processor === 'favicon')\r\n        const hasSmartCrop = enabledSteps.some(s => s.processor === 'crop' &&\r\n            ['smart', 'face', 'object'].includes(s.options.mode))\r\n        const hasOptimization = enabledSteps.some(s => s.processor === 'optimize')\r\n\r\n        let compatible = true\r\n        const warnings = []\r\n        const errors = []\r\n\r\n        if (mimeType === 'image/svg+xml') {\r\n            if (hasFavicon) {\r\n                warnings.push('SVG to favicon conversion may not preserve all features')\r\n            }\r\n\r\n            if (hasSmartCrop) {\r\n                warnings.push('SVG images will be rasterized before smart cropping')\r\n            }\r\n        }\r\n\r\n        if (mimeType === 'image/gif') {\r\n            if (hasFavicon) {\r\n                warnings.push('Animated GIFs will lose animation in favicon conversion')\r\n            }\r\n\r\n            if (hasSmartCrop) {\r\n                warnings.push('Smart crop will use first frame of animated GIF')\r\n            }\r\n\r\n            if (hasOptimization) {\r\n                warnings.push('GIF optimization may reduce animation quality')\r\n            }\r\n        }\r\n\r\n        if (mimeType === 'image/x-icon' || mimeType === 'image/vnd.microsoft.icon') {\r\n            warnings.push('ICO files contain multiple images; processing may use first frame only')\r\n        }\r\n\r\n        return {\r\n            compatible,\r\n            warnings,\r\n            errors,\r\n            recommended: warnings.length === 0 && errors.length === 0\r\n        }\r\n    }\r\n}","/**\r\n * LemGendary Image Processor - Main Entry Point\r\n * @module image-lemgendizer\r\n */\r\n\r\n// Core classes\r\nimport { LemGendImage } from './LemGendImage.js'\r\nimport { LemGendTask } from './tasks/LemGendTask.js'\r\n\r\n// Processors\r\nimport { LemGendaryResize } from './processors/LemGendaryResize.js'\r\nimport { LemGendaryCrop } from './processors/LemGendaryCrop.js'\r\nimport { LemGendaryOptimize } from './processors/LemGendaryOptimize.js'\r\nimport { LemGendaryRename } from './processors/LemGendaryRename.js'\r\n\r\n// Templates - COMPLETE IMPORTS with flexible dimension support\r\nimport {\r\n    LemGendTemplates,\r\n    TEMPLATE_CATEGORIES,\r\n    PLATFORMS,\r\n    getTemplatesByPlatform,\r\n    getTemplatesByCategory,\r\n    getTemplateById,\r\n    getTemplatesByDimensions,\r\n    getRecommendedTemplates,\r\n    getTemplateStats,\r\n    exportTemplates,\r\n    validateTemplate,\r\n    addCustomTemplate,\r\n    getAllPlatforms,\r\n    getTemplatesGroupedByPlatform,\r\n    searchTemplates,\r\n    getTemplateAspectRatio,\r\n    getFlexibleTemplates,\r\n    getTemplatesForImage,\r\n    isVariableDimension,\r\n    parseDimension\r\n} from './templates/index.js'\r\n\r\n// Utilities\r\nimport {\r\n    createLemGendaryZip,\r\n    createSimpleZip,\r\n    extractZip,\r\n    getZipInfo,\r\n    createZipWithProgress\r\n} from './utils/zipUtils.js'\r\n\r\nimport {\r\n    getImageDimensions,\r\n    hasTransparency,\r\n    fileToDataURL,\r\n    dataURLtoFile,\r\n    resizeImage,\r\n    cropImage,\r\n    calculateAspectRatioFit,\r\n    formatFileSize,\r\n    getFileExtension,\r\n    validateImageFile,\r\n    createThumbnail,\r\n    batchProcess\r\n} from './utils/imageUtils.js'\r\n\r\n// Validation - COMPLETE IMPORTS with flexible dimension support\r\nimport {\r\n    ValidationErrors,\r\n    ValidationWarnings,\r\n    validateImage,\r\n    validateDimensions,\r\n    validateResize,\r\n    validateCrop,\r\n    validateOptimization,\r\n    validateRenamePattern,\r\n    getValidationSummary,\r\n    validateOptimizationOptions,\r\n    validateTemplateCompatibility,\r\n    isVariableDimension as validationIsVariableDimension,\r\n    parseDimension as validationParseDimension,\r\n    getFlexibleTemplates as validationGetFlexibleTemplates\r\n} from './utils/validation.js'\r\n\r\n// Re-export everything as named exports\r\nexport {\r\n    LemGendImage,\r\n    LemGendTask,\r\n    LemGendaryResize,\r\n    LemGendaryCrop,\r\n    LemGendaryOptimize,\r\n    LemGendaryRename\r\n}\r\n\r\nexport {\r\n    LemGendTemplates,\r\n    TEMPLATE_CATEGORIES,\r\n    PLATFORMS,\r\n    getTemplatesByPlatform,\r\n    getTemplatesByCategory,\r\n    getTemplateById,\r\n    getTemplatesByDimensions,\r\n    getRecommendedTemplates,\r\n    getTemplateStats,\r\n    exportTemplates,\r\n    validateTemplate,\r\n    addCustomTemplate,\r\n    getAllPlatforms,\r\n    getTemplatesGroupedByPlatform,\r\n    searchTemplates,\r\n    getTemplateAspectRatio,\r\n    getFlexibleTemplates,\r\n    getTemplatesForImage,\r\n    isVariableDimension,\r\n    parseDimension\r\n}\r\n\r\nexport {\r\n    createLemGendaryZip,\r\n    createSimpleZip,\r\n    extractZip,\r\n    getZipInfo,\r\n    createZipWithProgress\r\n}\r\n\r\nexport {\r\n    getImageDimensions,\r\n    hasTransparency,\r\n    fileToDataURL,\r\n    dataURLtoFile,\r\n    resizeImage,\r\n    cropImage,\r\n    calculateAspectRatioFit,\r\n    formatFileSize,\r\n    getFileExtension,\r\n    validateImageFile,\r\n    createThumbnail,\r\n    batchProcess\r\n}\r\n\r\nexport {\r\n    ValidationErrors,\r\n    ValidationWarnings,\r\n    validateImage,\r\n    validateDimensions,\r\n    validateResize,\r\n    validateCrop,\r\n    validateOptimization,\r\n    validateRenamePattern,\r\n    getValidationSummary,\r\n    validateOptimizationOptions,\r\n    validateTemplateCompatibility\r\n}\r\n\r\n/**\r\n * Actually resize an image using canvas\r\n * @private\r\n */\r\nasync function _actuallyResizeImage(file, targetWidth, targetHeight, algorithm = 'lanczos3') {\r\n    return new Promise((resolve, reject) => {\r\n        const img = new Image()\r\n        img.onload = () => {\r\n            try {\r\n                const canvas = document.createElement('canvas')\r\n                canvas.width = targetWidth\r\n                canvas.height = targetHeight\r\n\r\n                const ctx = canvas.getContext('2d')\r\n                if (!ctx) {\r\n                    reject(new Error('Canvas context not supported'))\r\n                    return\r\n                }\r\n\r\n                ctx.imageSmoothingEnabled = true\r\n                ctx.imageSmoothingQuality = 'high'\r\n\r\n                ctx.drawImage(img, 0, 0, targetWidth, targetHeight)\r\n\r\n                canvas.toBlob((blob) => {\r\n                    if (!blob) {\r\n                        reject(new Error('Failed to create blob from canvas'))\r\n                        return\r\n                    }\r\n\r\n                    const resizedFile = new File(\r\n                        [blob],\r\n                        file.name,\r\n                        { type: file.type }\r\n                    )\r\n\r\n                    URL.revokeObjectURL(img.src)\r\n                    resolve(resizedFile)\r\n                }, file.type, 0.95)\r\n            } catch (error) {\r\n                URL.revokeObjectURL(img.src)\r\n                reject(new Error(`Resize failed: ${error.message}`))\r\n            }\r\n        }\r\n        img.onerror = () => {\r\n            reject(new Error('Failed to load image for resizing'))\r\n        }\r\n        img.src = URL.createObjectURL(file)\r\n    })\r\n}\r\n\r\n/**\r\n * Actually crop an image using canvas\r\n * @private\r\n */\r\nasync function _actuallyCropImage(file, originalWidth, originalHeight, cropWidth, cropHeight, offsetX, offsetY) {\r\n    return new Promise((resolve, reject) => {\r\n        const img = new Image()\r\n        img.onload = () => {\r\n            try {\r\n                const canvas = document.createElement('canvas')\r\n                canvas.width = cropWidth\r\n                canvas.height = cropHeight\r\n\r\n                const ctx = canvas.getContext('2d')\r\n                if (!ctx) {\r\n                    reject(new Error('Canvas context not supported'))\r\n                    return\r\n                }\r\n\r\n                ctx.drawImage(\r\n                    img,\r\n                    offsetX, offsetY, cropWidth, cropHeight,\r\n                    0, 0, cropWidth, cropHeight\r\n                )\r\n\r\n                canvas.toBlob((blob) => {\r\n                    if (!blob) {\r\n                        reject(new Error('Failed to create blob from canvas'))\r\n                        return\r\n                    }\r\n\r\n                    const croppedFile = new File(\r\n                        [blob],\r\n                        file.name,\r\n                        { type: file.type }\r\n                    )\r\n\r\n                    URL.revokeObjectURL(img.src)\r\n                    resolve(croppedFile)\r\n                }, file.type, 0.95)\r\n            } catch (error) {\r\n                URL.revokeObjectURL(img.src)\r\n                reject(new Error(`Crop failed: ${error.message}`))\r\n            }\r\n        }\r\n        img.onerror = () => {\r\n            reject(new Error('Failed to load image for cropping'))\r\n        }\r\n        img.src = URL.createObjectURL(file)\r\n    })\r\n}\r\n\r\n/**\r\n * Apply optimization to file using the enhanced LemGendaryOptimize\r\n * @private\r\n */\r\nasync function applyOptimization(file, dimensions, options, hasTransparency) {\r\n    const { quality, format, lossless = false } = options\r\n\r\n    if (format === 'original') {\r\n        return file\r\n    }\r\n\r\n    return new Promise((resolve, reject) => {\r\n        const img = new Image()\r\n\r\n        img.onload = () => {\r\n            try {\r\n                const canvas = document.createElement('canvas')\r\n                canvas.width = dimensions.width\r\n                canvas.height = dimensions.height\r\n\r\n                const ctx = canvas.getContext('2d')\r\n                if (!ctx) {\r\n                    reject(new Error('Canvas context not supported'))\r\n                    return\r\n                }\r\n\r\n                ctx.drawImage(img, 0, 0, dimensions.width, dimensions.height)\r\n\r\n                let mimeType = 'image/jpeg'\r\n                let qualityValue = Math.max(0.1, Math.min(1, quality / 100))\r\n\r\n                switch (format.toLowerCase()) {\r\n                    case 'webp':\r\n                        mimeType = 'image/webp'\r\n                        break\r\n                    case 'png':\r\n                        mimeType = 'image/png'\r\n                        qualityValue = undefined\r\n                        break\r\n                    case 'avif':\r\n                        mimeType = 'image/avif'\r\n                        break\r\n                    case 'jpg':\r\n                    case 'jpeg':\r\n                    default:\r\n                        mimeType = 'image/jpeg'\r\n                }\r\n\r\n                if (hasTransparency && (format === 'jpg' || format === 'jpeg')) {\r\n                    const tempCanvas = document.createElement('canvas')\r\n                    tempCanvas.width = dimensions.width\r\n                    tempCanvas.height = dimensions.height\r\n                    const tempCtx = tempCanvas.getContext('2d')\r\n                    tempCtx.fillStyle = 'white'\r\n                    tempCtx.fillRect(0, 0, dimensions.width, dimensions.height)\r\n                    tempCtx.drawImage(img, 0, 0)\r\n\r\n                    tempCanvas.toBlob(\r\n                        (blob) => {\r\n                            if (!blob) {\r\n                                reject(new Error('Failed to create blob'))\r\n                                return\r\n                            }\r\n\r\n                            const optimizedFile = new File(\r\n                                [blob],\r\n                                `${file.name.replace(/\\.[^/.]+$/, '')}.${format.toLowerCase()}`,\r\n                                { type: mimeType }\r\n                            )\r\n                            URL.revokeObjectURL(img.src)\r\n                            resolve(optimizedFile)\r\n                        },\r\n                        mimeType,\r\n                        qualityValue\r\n                    )\r\n                } else {\r\n                    canvas.toBlob(\r\n                        (blob) => {\r\n                            if (!blob) {\r\n                                reject(new Error('Failed to create blob'))\r\n                                return\r\n                            }\r\n\r\n                            const optimizedFile = new File(\r\n                                [blob],\r\n                                `${file.name.replace(/\\.[^/.]+$/, '')}.${format.toLowerCase()}`,\r\n                                { type: mimeType }\r\n                            )\r\n                            URL.revokeObjectURL(img.src)\r\n                            resolve(optimizedFile)\r\n                        },\r\n                        mimeType,\r\n                        qualityValue\r\n                    )\r\n                }\r\n            } catch (error) {\r\n                URL.revokeObjectURL(img.src)\r\n                reject(new Error(`Optimization failed: ${error.message}`))\r\n            }\r\n        }\r\n\r\n        img.onerror = () => {\r\n            reject(new Error('Failed to load image for optimization'))\r\n        }\r\n\r\n        img.src = URL.createObjectURL(file)\r\n    })\r\n}\r\n\r\n/**\r\n * Helper function to get file extension\r\n * Renamed to avoid conflict with imported getFileExtension\r\n * @private\r\n */\r\nfunction _getFileExtension(file) {\r\n    return file.name.split('.').pop().toLowerCase()\r\n}\r\n\r\n/**\r\n * Process single file through task pipeline with optimization-first approach\r\n * @private\r\n */\r\nasync function processSingleFile(file, task, index) {\r\n    console.log('processSingleFile called with:', {\r\n        fileType: file?.constructor?.name,\r\n        isLemGendImage: file instanceof LemGendImage,\r\n        hasFileProperty: !!(file?.file),\r\n        filePropertyType: file?.file?.constructor?.name\r\n    })\r\n\r\n    let lemGendImage\r\n\r\n    try {\r\n        if (file instanceof LemGendImage) {\r\n            lemGendImage = file\r\n\r\n            console.log('Using existing LemGendImage:', {\r\n                hasFile: !!lemGendImage.file,\r\n                fileType: lemGendImage.file?.constructor?.name,\r\n                width: lemGendImage.width,\r\n                height: lemGendImage.height,\r\n                originalName: lemGendImage.originalName\r\n            })\r\n\r\n            if (!lemGendImage.file || !(lemGendImage.file instanceof File)) {\r\n                console.warn('LemGendImage missing valid file property')\r\n                throw new Error('LemGendImage has no valid file property')\r\n            }\r\n\r\n            if (!lemGendImage.width || !lemGendImage.height) {\r\n                try {\r\n                    console.log('LemGendImage missing dimensions, loading...')\r\n                    await lemGendImage.load()\r\n                } catch (loadError) {\r\n                    console.warn('Failed to load existing LemGendImage:', loadError)\r\n                    throw new Error(`Failed to load LemGendImage: ${loadError.message}`)\r\n                }\r\n            }\r\n\r\n        } else if (file && file.file && file.file instanceof File) {\r\n            console.log('Creating new LemGendImage from file object...')\r\n            lemGendImage = new LemGendImage(file.file)\r\n            await lemGendImage.load()\r\n\r\n        } else if (file instanceof File || file instanceof Blob) {\r\n            console.log('Creating new LemGendImage from File/Blob...')\r\n            lemGendImage = new LemGendImage(file)\r\n            await lemGendImage.load()\r\n\r\n        } else {\r\n            throw new Error(`Invalid file type provided for processing. Got: ${typeof file}, constructor: ${file?.constructor?.name}`)\r\n        }\r\n\r\n        if (!lemGendImage || !(lemGendImage instanceof LemGendImage)) {\r\n            throw new Error('Failed to create valid LemGendImage instance')\r\n        }\r\n\r\n        if (!lemGendImage.file || !(lemGendImage.file instanceof File)) {\r\n            throw new Error('LemGendImage missing file property')\r\n        }\r\n\r\n        if (!lemGendImage.width || !lemGendImage.height) {\r\n            throw new Error('LemGendImage missing dimensions')\r\n        }\r\n\r\n        console.log('Validating task with LemGendImage...', {\r\n            originalName: lemGendImage.originalName,\r\n            width: lemGendImage.width,\r\n            height: lemGendImage.height,\r\n            hasFile: !!lemGendImage.file,\r\n            fileType: lemGendImage.file?.constructor?.name\r\n        })\r\n\r\n        const validation = await task.validate(lemGendImage)\r\n\r\n        if (!validation.isValid) {\r\n            const errorMessage = validation.errors.map(e => e.message).join(', ')\r\n            console.error('Task validation failed:', errorMessage)\r\n            throw new Error(`Task validation failed: ${errorMessage}`)\r\n        }\r\n\r\n        console.log('Task validation passed successfully')\r\n\r\n        const enabledSteps = task.getEnabledSteps()\r\n        let currentFile = lemGendImage.file\r\n        let currentDimensions = {\r\n            width: lemGendImage.width,\r\n            height: lemGendImage.height\r\n        }\r\n\r\n        const processingOrder = ['resize', 'crop', 'optimize', 'rename']\r\n        const sortedSteps = enabledSteps.sort((a, b) => {\r\n            const indexA = processingOrder.indexOf(a.processor)\r\n            const indexB = processingOrder.indexOf(b.processor)\r\n            return indexA - indexB\r\n        })\r\n\r\n        console.log('Processing steps in order:', sortedSteps.map(s => `${s.order}.${s.processor}`))\r\n        console.log('Starting image dimensions:', currentDimensions)\r\n\r\n        for (const step of sortedSteps) {\r\n            try {\r\n                console.log(`\\n=== Processing step ${step.order}: ${step.processor} ===`)\r\n\r\n                switch (step.processor) {\r\n                    case 'resize':\r\n                        const resizeProcessor = new LemGendaryResize(step.options)\r\n                        const resizeResult = await resizeProcessor.process(lemGendImage)\r\n\r\n                        console.log('Resize result:', {\r\n                            original: `${resizeResult.originalDimensions.width}x${resizeResult.originalDimensions.height}`,\r\n                            target: `${resizeResult.newDimensions.width}x${resizeResult.newDimensions.height}`,\r\n                            mode: step.options.mode,\r\n                            dimension: step.options.dimension\r\n                        })\r\n\r\n                        currentFile = await _actuallyResizeImage(\r\n                            currentFile,\r\n                            resizeResult.newDimensions.width,\r\n                            resizeResult.newDimensions.height,\r\n                            step.options.algorithm || 'lanczos3'\r\n                        )\r\n\r\n                        currentDimensions = resizeResult.newDimensions\r\n                        lemGendImage.updateDimensions(currentDimensions.width, currentDimensions.height)\r\n                        lemGendImage.addOperation('resize', resizeResult)\r\n\r\n                        console.log(` Resized to: ${currentDimensions.width}x${currentDimensions.height}`)\r\n                        console.log('File after resize:', {\r\n                            name: currentFile.name,\r\n                            size: currentFile.size,\r\n                            type: currentFile.type\r\n                        })\r\n                        break\r\n\r\n                    case 'crop':\r\n                        const cropProcessor = new LemGendaryCrop(step.options)\r\n                        const cropResult = await cropProcessor.process(lemGendImage, currentDimensions)\r\n\r\n                        console.log('Crop result:', {\r\n                            current: `${currentDimensions.width}x${currentDimensions.height}`,\r\n                            target: `${cropResult.finalDimensions.width}x${cropResult.finalDimensions.height}`,\r\n                            mode: step.options.mode,\r\n                            smartCrop: cropResult.smartCrop\r\n                        })\r\n\r\n                        // Use either smart crop or regular crop\r\n                        if (cropResult.smartCrop) {\r\n                            console.log('Smart crop detected with steps:', {\r\n                                detection: cropResult.steps.detection.confidence,\r\n                                resize: cropResult.steps.resize,\r\n                                crop: cropResult.cropOffsets\r\n                            })\r\n                        }\r\n\r\n                        currentFile = await _actuallyCropImage(\r\n                            currentFile,\r\n                            currentDimensions.width,\r\n                            currentDimensions.height,\r\n                            cropResult.cropOffsets.width,\r\n                            cropResult.cropOffsets.height,\r\n                            cropResult.cropOffsets.x,\r\n                            cropResult.cropOffsets.y\r\n                        )\r\n\r\n                        currentDimensions = cropResult.finalDimensions\r\n                        lemGendImage.updateDimensions(currentDimensions.width, currentDimensions.height)\r\n                        lemGendImage.addOperation('crop', cropResult)\r\n\r\n                        console.log(` Cropped to: ${currentDimensions.width}x${currentDimensions.height}`)\r\n                        console.log('File after crop:', {\r\n                            name: currentFile.name,\r\n                            size: currentFile.size,\r\n                            type: currentFile.type\r\n                        })\r\n                        break\r\n\r\n                    case 'optimize':\r\n                        const optimizeProcessor = new LemGendaryOptimize(step.options)\r\n                        const optimizeResult = await optimizeProcessor.process(lemGendImage)\r\n\r\n                        console.log('Optimize result:', {\r\n                            format: step.options.format,\r\n                            quality: step.options.quality,\r\n                            originalFormat: optimizeResult.originalInfo.format,\r\n                            transparency: optimizeResult.originalInfo.transparency,\r\n                            savings: optimizeResult.savings\r\n                        })\r\n\r\n                        // Apply optimization using the enhanced processor\r\n                        currentFile = await optimizeProcessor.applyOptimization(lemGendImage)\r\n\r\n                        lemGendImage.addOperation('optimize', optimizeResult)\r\n                        console.log(` Optimized to: ${optimizeResult.optimization.selectedFormat} at ${optimizeResult.optimization.compression.quality}%`)\r\n                        console.log('File after optimize:', {\r\n                            name: currentFile.name,\r\n                            size: currentFile.size,\r\n                            type: currentFile.type,\r\n                            savings: `${optimizeResult.savings.savingsPercent}%`\r\n                        })\r\n                        break\r\n\r\n                    case 'rename':\r\n                        const renameProcessor = new LemGendaryRename(step.options)\r\n                        const renameResult = await renameProcessor.process(lemGendImage, index, task.steps.length)\r\n\r\n                        const extension = _getFileExtension(currentFile)\r\n\r\n                        const renamedFile = new File(\r\n                            [currentFile],\r\n                            `${renameResult.newName}.${extension}`,\r\n                            { type: currentFile.type }\r\n                        )\r\n\r\n                        currentFile = renamedFile\r\n                        lemGendImage.addOperation('rename', renameResult)\r\n                        console.log(` Renamed to: ${renameResult.newName}.${extension}`)\r\n                        break\r\n\r\n                    default:\r\n                        console.warn(`Unknown processor: ${step.processor}`)\r\n                }\r\n            } catch (error) {\r\n                console.error(`Error in step ${step.order} (${step.processor}):`, error)\r\n                throw new Error(`Step ${step.order} (${step.processor}) failed: ${error.message}`)\r\n            }\r\n        }\r\n\r\n        const outputFormat = _getFileExtension(currentFile)\r\n        lemGendImage.addOutput(\r\n            outputFormat,\r\n            currentFile,\r\n            null\r\n        )\r\n\r\n        console.log('\\n=== Processing Complete ===')\r\n        console.log('Final result:', {\r\n            originalName: lemGendImage.originalName,\r\n            finalName: currentFile.name,\r\n            originalSize: lemGendImage.originalSize,\r\n            finalSize: currentFile.size,\r\n            dimensions: `${currentDimensions.width}x${currentDimensions.height}`,\r\n            format: outputFormat,\r\n            sizeReduction: `${((lemGendImage.originalSize - currentFile.size) / lemGendImage.originalSize * 100).toFixed(1)}%`\r\n        })\r\n\r\n        return {\r\n            image: lemGendImage,\r\n            file: currentFile,\r\n            success: true,\r\n            metadata: lemGendImage.getInfo()\r\n        }\r\n\r\n    } catch (error) {\r\n        console.error('Error in processSingleFile:', error)\r\n        return {\r\n            image: lemGendImage || file,\r\n            file: lemGendImage?.file || file,\r\n            error: error.message,\r\n            success: false\r\n        }\r\n    }\r\n}\r\n\r\n/**\r\n * Main processing function\r\n * @param {Array<File|LemGendImage|Object>} files - Image files, LemGendImage instances, or objects with file/lemGendImage properties\r\n * @param {LemGendTask} task - Processing task\r\n * @param {Object} options - Processing options\r\n * @returns {Promise<Array>} Processed images\r\n */\r\nexport async function lemGendaryProcessBatch(files, task, options = {}) {\r\n    const {\r\n        onProgress = null,\r\n        onWarning = null,\r\n        onError = null,\r\n        parallel = false,\r\n        maxParallel = 4\r\n    } = options\r\n\r\n    const results = []\r\n    const totalFiles = files.length\r\n\r\n    console.log('=== lemGendaryProcessBatch START ===')\r\n    console.log('Batch processing:', {\r\n        totalFiles,\r\n        hasTask: !!task,\r\n        steps: task?.getEnabledSteps()?.length || 0,\r\n        options\r\n    })\r\n\r\n    console.log('Validating task...')\r\n    const taskValidation = files.length > 0 ? await task.validate(files[0]) : await task.validate()\r\n\r\n    if (!taskValidation.isValid) {\r\n        console.error('Task validation failed:', taskValidation.errors)\r\n\r\n        const hasOnlyImageError = taskValidation.errors.every(e =>\r\n            e.type === 'invalid_image' || e.message.includes('No image provided')\r\n        )\r\n\r\n        if (hasOnlyImageError && files.length > 0) {\r\n            console.warn('Task validation has image-related warnings but proceeding anyway...')\r\n        } else {\r\n            throw new Error(`Task validation failed: ${taskValidation.errors.map(e => e.message).join(', ')}`)\r\n        }\r\n    }\r\n\r\n    if (taskValidation.hasWarnings && onWarning) {\r\n        taskValidation.warnings.forEach(warning => onWarning(warning))\r\n    }\r\n\r\n    if (parallel) {\r\n        const batches = []\r\n        for (let i = 0; i < files.length; i += maxParallel) {\r\n            batches.push(files.slice(i, i + maxParallel))\r\n        }\r\n\r\n        for (let batchIndex = 0; batchIndex < batches.length; batchIndex++) {\r\n            const batch = batches[batchIndex]\r\n            const batchPromises = batch.map((file, fileIndex) =>\r\n                processSingleFile(file, task, batchIndex * maxParallel + fileIndex)\r\n            )\r\n\r\n            const batchResults = await Promise.allSettled(batchPromises)\r\n\r\n            batchResults.forEach((result, index) => {\r\n                if (result.status === 'fulfilled') {\r\n                    results.push(result.value)\r\n                } else {\r\n                    const errorResult = {\r\n                        file: batch[index],\r\n                        error: result.reason.message,\r\n                        success: false\r\n                    }\r\n                    results.push(errorResult)\r\n                    if (onError) onError(result.reason, batch[index])\r\n                }\r\n            })\r\n\r\n            if (onProgress) {\r\n                const progress = results.length / totalFiles\r\n                onProgress(progress, results.length, totalFiles)\r\n            }\r\n        }\r\n    } else {\r\n        for (let i = 0; i < files.length; i++) {\r\n            try {\r\n                console.log(`\\n=== Processing file ${i + 1}/${totalFiles} ===`)\r\n\r\n                const file = files[i]\r\n                console.log('File to process:', {\r\n                    type: file?.constructor?.name,\r\n                    isLemGendImage: file instanceof LemGendImage,\r\n                    name: file?.name || file?.originalName || file?.file?.name\r\n                })\r\n\r\n                const result = await processSingleFile(file, task, i)\r\n                results.push(result)\r\n\r\n                if (onProgress) {\r\n                    const progress = (i + 1) / totalFiles\r\n                    onProgress(progress, i + 1, totalFiles)\r\n                }\r\n            } catch (error) {\r\n                console.error(`Failed to process file ${i}:`, error)\r\n                const errorResult = {\r\n                    file: files[i],\r\n                    error: error.message,\r\n                    success: false\r\n                }\r\n                results.push(errorResult)\r\n                if (onError) onError(error, files[i])\r\n            }\r\n        }\r\n    }\r\n\r\n    console.log('\\n=== Processing complete ===')\r\n    console.log('Summary:', {\r\n        totalFiles,\r\n        successful: results.filter(r => r.success).length,\r\n        failed: results.filter(r => !r.success).length\r\n    })\r\n\r\n    results.forEach((result, index) => {\r\n        if (result.success) {\r\n            console.log(` File ${index + 1}: ${result.image?.originalName || 'Unknown'}`, {\r\n                success: true,\r\n                size: result.file?.size,\r\n                dimensions: result.image ? `${result.image.width}x${result.image.height}` : 'N/A'\r\n            })\r\n        } else {\r\n            console.log(` File ${index + 1}: Failed`, {\r\n                error: result.error,\r\n                fileName: result.file?.name || 'Unknown'\r\n            })\r\n        }\r\n    })\r\n\r\n    return results\r\n}\r\n\r\n/**\r\n * Optimize images for ZIP with advanced optimization\r\n * @param {Array<File|LemGendImage>} images - Images to optimize\r\n * @param {Object} optimizationOptions - Optimization options\r\n * @returns {Promise<Array>} Optimized images with results\r\n */\r\nexport async function optimizeForZip(images, optimizationOptions = {}) {\r\n    const optimizer = new LemGendaryOptimize(optimizationOptions)\r\n    const results = []\r\n\r\n    for (const image of images) {\r\n        try {\r\n            let lemGendImage\r\n\r\n            if (image instanceof LemGendImage) {\r\n                lemGendImage = image\r\n            } else {\r\n                lemGendImage = new LemGendImage(image)\r\n                await lemGendImage.load()\r\n            }\r\n\r\n            // Get optimization plan and apply it\r\n            const optimizationResult = await optimizer.process(lemGendImage)\r\n            const optimizedFile = await optimizer.applyOptimization(lemGendImage)\r\n\r\n            // Create optimized LemGendImage\r\n            const optimizedLemGendImage = new LemGendImage(optimizedFile)\r\n            await optimizedLemGendImage.load()\r\n\r\n            results.push({\r\n                original: lemGendImage,\r\n                optimized: optimizedLemGendImage,\r\n                result: optimizationResult,\r\n                success: true\r\n            })\r\n        } catch (error) {\r\n            console.error('Optimization failed:', error)\r\n            results.push({\r\n                original: image,\r\n                error: error.message,\r\n                success: false\r\n            })\r\n        }\r\n    }\r\n\r\n    return results\r\n}\r\n\r\n/**\r\n * Create optimized ZIP from images\r\n * @param {Array<File|LemGendImage>} images - Images to include in ZIP\r\n * @param {Object} options - Options including optimization settings\r\n * @returns {Promise<Blob>} ZIP file with optimized images\r\n */\r\nexport async function createOptimizedZip(images, options = {}) {\r\n    const {\r\n        optimization = {},\r\n        zipOptions = {},\r\n        includeReport = true\r\n    } = options\r\n\r\n    const optimizer = new LemGendaryOptimize(optimization)\r\n\r\n    // Convert to LemGendImage if needed\r\n    const lemGendImages = await Promise.all(\r\n        images.map(async (img) => {\r\n            if (img instanceof LemGendImage) {\r\n                return img\r\n            } else {\r\n                const lemGendImg = new LemGendImage(img)\r\n                await lemGendImg.load()\r\n                return lemGendImg\r\n            }\r\n        })\r\n    )\r\n\r\n    // Step 1: Optimize all images\r\n    console.log(`Optimizing ${lemGendImages.length} images...`)\r\n    const optimizationResults = await optimizer.prepareForZip(lemGendImages)\r\n\r\n    // Step 2: Filter successful optimizations\r\n    const successful = optimizationResults.filter(r => r.success)\r\n    const failed = optimizationResults.filter(r => !r.success)\r\n\r\n    console.log(`Optimization complete: ${successful.length} successful, ${failed.length} failed`)\r\n\r\n    if (successful.length === 0) {\r\n        throw new Error('No images could be optimized')\r\n    }\r\n\r\n    // Step 3: Create optimized images array for ZIP\r\n    const optimizedImages = successful.map(result => {\r\n        const optimizedImage = new LemGendImage(result.optimized)\r\n        optimizedImage.originalName = result.original.originalName\r\n        return optimizedImage\r\n    })\r\n\r\n    // Step 4: Add optimization report if requested\r\n    if (includeReport) {\r\n        const report = optimizer.generateOptimizationReport(optimizationResults)\r\n        const reportFile = new File(\r\n            [JSON.stringify(report, null, 2)],\r\n            'optimization-report.json',\r\n            { type: 'application/json' }\r\n        )\r\n        const reportImage = new LemGendImage(reportFile)\r\n        reportImage.originalName = 'optimization-report.json'\r\n        optimizedImages.push(reportImage)\r\n    }\r\n\r\n    // Step 5: Create ZIP\r\n    console.log('Creating ZIP from optimized images...')\r\n    const zipBlob = await createLemGendaryZip(optimizedImages, {\r\n        zipName: 'optimized-images.zip',\r\n        ...zipOptions\r\n    })\r\n\r\n    return zipBlob\r\n}\r\n\r\n/**\r\n * Create ZIP from processed images\r\n * @param {Array} processedResults - Results from lemGendaryProcessBatch\r\n * @param {Object} options - ZIP options\r\n * @returns {Promise<Blob>} ZIP file\r\n */\r\nexport async function lemGendBuildZip(processedResults, options = {}) {\r\n    const images = processedResults\r\n        .filter(result => result.success)\r\n        .map(result => result.image)\r\n\r\n    return createLemGendaryZip(images, options)\r\n}\r\n\r\n/**\r\n * Get library version and info\r\n * @returns {Object} Library information\r\n */\r\nexport function getLibraryInfo() {\r\n    return {\r\n        name: 'LemGendary Image Processor',\r\n        version: '2.2.0', // Updated to match LemGendTask version\r\n        description: 'Batch image processing with intelligent operations, AI-powered smart cropping, and advanced optimization',\r\n        author: 'LemGenda',\r\n        license: 'MIT',\r\n        homepage: 'https://github.com/lemgenda/image-lemgendizer-core',\r\n        processors: {\r\n            LemGendaryResize: {\r\n                name: 'LemGendaryResize',\r\n                description: 'Intelligent image resizing using longest dimension',\r\n                version: '1.2.1'\r\n            },\r\n            LemGendaryCrop: {\r\n                name: 'LemGendaryCrop',\r\n                description: 'AI-powered smart cropping with face and object detection',\r\n                version: '2.0.0'\r\n            },\r\n            LemGendaryOptimize: {\r\n                name: 'LemGendaryOptimize',\r\n                description: 'Advanced image optimization with intelligent format selection and adaptive compression',\r\n                version: '2.0.0'\r\n            },\r\n            LemGendaryRename: {\r\n                name: 'LemGendaryRename',\r\n                description: 'Batch renaming'\r\n            }\r\n        },\r\n        templates: {\r\n            total: LemGendTemplates?.ALL?.length || 0,\r\n            categories: TEMPLATE_CATEGORIES?.length || 0,\r\n            platforms: PLATFORMS ? Object.keys(PLATFORMS).length : 0\r\n        },\r\n        features: [\r\n            'Smart AI cropping',\r\n            'Face detection',\r\n            'Object detection',\r\n            'Content-aware resizing',\r\n            'Advanced optimization',\r\n            'Intelligent format selection',\r\n            'Adaptive compression',\r\n            'Batch processing',\r\n            'Favicon generation',\r\n            'Multiple format support',\r\n            'Optimization-first ZIP creation',\r\n            'Flexible dimension templates',\r\n            'Variable height/width support'\r\n        ]\r\n    }\r\n}\r\n\r\n// Add favicon-specific helper functions\r\nexport async function processFaviconSet(file, options = {}) {\r\n    const {\r\n        sizes = [16, 32, 48, 64, 128, 256],\r\n        formats = ['png', 'ico'],\r\n        includeManifest = true,\r\n        includeHTML = true\r\n    } = options\r\n\r\n    const results = []\r\n    const lemGendImage = new LemGendImage(file)\r\n    await lemGendImage.load()\r\n\r\n    for (const size of sizes) {\r\n        for (const format of formats) {\r\n            const processed = await generateFaviconVariant(lemGendImage, size, format)\r\n            results.push(processed)\r\n        }\r\n    }\r\n\r\n    if (includeManifest) {\r\n        results.push(generateManifest(lemGendImage, sizes))\r\n    }\r\n\r\n    if (includeHTML) {\r\n        results.push(generateFaviconHTML(lemGendImage, sizes, formats))\r\n    }\r\n\r\n    return results\r\n}\r\n\r\nasync function generateFaviconVariant(image, size, format) {\r\n    return {\r\n        size,\r\n        format,\r\n        width: size,\r\n        height: size,\r\n        name: `favicon-${size}x${size}.${format}`\r\n    }\r\n}\r\n\r\nfunction generateManifest(image, sizes) {\r\n    return {\r\n        type: 'json',\r\n        name: 'manifest.json',\r\n        content: JSON.stringify({\r\n            name: 'App Icon',\r\n            icons: sizes.map(size => ({\r\n                src: `/favicon-${size}x${size}.png`,\r\n                sizes: `${size}x${size}`,\r\n                type: 'image/png'\r\n            }))\r\n        }, null, 2)\r\n    }\r\n}\r\n\r\nfunction generateFaviconHTML(image, sizes, formats) {\r\n    const htmlLines = [\r\n        '<!-- Favicon tags for HTML -->',\r\n        '<link rel=\"icon\" href=\"/favicon.ico\" sizes=\"any\">'\r\n    ]\r\n\r\n    for (const size of sizes) {\r\n        for (const format of formats) {\r\n            if (format === 'png') {\r\n                htmlLines.push(`<link rel=\"icon\" type=\"image/png\" sizes=\"${size}x${size}\" href=\"/favicon-${size}x${size}.png\">`)\r\n            }\r\n        }\r\n    }\r\n\r\n    htmlLines.push('<link rel=\"apple-touch-icon\" href=\"/apple-touch-icon.png\">')\r\n    htmlLines.push('<link rel=\"manifest\" href=\"/manifest.json\">')\r\n\r\n    return {\r\n        type: 'html',\r\n        name: 'favicon-tags.html',\r\n        content: htmlLines.join('\\n')\r\n    }\r\n}\r\n\r\n/**\r\n * Process images using a template (connects task validation with template processing)\r\n * @param {LemGendImage} image - Image to process\r\n * @param {string} templateId - Template ID to apply\r\n * @param {Object} options - Template options\r\n * @returns {Promise<Object>} Template processing result\r\n */\r\nexport async function processWithTemplate(image, templateId, options = {}) {\r\n    try {\r\n        // Get template from templates system\r\n        const template = getTemplateById(templateId)\r\n        if (!template) {\r\n            throw new Error(`Template not found: ${templateId}`)\r\n        }\r\n\r\n        // Check template compatibility with image\r\n        const compatibility = validateTemplateCompatibility(template, {\r\n            width: image.width,\r\n            height: image.height\r\n        })\r\n\r\n        if (!compatibility.compatible) {\r\n            throw new Error(`Template incompatible: ${compatibility.errors.map(e => e.message).join(', ')}`)\r\n        }\r\n\r\n        // Create a task from template\r\n        const task = new LemGendTask(`Template: ${template.displayName}`, template.description)\r\n\r\n        // Parse template dimensions\r\n        const widthInfo = parseDimension(template.width)\r\n        const heightInfo = parseDimension(template.height)\r\n\r\n        // Add appropriate steps based on template\r\n        if (!widthInfo.isVariable && !heightInfo.isVariable) {\r\n            // Fixed dimensions template\r\n            const aspect = widthInfo.value / heightInfo.value\r\n            const imageAspect = image.width / image.height\r\n\r\n            if (Math.abs(aspect - imageAspect) > 0.1) {\r\n                // Aspect ratio mismatch - need to crop\r\n                task.addCrop(widthInfo.value, heightInfo.value, 'smart')\r\n            } else {\r\n                // Aspect ratio matches - just resize\r\n                task.addResize(Math.max(widthInfo.value, heightInfo.value), 'longest')\r\n            }\r\n        } else if (widthInfo.isVariable && !heightInfo.isVariable) {\r\n            // Flexible width, fixed height\r\n            task.addResize(heightInfo.value, 'height')\r\n        } else if (!widthInfo.isVariable && heightInfo.isVariable) {\r\n            // Fixed width, flexible height\r\n            task.addResize(widthInfo.value, 'width')\r\n        }\r\n\r\n        // Add optimization\r\n        task.addOptimize(85, 'auto', {\r\n            compressionMode: 'adaptive',\r\n            preserveTransparency: template.recommendedFormats.includes('png') || template.recommendedFormats.includes('svg')\r\n        })\r\n\r\n        // Process the image\r\n        const results = await lemGendaryProcessBatch([image], task)\r\n\r\n        if (results.length === 0 || !results[0].success) {\r\n            throw new Error('Template processing failed')\r\n        }\r\n\r\n        return {\r\n            success: true,\r\n            template,\r\n            image: results[0].image,\r\n            file: results[0].file,\r\n            compatibility,\r\n            warnings: compatibility.warnings\r\n        }\r\n    } catch (error) {\r\n        console.error('Template processing failed:', error)\r\n        return {\r\n            success: false,\r\n            error: error.message,\r\n            templateId\r\n        }\r\n    }\r\n}\r\n\r\n/**\r\n * Process flexible dimension template\r\n * @param {LemGendImage} image - Image to process\r\n * @param {Object} template - Template with flexible dimensions\r\n * @param {Object} options - Processing options\r\n * @returns {Promise<Object>} Processing result\r\n */\r\nexport async function processFlexibleTemplate(image, template, options = {}) {\r\n    const widthInfo = parseDimension(template.width)\r\n    const heightInfo = parseDimension(template.height)\r\n\r\n    const task = new LemGendTask(`Flexible: ${template.displayName}`, template.description)\r\n\r\n    if (widthInfo.isVariable && !heightInfo.isVariable) {\r\n        // Fixed height, flexible width - maintain aspect ratio\r\n        const scale = heightInfo.value / image.height\r\n        const targetWidth = Math.round(image.width * scale)\r\n        task.addResize(heightInfo.value, 'height')\r\n    } else if (!widthInfo.isVariable && heightInfo.isVariable) {\r\n        // Fixed width, flexible height - maintain aspect ratio\r\n        const scale = widthInfo.value / image.width\r\n        const targetHeight = Math.round(image.height * scale)\r\n        task.addResize(widthInfo.value, 'width')\r\n    } else if (widthInfo.isVariable && heightInfo.isVariable) {\r\n        // Both dimensions flexible - just optimize\r\n        task.addOptimize(85, 'auto')\r\n    }\r\n\r\n    const results = await lemGendaryProcessBatch([image], task)\r\n    return results[0] || { success: false, error: 'Processing failed' }\r\n}\r\n\r\n// Default export for convenience\r\nexport default {\r\n    // Core classes\r\n    LemGendImage,\r\n    LemGendTask,\r\n\r\n    // Processors\r\n    LemGendaryResize,\r\n    LemGendaryCrop,\r\n    LemGendaryOptimize,\r\n    LemGendaryRename,\r\n\r\n    // Main functions\r\n    lemGendaryProcessBatch,\r\n    lemGendBuildZip,\r\n    getLibraryInfo,\r\n    processFaviconSet,\r\n    optimizeForZip,\r\n    createOptimizedZip,\r\n    processWithTemplate,\r\n    processFlexibleTemplate,\r\n\r\n    // Templates\r\n    LemGendTemplates,\r\n    TEMPLATE_CATEGORIES,\r\n    PLATFORMS,\r\n    getTemplatesByPlatform,\r\n    getTemplatesByCategory,\r\n    getTemplateById,\r\n    getTemplatesByDimensions,\r\n    getRecommendedTemplates,\r\n    getTemplateStats,\r\n    exportTemplates,\r\n    validateTemplate,\r\n    addCustomTemplate,\r\n    getAllPlatforms,\r\n    getTemplatesGroupedByPlatform,\r\n    searchTemplates,\r\n    getTemplateAspectRatio,\r\n    getFlexibleTemplates,\r\n    getTemplatesForImage,\r\n    isVariableDimension,\r\n    parseDimension,\r\n\r\n    // Utilities\r\n    createLemGendaryZip,\r\n    createSimpleZip,\r\n    extractZip,\r\n    getZipInfo,\r\n    createZipWithProgress,\r\n\r\n    // Image utils\r\n    getImageDimensions,\r\n    hasTransparency,\r\n    fileToDataURL,\r\n    dataURLtoFile,\r\n    resizeImage,\r\n    cropImage,\r\n    calculateAspectRatioFit,\r\n    formatFileSize,\r\n    getFileExtension,\r\n    validateImageFile,\r\n    createThumbnail,\r\n    batchProcess,\r\n\r\n    // Validation\r\n    ValidationErrors,\r\n    ValidationWarnings,\r\n    validateImage,\r\n    validateDimensions,\r\n    validateResize,\r\n    validateCrop,\r\n    validateOptimization,\r\n    validateRenamePattern,\r\n    getValidationSummary,\r\n    validateOptimizationOptions,\r\n    validateTemplateCompatibility\r\n}"],"names":["LemGendImage","file","options","__publicField","error","analysis","score","megapixels","text","svgDoc","svgElement","widthAttr","heightAttr","viewBox","x","y","vbWidth","vbHeight","lengthStr","match","value","unit","svgText","indicator","resolve","reject","img","canvas","ctx","data","i","width","height","operation","details","format","template","output","reader","recommendations","newWidth","newHeight","mbSize","estimatedSize","areaReduction","savings","summary","info","threshold","useCase","presets","clone","maxSize","objectUrl","thumbnail","LemGendTask","name","description","processor","validProcessors","step","validatedOptions","a","b","size","validBrowserSupport","support","ph","dimension","mode","additionalOptions","quality","pattern","templateId","sizes","formats","identifier","index","idx","enabled","lemGendImage","enabledSteps","image","minSize","validFormats","upscale","confidenceThreshold","aspect","optimizationValidation","validateOptimizationOptions","warning","ValidationWarnings","preserveExtension","hasFaviconStep","s","hasSmartCrop","hasOptimization","optimizationStep","hasResize","hasCrop","hasOptimize","optimizeSteps","renameIndex","faviconIndex","stepsBefore","hasResizeBefore","hasCropBefore","faviconStep","optimizeStep","errorCount","warningCount","processorCount","taskType","hasAutoOptimization","compressionMode","count","stepNum","cropDesc","formatStr","optimizeDesc","sizeCount","formatCount","imageCount","stepTimes","totalMs","complexityFactor","baseTime","ms","minutes","seconds","mimeType","hasFavicon","compatible","warnings","errors","config","task","stepConfig","lastStep","templateName","_actuallyResizeImage","targetWidth","targetHeight","algorithm","blob","resizedFile","_actuallyCropImage","originalWidth","originalHeight","cropWidth","cropHeight","offsetX","offsetY","croppedFile","_getFileExtension","processSingleFile","loadError","validation","errorMessage","e","currentFile","currentDimensions","processingOrder","sortedSteps","indexA","indexB","resizeResult","LemGendaryResize","cropResult","LemGendaryCrop","optimizeProcessor","LemGendaryOptimize","optimizeResult","renameResult","LemGendaryRename","extension","outputFormat","lemGendaryProcessBatch","files","onProgress","onWarning","onError","parallel","maxParallel","results","totalFiles","taskValidation","batches","batchIndex","batch","batchPromises","fileIndex","result","errorResult","progress","r","optimizeForZip","images","optimizationOptions","optimizer","optimizationResult","optimizedFile","optimizedLemGendImage","createOptimizedZip","optimization","zipOptions","includeReport","lemGendImages","lemGendImg","optimizationResults","successful","failed","optimizedImages","optimizedImage","report","reportFile","reportImage","createLemGendaryZip","lemGendBuildZip","processedResults","getLibraryInfo","LemGendTemplates","TEMPLATE_CATEGORIES","PLATFORMS","processFaviconSet","includeManifest","includeHTML","processed","generateFaviconVariant","generateManifest","generateFaviconHTML","htmlLines","processWithTemplate","getTemplateById","compatibility","validateTemplateCompatibility","widthInfo","parseDimension","heightInfo","imageAspect","processFlexibleTemplate","scale","getTemplatesByPlatform","getTemplatesByCategory","getTemplatesByDimensions","getRecommendedTemplates","getTemplateStats","exportTemplates","validateTemplate","addCustomTemplate","getAllPlatforms","getTemplatesGroupedByPlatform","searchTemplates","getTemplateAspectRatio","getFlexibleTemplates","getTemplatesForImage","isVariableDimension","createSimpleZip","extractZip","getZipInfo","createZipWithProgress","getImageDimensions","hasTransparency","fileToDataURL","dataURLtoFile","resizeImage","cropImage","calculateAspectRatioFit","formatFileSize","getFileExtension","validateImageFile","createThumbnail","batchProcess","ValidationErrors","validateImage","validateDimensions","validateResize","validateCrop","validateOptimization","validateRenamePattern","getValidationSummary"],"mappings":"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"}